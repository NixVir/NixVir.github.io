name: Verify Netlify Deploy Health

on:
  schedule:
    # Run daily at 8 AM EST (1 PM UTC)
    - cron: '0 13 * * *'
  workflow_dispatch:  # Allow manual triggering

jobs:
  verify-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Check site is reachable
        run: |
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://nixvir.com/)
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "::error::Site returned HTTP $HTTP_STATUS"
            exit 1
          fi
          echo "Site is up (HTTP $HTTP_STATUS)"

      - name: Check data files are fresh
        run: |
          ERRORS=""

          # Check snow-cover.json exists and is recent
          SNOW_DATE=$(curl -sf https://nixvir.com/data/snow-cover.json | python3 -c "
          import json, sys
          try:
              d = json.load(sys.stdin)
              print(d.get('updated', d.get('timestamp', 'unknown')))
          except:
              print('error')
          ")
          echo "Snow cover last updated: $SNOW_DATE"
          if [ "$SNOW_DATE" = "error" ]; then
            ERRORS="$ERRORS\n- snow-cover.json is missing or invalid"
          fi

          # Check dashboard data exists
          DASH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://nixvir.com/data/dashboard.json)
          echo "Dashboard data: HTTP $DASH_STATUS"
          if [ "$DASH_STATUS" != "200" ]; then
            ERRORS="$ERRORS\n- dashboard.json returned HTTP $DASH_STATUS"
          fi

          # Check ski news data exists
          NEWS_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://nixvir.com/data/ski-news.json)
          echo "Ski news data: HTTP $NEWS_STATUS"
          if [ "$NEWS_STATUS" != "200" ]; then
            ERRORS="$ERRORS\n- ski-news.json returned HTTP $NEWS_STATUS"
          fi

          # Check SNOTEL data exists
          SNOTEL_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://nixvir.com/data/snotel-snowpack.json)
          echo "SNOTEL data: HTTP $SNOTEL_STATUS"
          if [ "$SNOTEL_STATUS" != "200" ]; then
            ERRORS="$ERRORS\n- snotel-snowpack.json returned HTTP $SNOTEL_STATUS"
          fi

          # Check site-nav.js loads (nav single source of truth)
          NAV_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://nixvir.com/js/site-nav.js)
          echo "Nav JS: HTTP $NAV_STATUS"
          if [ "$NAV_STATUS" != "200" ]; then
            ERRORS="$ERRORS\n- site-nav.js returned HTTP $NAV_STATUS (navigation will be broken)"
          fi

          if [ -n "$ERRORS" ]; then
            echo "::error::Deploy health check failures:$ERRORS"
            exit 1
          fi

          echo "All data files verified"

      - name: Verify latest commit is deployed
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the latest commit SHA from the repo
          LATEST_SHA=$(gh api repos/NixVir/NixVir.github.io/commits/master --jq '.sha' | head -c 7)
          echo "Latest commit: $LATEST_SHA"

          # Check if the site's HTML contains evidence of recent build
          # Netlify adds deploy info we can check
          DEPLOY_CHECK=$(curl -sI https://nixvir.com/ | grep -i "x-nf-request-id" | head -1)
          if [ -z "$DEPLOY_CHECK" ]; then
            echo "::warning::Could not verify Netlify deploy headers - site may not be on Netlify"
          else
            echo "Netlify deploy verified: $DEPLOY_CHECK"
          fi

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Deploy Health Check Failed (${new Date().toISOString().split('T')[0]})`;
            const body = `**Deploy verification failed.**\n\nThe site or its data files may be unreachable or stale.\n\n**Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\n**Possible causes:**\n- Netlify deploy failed or is stuck\n- Netlify integration disconnected from GitHub\n- Data pipeline produced invalid output\n\n**Action needed:**\n1. Check [Netlify deploys](https://app.netlify.com) for the nixvir site\n2. Verify the GitHub â†’ Netlify integration is connected\n3. Re-run failed data workflows if needed`;
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['deploy-health']
            });
