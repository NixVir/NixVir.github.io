<nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l center items-center justify-between">
    <div class="flex items-center" style="gap: 16px;">
      <!-- Snow Cover Widget with Bar Charts -->
      <a href="/snow-cover/" class="snow-cover-widget" id="header-snow-widget" title="North American Snow Cover">
        <div class="snow-widget-header">
          <div class="snow-widget-title-container">
            <span class="snow-trend-dot" id="snow-trend-dot"></span>
            <span class="snow-widget-title">Percent Snow Cover</span>
          </div>
          <div class="snow-widget-subheader">
            <span class="snow-widget-date" id="snow-widget-date">As of: --</span>
            <div class="snow-widget-legend">
              <span class="snow-legend-line"></span>
              <span class="snow-legend-text">Prior Year</span>
            </div>
          </div>
        </div>
        <div class="snow-bars-container">
          <!-- N. America Bar -->
          <div class="snow-bar-chart">
            <span class="snow-bar-label">N. America</span>
            <div class="snow-bar-wrapper">
              <div class="snow-bar-fill" id="snow-bar-na"></div>
              <div class="snow-bar-prior" id="snow-prior-na"></div>
            </div>
            <span class="snow-bar-value" id="snow-value-na">--%</span>
          </div>
          <!-- US Bar -->
          <div class="snow-bar-chart">
            <span class="snow-bar-label">US</span>
            <div class="snow-bar-wrapper">
              <div class="snow-bar-fill" id="snow-bar-usa"></div>
              <div class="snow-bar-prior" id="snow-prior-usa"></div>
            </div>
            <span class="snow-bar-value" id="snow-value-usa">--%</span>
          </div>
          <!-- Canada Bar -->
          <div class="snow-bar-chart">
            <span class="snow-bar-label">Can</span>
            <div class="snow-bar-wrapper">
              <div class="snow-bar-fill" id="snow-bar-canada"></div>
              <div class="snow-bar-prior" id="snow-prior-canada"></div>
            </div>
            <span class="snow-bar-value" id="snow-value-canada">--%</span>
          </div>
        </div>
        <div class="snow-widget-footer">
          <span class="snow-metro-link">CLICK HERE FOR METRO AREAS</span>
        </div>
      </a>
      {{/* Hide site title/logo on homepage since it's shown large in the hero, but keep space for layout */}}
      {{ if .IsHome }}
        <div class="f3 fw2 dib">&nbsp;</div>
      {{ else }}
        <a href="{{ .Site.Home.RelPermalink }}" class="f3 fw2 hover-white white-90 dib no-underline">
          {{ with .Site.Params.site_logo }}
            <img src="{{ urls.RelURL . }}" class="w100 mw5-ns" alt="{{ $.Site.Title }}" />
          {{ else }}
            {{ .Site.Title }}
          {{ end }}
        </a>
      {{ end }}
    </div>
    <div class="flex-l items-center">
      {{ partials.Include "i18nlist.html" . }}
      {{ if .Site.Menus.main }}
        <ul class="{{ compare.Conditional (compare.Eq $.Site.Language.LanguageDirection "rtl") "pr0 ml3" "pl0 mr3" }}">
          {{ range .Site.Menus.main }}
          <li class="list f5 f4-ns fw4 dib {{ compare.Conditional (compare.Eq $.Site.Language.LanguageDirection "rtl") "pl3" "pr3" }}">
            <a class="hover-white white-90 no-underline" href="{{ .URL }}" title="{{ lang.Translate "pageTitle" . }}">
              {{ .Name }}
            </a>
          </li>
          {{ end }}
        </ul>
      {{ end }}
      {{ partials.IncludeCached "social/follow.html" . }}
    </div>
  </div>
</nav>

<!-- Snow Cover Widget Data Loader -->
<script>
(function() {
  // Calculate prior year average from history
  function getPriorYearAvg(priorHistory) {
    if (!priorHistory || priorHistory.length === 0) return null;
    var values = priorHistory.map(function(h) {
      return typeof h === 'object' ? h.value : h;
    }).filter(function(v) { return v !== null && v !== undefined; });
    if (values.length === 0) return null;
    return values.reduce(function(a, b) { return a + b; }, 0) / values.length;
  }

  // Calculate 7-day trend from history
  function get7DayTrend(history) {
    if (!history || history.length < 7) return 'stable';
    var values = history.slice(-7).map(function(h) {
      return typeof h === 'object' ? h.value : h;
    }).filter(function(v) { return v !== null && v !== undefined; });
    if (values.length < 2) return 'stable';
    var first = values[0];
    var last = values[values.length - 1];
    var change = last - first;
    if (change > 2) return 'up';
    if (change < -2) return 'down';
    return 'stable';
  }

  // Update a single bar chart
  function updateBar(barId, priorId, valueId, current, priorAvg) {
    var barEl = document.getElementById(barId);
    var priorEl = document.getElementById(priorId);
    var valueEl = document.getElementById(valueId);

    if (barEl) {
      // Set bar height as percentage (max 100%)
      var heightPercent = Math.min(current, 100);
      setTimeout(function() {
        barEl.style.height = heightPercent + '%';
      }, 100);
    }

    if (priorEl && priorAvg !== null) {
      // Position prior year line (55px is bar height)
      var priorPercent = Math.min(priorAvg, 100);
      setTimeout(function() {
        priorEl.style.bottom = (priorPercent * 0.55) + 'px';
      }, 100);
    }

    if (valueEl) {
      valueEl.textContent = Math.round(current) + '%';
      // Color based on comparison to prior year
      valueEl.classList.remove('snow-value-up', 'snow-value-down', 'snow-value-equal');
      if (priorAvg !== null) {
        if (current > priorAvg + 1) {
          valueEl.classList.add('snow-value-up');
        } else if (current < priorAvg - 1) {
          valueEl.classList.add('snow-value-down');
        } else {
          valueEl.classList.add('snow-value-equal');
        }
      } else {
        valueEl.classList.add('snow-value-equal');
      }
    }
  }

  // Update trend indicator dot
  function updateTrendDot(trend) {
    var dotEl = document.getElementById('snow-trend-dot');
    if (dotEl) {
      dotEl.classList.remove('trend-up', 'trend-down', 'trend-stable');
      dotEl.classList.add('trend-' + trend);
    }
  }

  function loadSnowWidgetData() {
    fetch('/data/snow-cover.json')
      .then(function(response) {
        if (!response.ok) throw new Error('Snow data unavailable');
        return response.json();
      })
      .then(function(data) {
        // Update date
        var dateEl = document.getElementById('snow-widget-date');
        if (dateEl && data.updated) {
          // Extract just the date part (YYYY-MM-DD)
          var datePart = data.updated.split(' ')[0];
          dateEl.textContent = 'As of: ' + datePart;
        }

        // Calculate prior year averages
        var usaPriorAvg = getPriorYearAvg(data.usa.priorYearHistory);
        var canadaPriorAvg = getPriorYearAvg(data.canada.priorYearHistory);

        // Calculate combined prior year average (weighted by land area)
        var naPriorAvg = null;
        if (usaPriorAvg !== null && canadaPriorAvg !== null) {
          // Weight by approximate land areas: USA ~3.8M sq mi, Canada ~3.9M sq mi
          naPriorAvg = (usaPriorAvg * 0.49 + canadaPriorAvg * 0.51);
        }

        // Calculate N. America combined history for trend
        var naHistory = [];
        if (data.usa.history && data.canada.history) {
          var len = Math.min(data.usa.history.length, data.canada.history.length);
          for (var i = 0; i < len; i++) {
            var usaVal = typeof data.usa.history[i] === 'object' ? data.usa.history[i].value : data.usa.history[i];
            var canVal = typeof data.canada.history[i] === 'object' ? data.canada.history[i].value : data.canada.history[i];
            naHistory.push({ value: usaVal * 0.49 + canVal * 0.51 });
          }
        }

        // Update 7-day trend indicator
        var naTrend = get7DayTrend(naHistory);
        updateTrendDot(naTrend);

        // Update bars
        updateBar('snow-bar-usa', 'snow-prior-usa', 'snow-value-usa',
                  data.usa.cover, usaPriorAvg);
        updateBar('snow-bar-canada', 'snow-prior-canada', 'snow-value-canada',
                  data.canada.cover, canadaPriorAvg);
        updateBar('snow-bar-na', 'snow-prior-na', 'snow-value-na',
                  data.combined.cover, naPriorAvg);
      })
      .catch(function(err) {
        console.log('Snow widget: ' + err.message);
      });
  }

  // Load on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadSnowWidgetData);
  } else {
    loadSnowWidgetData();
  }

  // Refresh every 5 minutes
  setInterval(loadSnowWidgetData, 300000);
})();
</script>
