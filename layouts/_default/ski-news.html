{{ define "main" }}
<article class="pa3 pa4-ns">
  <div class="mw8 center">
    <h1 class="f2 fw6 mb2">{{ .Title }}</h1>
    <div class="f5 gray mb4">{{ .Content }}</div>
    <p class="f6 gray mb4">Last updated: <span id="ski-news-update">Loading...</span></p>

    <div id="ski-news-container">
      <p class="gray">Loading ski business news...</p>
    </div>

    <div id="ski-news-empty" class="dn tc pa4 gray">
      <p>No ski business news available yet. Check back soon!</p>
    </div>
  </div>
</article>

<style>
  .ski-news-card {
    padding: 1.25rem;
    margin-bottom: 1.25rem;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    background: #fafafa;
    transition: box-shadow 0.2s ease;
  }
  .ski-news-card:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  .ski-news-card h3 {
    margin: 0 0 0.5rem 0;
    font-size: 1.1rem;
    line-height: 1.4;
  }
  .ski-news-card h3 a {
    color: #333;
    text-decoration: none;
  }
  .ski-news-card h3 a:hover {
    color: #0066cc;
  }
  .ski-news-meta {
    font-size: 0.8rem;
    color: #666;
    margin-bottom: 0.5rem;
  }
  .ski-news-desc {
    font-size: 0.9rem;
    color: #444;
    line-height: 1.5;
  }
</style>

<script>
async function loadSkiNews() {
  const container = document.getElementById('ski-news-container');
  const emptyState = document.getElementById('ski-news-empty');
  const updateSpan = document.getElementById('ski-news-update');

  try {
    const response = await fetch('/data/ski-news.json');
    const data = await response.json();

    if (updateSpan) {
      updateSpan.textContent = new Date(data.updated).toLocaleDateString('en-US', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
      });
    }

    if (!data.articles || data.articles.length === 0) {
      container.classList.add('dn');
      emptyState.classList.remove('dn');
      return;
    }

    // Sort articles by date (most recent first), then by score (highest first) within each date
    const sortedArticles = data.articles.sort((a, b) => {
      const dateA = a.pub_date ? new Date(a.pub_date).toDateString() : '';
      const dateB = b.pub_date ? new Date(b.pub_date).toDateString() : '';
      if (dateA !== dateB) {
        return new Date(b.pub_date || 0) - new Date(a.pub_date || 0);
      }
      return (b.score || 0) - (a.score || 0);
    });

    let html = '';
    sortedArticles.forEach(article => {
      const pubDate = article.pub_date ?
        new Date(article.pub_date).toLocaleDateString('en-US', {
          month: 'short', day: 'numeric', year: 'numeric'
        }) : '';

      const desc = article.description ?
        article.description.substring(0, 300) + (article.description.length > 300 ? '...' : '') : '';

      html += `
        <div class="ski-news-card">
          <h3>
            <a href="${article.url}" target="_blank" rel="noopener">${article.title || 'Untitled'}</a>
          </h3>
          <div class="ski-news-meta">${article.source || ''} ${pubDate ? '&bull; ' + pubDate : ''}</div>
          ${desc ? `<div class="ski-news-desc">${desc}</div>` : ''}
        </div>
      `;
    });

    container.innerHTML = html;

  } catch (error) {
    console.error('Failed to load ski news:', error);
    container.innerHTML = '<p class="gray">Unable to load ski business news.</p>';
  }
}

loadSkiNews();
</script>
{{ end }}
