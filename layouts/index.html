{{ define "main" }}
  <article class="cf ph3 ph5-l pv3 pv4-l f4 tc-l center measure-wide lh-copy nested-links {{ $.Param "text_color" | compare.Default "mid-gray" }}">
    {{ .Content }}
  </article>

  {{/* Two-column layout: News and Indicators Dashboard */}}
  {{ $mainSections := site.Params.mainSections | compare.Default (collections.Slice "post") }}
  {{ $show_recent_posts := site.Params.ananke.show_recent_posts }}
  {{ $section := collections.Where $.Site.RegularPages "Section" "in" $mainSections }}
  {{ $section_count := len $section }}

  {{ if and ($show_recent_posts) (compare.Ge $section_count 1) }}
    <div class="pa3 pa4-ns w-100 center" style="max-width: 1400px;">

      {{/* Two column container */}}
      <div class="flex-l">

        {{/* Left Column: Data Insights Section */}}
        <section class="w-100 w-60-l pr4-l mb4 mb0-l">
          <h2 class="f3 fw6 mb3"><a href="/post/" class="link dark-gray dim">Data Insights</a></h2>
          {{ $n_posts := $.Param "recent_posts_number" | compare.Default 3 }}

          {{/* Range through the first $n_posts items of the section */}}
          {{ range (collections.First $n_posts $section) }}
            <div class="w-100 mb4 pb3 bb b--light-gray">
              {{ .Render "summary-with-image" }}
            </div>
          {{ end }}

          {{ if compare.Ge $section_count (math.Add $n_posts 1) }}
            <div class="w-100 mt3">
              <h3 class="f4 fw6 mb2">More Articles</h3>
              {{/* Range through the next four after the initial $n_posts items */}}
              {{ range (collections.First 4 (collections.After $n_posts $section))  }}
                <div class="mb2">
                  <a href="{{ .RelPermalink }}" class="link blue dim">
                    {{ .Title }}
                  </a>
                </div>
              {{ end }}
            </div>
          {{ end }}
        </section>

        {{/* Right Column: Economic Dashboard */}}
        <section class="w-100 w-40-l">
          <h2 class="f3 fw6 mb3"><a href="/dashboard/" class="link dark-gray dim">Economic Dashboard</a></h2>

          <div id="indicators-dashboard">
            <p class="f6 gray mb3">Last updated: <span id="indicators-last-update">Loading...</span></p>

            <div class="ba b--light-gray br2 pa3 mb3 bg-near-white">
              <h4 class="f5 fw6 mt0 mb2">Consumer Confidence</h4>
              <div id="ind-consumer-confidence" class="f3 fw7 mb2">—</div>
              <div class="sparkline-container">
                <canvas id="ind-sparkline-cc" class="sparkline-small"></canvas>
              </div>
            </div>

            <div class="ba b--light-gray br2 pa3 mb3 bg-near-white">
              <h4 class="f5 fw6 mt0 mb2">S&P 500</h4>
              <div id="ind-sp500" class="f3 fw7 mb2">—</div>
              <div class="sparkline-container">
                <canvas id="ind-sparkline-spy" class="sparkline-small"></canvas>
              </div>
            </div>

            <div class="ba b--light-gray br2 pa3 mb3 bg-near-white">
              <h4 class="f5 fw6 mt0 mb2">CPI</h4>
              <div id="ind-cpi" class="f3 fw7 mb2">—</div>
              <div class="sparkline-container">
                <canvas id="ind-sparkline-cpi" class="sparkline-small"></canvas>
              </div>
            </div>

            <div class="ba b--light-gray br2 pa3 mb3 bg-near-white">
              <h4 class="f5 fw6 mt0 mb2">Unemployment</h4>
              <div id="ind-unemployment" class="f3 fw7 mb2">—</div>
              <div class="sparkline-container">
                <canvas id="ind-sparkline-unemp" class="sparkline-small"></canvas>
              </div>
            </div>

            <div class="tc mt3">
              <a href="/dashboard" class="link blue dim fw6">View Full Dashboard →</a>
            </div>
          </div>
        </section>

      </div>
    </div>

    {{/* Ski Business News Section */}}
    <div class="pa3 pa4-ns w-100 center" style="max-width: 1400px;">
      <section class="w-100">
        <h2 class="f3 fw6 mb3"><a href="/ski-news/" class="link dark-gray dim">Ski Business News</a></h2>
        <p class="f6 gray mb3">Curated industry news, updated daily. Last update: <span id="ski-news-update">Loading...</span></p>

        <div id="ski-news-container" class="flex-l flex-wrap">
          <p class="gray">Loading ski business news...</p>
        </div>

        <div id="ski-news-empty" class="dn tc pa4 gray">
          <p>No ski business news available yet. Check back soon!</p>
        </div>
      </section>
    </div>
  {{ end }}

  {{/* Load Chart.js and dashboard script */}}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    .sparkline-container {
      position: relative;
      width: 100%;
      height: 80px;
      overflow: hidden;
    }

    .sparkline-small {
      display: block;
      width: 100%;
      height: 100%;
      max-height: 80px;
    }

    /* On large screens where the dashboard is in the right column, use slightly shorter height */
    @media screen and (min-width: 60em) {
      .sparkline-container {
        height: 70px;
      }
      .sparkline-small {
        max-height: 70px;
      }
    }

    .change-indicator { font-size: 0.75em; margin-top: 2px; }
    .change-indicator .arrow { font-weight: bold; margin-right: 2px; }
    .change-indicator .yoy { margin-right: 4px; }
    .positive { color: #27ae60; }
    .negative { color: #e74c3c; }
    .neutral { color: #3498db; }

    /* Ski News Cards */
    .ski-news-card {
      width: 100%;
      padding: 1rem;
      margin-bottom: 1rem;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      background: #fafafa;
      transition: box-shadow 0.2s ease;
    }
    .ski-news-card:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    @media screen and (min-width: 60em) {
      .ski-news-card {
        width: calc(50% - 1rem);
        margin-right: 1rem;
      }
    }
    .ski-news-card h4 {
      margin: 0 0 0.5rem 0;
      font-size: 1rem;
      line-height: 1.3;
    }
    .ski-news-card h4 a {
      color: #333;
      text-decoration: none;
    }
    .ski-news-card h4 a:hover {
      color: #0066cc;
    }
    .ski-news-meta {
      font-size: 0.75rem;
      color: #666;
      margin-bottom: 0.5rem;
    }
    .ski-news-desc {
      font-size: 0.875rem;
      color: #444;
      line-height: 1.4;
    }
  </style>
  <script>
    // Helper function to format dates for x-axis
    function formatDateLabel(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
    }

    // Calculate year-over-year or period change
    function calcChange(data, isPercent = false) {
      if (!data || data.length < 2) return null;
      const latest = data[data.length - 1].value;
      const oldest = data[0].value;
      if (oldest === 0) return null;

      if (isPercent) {
        const change = latest - oldest;
        return { change: change, pctChange: null, isPointChange: true };
      } else {
        const pctChange = ((latest - oldest) / oldest) * 100;
        return { change: latest - oldest, pctChange: pctChange, isPointChange: false };
      }
    }

    // Get trend arrow based on change
    function getTrendArrow(change) {
      if (change > 0.5) return { arrow: '\u2191', class: 'positive' };
      if (change < -0.5) return { arrow: '\u2193', class: 'negative' };
      return { arrow: '\u2192', class: 'neutral' };
    }

    // Format change indicator HTML
    function formatChangeIndicator(changeData, invertColors = false) {
      if (!changeData) return '';

      const change = changeData.pctChange !== null ? changeData.pctChange : changeData.change;
      const trend = getTrendArrow(change);

      let colorClass = trend.class;
      if (invertColors) {
        if (colorClass === 'positive') colorClass = 'negative';
        else if (colorClass === 'negative') colorClass = 'positive';
      }

      let changeText;
      if (changeData.isPointChange) {
        const sign = changeData.change >= 0 ? '+' : '';
        changeText = `${sign}${changeData.change.toFixed(2)} pts`;
      } else {
        const sign = changeData.pctChange >= 0 ? '+' : '';
        changeText = `${sign}${changeData.pctChange.toFixed(1)}%`;
      }

      return `<span class="change-indicator"><span class="arrow ${colorClass}">${trend.arrow}</span><span class="yoy ${colorClass}">${changeText} YoY</span></span>`;
    }

    // Helper function to create sparkline charts with visible x-axis
    function createIndicatorSparkline(canvasId, labels, values, color = '#3498db') {
      const ctx = document.getElementById(canvasId);
      if (!ctx) return;

      // Set canvas size to match container and computed height
      const container = ctx.parentElement;
      const containerWidth = container.offsetWidth;
      const computedHeight = parseInt(window.getComputedStyle(ctx).height) || 70;
      ctx.width = containerWidth;
      ctx.height = computedHeight;

      // Format labels for display
      const formattedLabels = labels.map(formatDateLabel);

      // Destroy existing chart if it exists
      if (ctx.chart) {
        ctx.chart.destroy();
      }

      ctx.chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: formattedLabels,
          datasets: [{
            data: values,
            borderColor: color,
            borderWidth: 2,
            fill: false,
            pointRadius: 0,
            pointHoverRadius: 3,
            pointHoverBackgroundColor: color,
            pointHoverBorderColor: '#fff',
            pointHoverBorderWidth: 2,
            tension: 0.1
          }]
        },
        options: {
          responsive: false,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              enabled: true,
              mode: 'index',
              intersect: false,
              displayColors: false,
              backgroundColor: 'rgba(0,0,0,0.8)',
              titleColor: '#fff',
              bodyColor: '#fff',
              titleFont: { size: 12, family: 'Arial, sans-serif' },
              bodyFont: { size: 12, family: 'Arial, sans-serif' },
              padding: 8,
              cornerRadius: 4,
              callbacks: {
                title: function(context) {
                  return context[0].label;
                },
                label: function(context) {
                  return context.parsed.y.toFixed(2);
                }
              }
            }
          },
          scales: {
            x: {
              display: true,
              ticks: {
                maxRotation: 45,
                minRotation: 45,
                font: { size: 9 },
                color: '#7f8c8d',
                maxTicksLimit: 4
              },
              grid: { display: false }
            },
            y: { display: false }
          },
          interaction: {
            mode: 'index',
            intersect: false
          }
        }
      });
    }

    // Load dashboard data
    async function loadIndicatorsDashboard() {
      try {
        const response = await fetch("/data/dashboard.json");
        const data = await response.json();

        document.getElementById("indicators-last-update").textContent =
          new Date(data.updated).toLocaleDateString();

        // Consumer Confidence
        if(data.consumer_confidence && data.consumer_confidence.length > 0) {
          const cc = data.consumer_confidence[data.consumer_confidence.length - 1];
          const ccChange = calcChange(data.consumer_confidence);
          document.getElementById("ind-consumer-confidence").innerHTML =
            Number(cc.value).toFixed(1) + ' ' + formatChangeIndicator(ccChange);
          const ccLabels = data.consumer_confidence.map(d => d.date);
          const ccValues = data.consumer_confidence.map(d => d.value);
          createIndicatorSparkline('ind-sparkline-cc', ccLabels, ccValues, '#3498db');
        }

        // S&P 500
        if(data.markets && data.markets.length > 0) {
          const sp = data.markets.find(m => m.symbol === "SPY");
          if (sp) {
            const currentClose = sp.current_close || sp.close;
            const spData = sp.history ? sp.history.map(h => ({value: h.close, date: h.date})) : [];
            const spChange = calcChange(spData);
            document.getElementById("ind-sp500").innerHTML =
              Number(currentClose).toFixed(0) + ' ' + formatChangeIndicator(spChange);
            if (sp.history && sp.history.length > 0) {
              const spLabels = sp.history.map(d => d.date);
              const spValues = sp.history.map(d => d.close);
              createIndicatorSparkline('ind-sparkline-spy', spLabels, spValues, '#27ae60');
            }
          }
        }

        // CPI
        if(data.cpi) {
          if(Array.isArray(data.cpi) && data.cpi.length > 0) {
            const latestCpi = data.cpi[data.cpi.length - 1];
            const cpiChange = calcChange(data.cpi);
            document.getElementById("ind-cpi").innerHTML =
              Number(latestCpi.value).toFixed(1) + ' ' + formatChangeIndicator(cpiChange);
            const cpiLabels = data.cpi.map(d => d.date);
            const cpiValues = data.cpi.map(d => d.value);
            createIndicatorSparkline('ind-sparkline-cpi', cpiLabels, cpiValues, '#9b59b6');
          }
        }

        // Unemployment (invert colors - up is bad)
        if(data.unemployment) {
          if(Array.isArray(data.unemployment) && data.unemployment.length > 0) {
            const latestUnemp = data.unemployment[data.unemployment.length - 1];
            const unempChange = calcChange(data.unemployment, true);
            document.getElementById("ind-unemployment").innerHTML =
              Number(latestUnemp.value).toFixed(1) + '% ' + formatChangeIndicator(unempChange, true);
            const unempLabels = data.unemployment.map(d => d.date);
            const unempValues = data.unemployment.map(d => d.value);
            createIndicatorSparkline('ind-sparkline-unemp', unempLabels, unempValues, '#f39c12');
          }
        }

      } catch (error) {
        console.error("Failed to load indicators:", error);
        document.getElementById("indicators-last-update").textContent = "Error loading data";
      }
    }

    // Load on page load
    loadIndicatorsDashboard();

    // Load Ski Business News
    async function loadSkiNews() {
      const container = document.getElementById('ski-news-container');
      const emptyState = document.getElementById('ski-news-empty');
      const updateSpan = document.getElementById('ski-news-update');

      try {
        const response = await fetch('/data/ski-news.json');
        const data = await response.json();

        if (updateSpan) {
          updateSpan.textContent = new Date(data.updated).toLocaleDateString();
        }

        if (!data.articles || data.articles.length === 0) {
          container.classList.add('dn');
          emptyState.classList.remove('dn');
          return;
        }

        // Display up to 6 articles on homepage
        const articles = data.articles.slice(0, 6);
        let html = '';

        articles.forEach(article => {
          const pubDate = article.pub_date ?
            new Date(article.pub_date).toLocaleDateString('en-US', {
              month: 'short', day: 'numeric', year: 'numeric'
            }) : '';

          const desc = article.description ?
            article.description.substring(0, 150) + (article.description.length > 150 ? '...' : '') : '';

          html += `
            <div class="ski-news-card">
              <h4><a href="${article.url}" target="_blank" rel="noopener">${article.title || 'Untitled'}</a></h4>
              <div class="ski-news-meta">${article.source || ''} ${pubDate ? '&bull; ' + pubDate : ''}</div>
              ${desc ? `<div class="ski-news-desc">${desc}</div>` : ''}
            </div>
          `;
        });

        container.innerHTML = html;

      } catch (error) {
        console.error('Failed to load ski news:', error);
        container.innerHTML = '<p class="gray">Unable to load ski business news.</p>';
      }
    }

    loadSkiNews();
  </script>
{{ end }}
