{{ define "main" }}
  {{/* Compact intro - left-aligned with constrained width */}}
  <article class="cf ph3 ph5-l pv1 pv2-l f6 center measure lh-copy nested-links {{ $.Param "text_color" | compare.Default "mid-gray" }}">
    {{ .Content }}
  </article>

  {{/* Three-column layout */}}
  {{ $mainSections := site.Params.mainSections | compare.Default (collections.Slice "post") }}
  {{ $show_recent_posts := site.Params.ananke.show_recent_posts }}
  {{ $section := collections.Where $.Site.RegularPages "Section" "in" $mainSections }}
  {{ $section_count := len $section }}

  {{ if and ($show_recent_posts) (compare.Ge $section_count 1) }}
    <div class="pa2 pa3-ns w-100 center" style="max-width: 1800px;">
      {{/* Four column container - Snow Cover | Economic Dashboard | Ski News | Data Insights */}}
      <div class="flex-l">

        {{/* Column 1: Snow Cover - dark theme, vertical layout */}}
        <section class="w-100 ph2-l mb4 mb0-l" style="flex: 1; min-width: 200px; max-width: 240px;">
          <div class="snow-pane h-100">
            <h2 class="snow-pane-title">
              <a href="/snow-cover/">Snow Cover</a>
            </h2>

            <div class="section-content">
              <p class="snow-updated">Updated: <span id="snow-last-update">Loading...</span></p>

              <!-- Globe Image -->
              <div class="snow-globe-wrapper">
                <a href="/snow-cover/" title="View detailed snow cover data">
                  <img src="/images/snow-globe.png" alt="North American Snow Cover" class="snow-globe-img" id="homepage-snow-globe">
                </a>
              </div>

              <!-- Legend -->
              <div class="snow-legend">
                <span class="legend-item"><span class="legend-color legend-more"></span> More</span>
                <span class="legend-item"><span class="legend-color legend-same"></span> Same</span>
                <span class="legend-item"><span class="legend-color legend-less"></span> Less</span>
              </div>

              <!-- Stats -->
              <div class="snow-stats">
                <div class="snow-stat-row">
                  <span class="snow-stat-flag">&#127482;&#127480;</span>
                  <span class="snow-stat-label">USA</span>
                  <span class="snow-stat-value" id="hp-usa-cover">--</span>
                  <span class="snow-stat-change" id="hp-usa-change">--</span>
                </div>
                <div class="snow-stat-row">
                  <span class="snow-stat-flag">&#127464;&#127462;</span>
                  <span class="snow-stat-label">Canada</span>
                  <span class="snow-stat-value" id="hp-ca-cover">--</span>
                  <span class="snow-stat-change" id="hp-ca-change">--</span>
                </div>
                <div class="snow-stat-row snow-stat-combined">
                  <span class="snow-stat-flag">&#127758;</span>
                  <span class="snow-stat-label">Combined</span>
                  <span class="snow-stat-value snow-stat-combined-value" id="hp-combined-cover">--</span>
                </div>
              </div>
            </div>

            <div class="snow-pane-footer">
              <a href="/snow-cover/">View Details &rarr;</a>
            </div>
          </div>
        </section>

        {{/* Column 2: Economic Dashboard - dark theme matching dashboard.html */}}
        <section class="w-100 ph2-l mb4 mb0-l" style="flex: 1; min-width: 220px; max-width: 280px;">
          <div class="econ-dashboard-pane h-100">
            <h2 class="econ-dashboard-title">
              <a href="/dashboard.html">Economic Dashboard</a>
            </h2>

            <div id="indicators-dashboard" class="section-content">
              <p class="econ-updated">Updated: <span id="indicators-last-update">Loading...</span></p>

              <div class="econ-indicator-card">
                <h4 class="econ-indicator-title">
                  <a href="https://fred.stlouisfed.org/series/UMCSENT" target="_blank" rel="noopener" title="University of Michigan Consumer Sentiment">Consumer Confidence</a>
                </h4>
                <div id="ind-consumer-confidence" class="econ-indicator-value">-</div>
                <div class="sparkline-container">
                  <canvas id="ind-sparkline-cc" class="sparkline-small"></canvas>
                </div>
              </div>

              <div class="econ-indicator-card">
                <h4 class="econ-indicator-title">
                  <a href="https://fred.stlouisfed.org/series/SP500" target="_blank" rel="noopener" title="S&P 500 Index">S&P 500</a>
                </h4>
                <div id="ind-sp500" class="econ-indicator-value">-</div>
                <div class="sparkline-container">
                  <canvas id="ind-sparkline-spy" class="sparkline-small"></canvas>
                </div>
              </div>

              <div class="econ-indicator-card">
                <h4 class="econ-indicator-title">
                  <a href="https://www.frbsf.org/research-and-insights/data-and-indicators/daily-news-sentiment-index/" target="_blank" rel="noopener" title="SF Fed Daily News Sentiment Index">News Sentiment</a>
                </h4>
                <div id="ind-news-sentiment" class="econ-indicator-value">-</div>
                <div class="sparkline-container">
                  <canvas id="ind-sparkline-sentiment" class="sparkline-small"></canvas>
                </div>
              </div>

              <div class="econ-indicator-card">
                <h4 class="econ-indicator-title">
                  <a href="https://fred.stlouisfed.org/series/UNRATE" target="_blank" rel="noopener" title="U.S. Unemployment Rate">Unemployment</a>
                </h4>
                <div id="ind-unemployment" class="econ-indicator-value">-</div>
                <div class="sparkline-container">
                  <canvas id="ind-sparkline-unemp" class="sparkline-small"></canvas>
                </div>
              </div>

              <div class="econ-indicator-card">
                <h4 class="econ-indicator-title">
                  <a href="https://fred.stlouisfed.org/series/DFF" target="_blank" rel="noopener" title="Federal Funds Rate">Fed Funds Rate</a>
                </h4>
                <div id="ind-fed-rate" class="econ-indicator-value">-</div>
                <div class="sparkline-container">
                  <canvas id="ind-sparkline-fed" class="sparkline-small"></canvas>
                </div>
              </div>
            </div>

            <div class="econ-dashboard-footer">
              <a href="/dashboard.html">View Full Dashboard &rarr;</a>
            </div>
          </div>
        </section>

        {{/* Column 2: Ski Business News - dark theme */}}
        <section class="w-100 ph2-l mb4 mb0-l" style="flex: 2;">
          <div class="news-pane h-100">
            <h2 class="news-pane-title">
              <a href="/ski-news/">Ski Business News</a>
            </h2>

            <div class="section-content">
              <div class="news-pane-header">
                <p class="news-updated">Updated: <span id="ski-news-update">Loading...</span></p>
                <div class="news-filter">
                  <label>Filter:</label>
                  <select id="ski-news-filter">
                    <option value="all">All</option>
                    <option value="resort-operations">Resort Ops</option>
                    <option value="business-investment">Business</option>
                    <option value="weather-snow">Weather</option>
                    <option value="transportation">Transport</option>
                    <option value="winter-sports">Sports</option>
                    <option value="safety-incidents">Safety</option>
                    <option value="canada">Canada</option>
                    <option value="international">Intl</option>
                    <option value="ski-history">History</option>
                    <option value="hospitality">Hospitality</option>
                  </select>
                </div>
              </div>

              <div id="ski-news-container">
                <p class="news-loading">Loading...</p>
              </div>

              <div id="ski-news-empty" class="dn tc pa3">
                <p class="news-empty-text">No ski news available.</p>
              </div>
            </div>

            <div class="news-pane-footer">
              <a href="/ski-news/">View All News &rarr;</a>
            </div>
          </div>
        </section>

        {{/* Column 3: Data Insights - dark theme */}}
        <section class="w-100 ph2-l mb4 mb0-l" style="flex: 2;">
          <div class="insights-pane h-100">
            <h2 class="insights-pane-title">
              <a href="/post/">Data Insights</a>
            </h2>
            {{ $n_posts := 5 }}

            <div class="section-content">
              {{/* Range through posts */}}
              {{ range (collections.First $n_posts $section) }}
                <div class="insight-card">
                  {{ if .Params.featured_image }}
                    <a href="{{ .RelPermalink }}" class="insight-image-link">
                      <img src="{{ .Params.featured_image }}" alt="{{ .Title }}" class="insight-image">
                    </a>
                  {{ end }}
                  <div class="insight-content">
                    <h4 class="insight-title">
                      <a href="{{ .RelPermalink }}">{{ .Title }}</a>
                    </h4>
                    {{ with .Params.description }}
                      <p class="insight-description">{{ . | truncate 100 }}</p>
                    {{ end }}
                    <p class="insight-date">{{ .Date.Format "Jan 2, 2006" }}</p>
                  </div>
                </div>
              {{ end }}
            </div>

            <div class="insights-pane-footer">
              <a href="/post/">View All Articles &rarr;</a>
            </div>
          </div>
        </section>

      </div>
    </div>
  {{ end }}

  {{/* Styles */}}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
  <style>
    /* Snow Cover Pane - Dark Theme */
    .snow-pane {
      display: flex;
      flex-direction: column;
      background: linear-gradient(135deg, #0a0e14 0%, #111820 100%);
      border: 1px solid #2a3444;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .snow-pane-title {
      font-family: 'DM Sans', -apple-system, sans-serif;
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0 0 0.75rem 0;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid #2a3444;
    }
    .snow-pane-title a {
      color: #e8ecf2;
      text-decoration: none;
      transition: color 0.2s;
    }
    .snow-pane-title a:hover {
      color: #60a5fa;
    }
    .snow-updated {
      font-size: 0.7rem;
      color: #8892a2;
      margin: 0 0 0.75rem 0;
    }
    .snow-globe-wrapper {
      text-align: center;
      margin-bottom: 0.75rem;
    }
    .snow-globe-wrapper a {
      display: block;
      transition: transform 0.2s;
    }
    .snow-globe-wrapper a:hover {
      transform: scale(1.02);
    }
    .snow-globe-img {
      width: 100%;
      max-width: 200px;
      height: auto;
      border-radius: 6px;
      border: 1px solid #2a3444;
    }
    .snow-legend {
      display: flex;
      justify-content: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
      font-size: 0.65rem;
      color: #8892a2;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
    }
    .legend-more { background: #3b82f6; }
    .legend-same { background: #e5e7eb; }
    .legend-less { background: #ef4444; }
    .snow-stats {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .snow-stat-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 0.5rem;
      background: #1a2230;
      border-radius: 4px;
    }
    .snow-stat-flag {
      font-size: 1rem;
      flex-shrink: 0;
    }
    .snow-stat-label {
      font-size: 0.7rem;
      color: #8892a2;
      flex: 1;
    }
    .snow-stat-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
      font-weight: 600;
      color: #e8ecf2;
    }
    .snow-stat-change {
      font-size: 0.65rem;
      color: #8892a2;
    }
    .snow-stat-change .change-up { color: #34d399; }
    .snow-stat-change .change-down { color: #f87171; }
    .snow-stat-combined {
      border-top: 1px solid #2a3444;
      margin-top: 0.25rem;
      padding-top: 0.5rem;
    }
    .snow-stat-combined-value {
      color: #4ade80;
      font-size: 1.1rem;
    }
    .snow-pane-footer {
      text-align: center;
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid #2a3444;
    }
    .snow-pane-footer a {
      color: #3b82f6;
      font-weight: 600;
      font-size: 0.8rem;
      text-decoration: none;
      transition: color 0.2s;
    }
    .snow-pane-footer a:hover {
      color: #60a5fa;
    }

    /* Economic Dashboard Pane - Dark Theme */
    .econ-dashboard-pane {
      display: flex;
      flex-direction: column;
      background: linear-gradient(135deg, #0a0e14 0%, #111820 100%);
      border: 1px solid #2a3444;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .econ-dashboard-title {
      font-family: 'DM Sans', -apple-system, sans-serif;
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0 0 0.75rem 0;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid #2a3444;
    }
    .econ-dashboard-title a {
      color: #e8ecf2;
      text-decoration: none;
      transition: color 0.2s;
    }
    .econ-dashboard-title a:hover {
      color: #60a5fa;
    }
    .econ-updated {
      font-size: 0.7rem;
      color: #8892a2;
      margin-bottom: 0.75rem;
    }
    .econ-indicator-card {
      background: #1a2230;
      border: 1px solid #2a3444;
      border-radius: 6px;
      padding: 0.6rem;
      margin-bottom: 0.5rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .econ-indicator-card:last-child {
      margin-bottom: 0;
    }
    .econ-indicator-card:hover {
      border-color: #3a4454;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .econ-indicator-title {
      font-size: 0.75rem;
      font-weight: 500;
      margin: 0 0 0.35rem 0;
    }
    .econ-indicator-title a {
      color: #8892a2;
      text-decoration: none;
      transition: color 0.2s;
    }
    .econ-indicator-title a:hover {
      color: #60a5fa;
    }
    .econ-indicator-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.1rem;
      font-weight: 600;
      color: #e8ecf2;
      margin-bottom: 0.35rem;
    }
    .econ-dashboard-footer {
      text-align: center;
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid #2a3444;
    }
    .econ-dashboard-footer a {
      color: #3b82f6;
      font-weight: 600;
      font-size: 0.8rem;
      text-decoration: none;
      transition: color 0.2s;
    }
    .econ-dashboard-footer a:hover {
      color: #60a5fa;
    }

    /* Section frames */
    .section-frame {
      display: flex;
      flex-direction: column;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .section-content {
      flex: 1;
      overflow-y: auto;
    }

    /* Ski Business News Pane - Dark Theme */
    .news-pane {
      display: flex;
      flex-direction: column;
      background: linear-gradient(135deg, #0a0e14 0%, #111820 100%);
      border: 1px solid #2a3444;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .news-pane-title {
      font-family: 'DM Sans', -apple-system, sans-serif;
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0 0 0.75rem 0;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid #2a3444;
    }
    .news-pane-title a {
      color: #e8ecf2;
      text-decoration: none;
      transition: color 0.2s;
    }
    .news-pane-title a:hover {
      color: #60a5fa;
    }
    .news-pane-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }
    .news-updated {
      font-size: 0.7rem;
      color: #8892a2;
      margin: 0;
    }
    .news-filter {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .news-filter label {
      font-size: 0.7rem;
      color: #8892a2;
    }
    .news-filter select {
      font-size: 0.7rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      background: #1a2230;
      border: 1px solid #2a3444;
      color: #e8ecf2;
      cursor: pointer;
    }
    .news-filter select:hover {
      border-color: #3a4454;
    }
    .news-loading, .news-empty-text {
      font-size: 0.75rem;
      color: #8892a2;
    }
    .news-pane-footer {
      text-align: center;
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid #2a3444;
    }
    .news-pane-footer a {
      color: #3b82f6;
      font-weight: 600;
      font-size: 0.8rem;
      text-decoration: none;
      transition: color 0.2s;
    }
    .news-pane-footer a:hover {
      color: #60a5fa;
    }

    /* Data Insights Pane - Dark Theme */
    .insights-pane {
      display: flex;
      flex-direction: column;
      background: linear-gradient(135deg, #0a0e14 0%, #111820 100%);
      border: 1px solid #2a3444;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .insights-pane-title {
      font-family: 'DM Sans', -apple-system, sans-serif;
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0 0 0.75rem 0;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid #2a3444;
    }
    .insights-pane-title a {
      color: #e8ecf2;
      text-decoration: none;
      transition: color 0.2s;
    }
    .insights-pane-title a:hover {
      color: #60a5fa;
    }
    .insight-card {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.75rem 0;
      border-bottom: 1px solid #1a2230;
    }
    .insight-card:last-child {
      border-bottom: none;
    }
    .insight-card:hover {
      background: rgba(42, 52, 68, 0.3);
      margin: 0 -0.5rem;
      padding-left: 0.5rem;
      padding-right: 0.5rem;
      border-radius: 4px;
    }
    .insight-image-link {
      flex-shrink: 0;
    }
    .insight-image {
      width: 80px;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
      background: #1a2230;
    }
    .insight-content {
      flex: 1;
      min-width: 0;
    }
    .insight-title {
      font-size: 0.85rem;
      font-weight: 600;
      margin: 0 0 0.35rem 0;
      line-height: 1.3;
    }
    .insight-title a {
      color: #e8ecf2;
      text-decoration: none;
      transition: color 0.2s;
    }
    .insight-title a:hover {
      color: #60a5fa;
    }
    .insight-description {
      font-size: 0.75rem;
      color: #8892a2;
      margin: 0 0 0.35rem 0;
      line-height: 1.4;
    }
    .insight-date {
      font-size: 0.7rem;
      color: #6b7280;
      margin: 0;
    }
    .insights-pane-footer {
      text-align: center;
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid #2a3444;
    }
    .insights-pane-footer a {
      color: #3b82f6;
      font-weight: 600;
      font-size: 0.8rem;
      text-decoration: none;
      transition: color 0.2s;
    }
    .insights-pane-footer a:hover {
      color: #60a5fa;
    }

    /* Constrain height on large screens for equal columns */
    @media screen and (min-width: 60em) {
      .section-frame,
      .snow-pane,
      .news-pane,
      .insights-pane {
        min-height: 600px;
        max-height: 700px;
      }
      .section-content {
        max-height: 520px;
      }
      .econ-dashboard-pane {
        min-height: 600px;
        max-height: 700px;
      }
      .econ-dashboard-pane .section-content {
        max-height: 520px;
      }
    }

    /* Sparkline containers - compact */
    .sparkline-container {
      position: relative;
      width: 100%;
      height: 50px;
      overflow: hidden;
    }
    .sparkline-small {
      display: block;
      width: 100%;
      height: 100%;
      max-height: 50px;
    }

    /* Indicator cards (legacy support) */
    .indicator-card {
      transition: box-shadow 0.2s ease;
    }
    .indicator-card:hover {
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    /* Change indicators - updated for dark theme */
    .change-indicator { font-size: 0.65em; margin-top: 2px; }
    .change-indicator .arrow { font-weight: bold; margin-right: 2px; }
    .change-indicator .yoy { margin-right: 4px; }
    .positive { color: #10b981; }
    .negative { color: #ef4444; }
    .neutral { color: #3b82f6; }

    /* Ski News Cards - dark theme */
    .ski-news-card {
      padding: 0.5rem 0;
      border-bottom: 1px solid #1a2230;
    }
    .ski-news-card:last-child {
      border-bottom: none;
    }
    .ski-news-card:hover {
      background: rgba(42, 52, 68, 0.3);
      margin: 0 -0.5rem;
      padding-left: 0.5rem;
      padding-right: 0.5rem;
      border-radius: 4px;
    }
    .ski-news-header {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
    }
    .ski-news-icon {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
      filter: brightness(0) invert(0.7);
    }
    .ski-news-content {
      flex: 1;
      min-width: 0;
    }
    .ski-news-card h4 {
      margin: 0 0 0.25rem 0;
      font-size: 0.8rem;
      line-height: 1.25;
    }
    .ski-news-card h4 a {
      color: #e8ecf2;
      text-decoration: none;
      transition: color 0.2s;
    }
    .ski-news-card h4 a:hover {
      color: #60a5fa;
    }
    .ski-news-meta {
      font-size: 0.65rem;
      color: #8892a2;
    }
    .ski-news-category {
      display: inline-block;
      font-size: 0.55rem;
      padding: 2px 6px;
      border-radius: 3px;
      font-weight: 600;
      text-transform: uppercase;
      margin-left: 4px;
    }

    /* Category colors - dark theme optimized */
    .cat-resort-operations { background: rgba(37, 99, 235, 0.2); color: #60a5fa; }
    .cat-business-investment { background: rgba(5, 150, 105, 0.2); color: #34d399; }
    .cat-weather-snow { background: rgba(14, 165, 233, 0.2); color: #38bdf8; }
    .cat-transportation { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }
    .cat-winter-sports { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    .cat-safety-incidents { background: rgba(220, 38, 38, 0.25); color: #fca5a5; }
    .cat-canada { background: rgba(225, 29, 72, 0.2); color: #fb7185; }
    .cat-international { background: rgba(99, 102, 241, 0.2); color: #a5b4fc; }
    .cat-ski-history { background: rgba(120, 113, 108, 0.2); color: #a8a29e; }
    .cat-hospitality { background: rgba(20, 184, 166, 0.2); color: #5eead4; }

    /* Mobile stacking */
    @media screen and (max-width: 60em) {
      .section-frame {
        max-height: none;
      }
      .section-content {
        max-height: none;
      }
    }
  </style>

  <script>
    // Helper function to format dates for x-axis
    function formatDateLabel(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
    }

    // Calculate year-over-year or period change
    function calcChange(data, isPercent = false) {
      if (!data || data.length < 2) return null;
      const latest = data[data.length - 1].value;
      const oldest = data[0].value;
      if (oldest === 0) return null;

      if (isPercent) {
        const change = latest - oldest;
        return { change: change, pctChange: null, isPointChange: true };
      } else {
        const pctChange = ((latest - oldest) / oldest) * 100;
        return { change: latest - oldest, pctChange: pctChange, isPointChange: false };
      }
    }

    // Get trend arrow based on change
    function getTrendArrow(change) {
      if (change > 0.5) return { arrow: '\u2191', class: 'positive' };
      if (change < -0.5) return { arrow: '\u2193', class: 'negative' };
      return { arrow: '\u2192', class: 'neutral' };
    }

    // Format change indicator HTML
    function formatChangeIndicator(changeData, invertColors = false) {
      if (!changeData) return '';

      const change = changeData.pctChange !== null ? changeData.pctChange : changeData.change;
      const trend = getTrendArrow(change);

      let colorClass = trend.class;
      if (invertColors) {
        if (colorClass === 'positive') colorClass = 'negative';
        else if (colorClass === 'negative') colorClass = 'positive';
      }

      let changeText;
      if (changeData.isPointChange) {
        const sign = changeData.change >= 0 ? '+' : '';
        changeText = `${sign}${changeData.change.toFixed(2)} pts`;
      } else {
        const sign = changeData.pctChange >= 0 ? '+' : '';
        changeText = `${sign}${changeData.pctChange.toFixed(1)}%`;
      }

      return `<span class="change-indicator"><span class="arrow ${colorClass}">${trend.arrow}</span><span class="yoy ${colorClass}">${changeText} YoY</span></span>`;
    }

    // Helper function to sort data by date (oldest first for left-to-right display)
    function sortByDate(data) {
      return [...data].sort((a, b) => new Date(a.date) - new Date(b.date));
    }

    // Helper function to create sparkline charts
    function createIndicatorSparkline(canvasId, labels, values, color = '#3498db') {
      const ctx = document.getElementById(canvasId);
      if (!ctx) return;

      const formattedLabels = labels.map(formatDateLabel);

      if (ctx.chart) {
        ctx.chart.destroy();
      }

      ctx.chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: formattedLabels,
          datasets: [{
            data: values,
            borderColor: color,
            borderWidth: 1.5,
            fill: false,
            pointRadius: 0,
            pointHoverRadius: 2,
            pointHoverBackgroundColor: color,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              enabled: true,
              mode: 'index',
              intersect: false,
              displayColors: false,
              backgroundColor: 'rgba(0,0,0,0.8)',
              titleFont: { size: 10 },
              bodyFont: { size: 10 },
              padding: 6,
              callbacks: {
                title: function(context) { return context[0].label; },
                label: function(context) { return context.parsed.y.toFixed(2); }
              }
            }
          },
          scales: {
            x: {
              display: true,
              ticks: {
                maxRotation: 0,
                font: { size: 8 },
                color: '#8892a2',
                maxTicksLimit: 3
              },
              grid: { display: false }
            },
            y: { display: false }
          },
          interaction: { mode: 'index', intersect: false }
        }
      });
    }

    // Special sparkline for News Sentiment with colored bands
    function createSentimentSparkline(canvasId, labels, values) {
      const ctx = document.getElementById(canvasId);
      if (!ctx) return;

      const formattedLabels = labels.map(formatDateLabel);

      if (ctx.chart) {
        ctx.chart.destroy();
      }

      ctx.chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: formattedLabels,
          datasets: [{
            data: values,
            borderColor: '#c084fc',
            borderWidth: 1.5,
            fill: false,
            pointRadius: 0,
            pointHoverRadius: 2,
            pointHoverBackgroundColor: '#c084fc',
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              enabled: true,
              mode: 'index',
              intersect: false,
              displayColors: false,
              backgroundColor: 'rgba(0,0,0,0.8)',
              titleFont: { size: 10 },
              bodyFont: { size: 10 },
              padding: 6,
              callbacks: {
                title: function(context) { return context[0].label; },
                label: function(context) {
                  const val = context.parsed.y;
                  const sign = val >= 0 ? '+' : '';
                  return sign + val.toFixed(3);
                }
              }
            },
            annotation: {
              annotations: {
                optimisticZone: {
                  type: 'box',
                  yMin: 0.05,
                  yMax: 0.3,
                  backgroundColor: 'rgba(16, 185, 129, 0.2)',
                  borderWidth: 0
                },
                neutralZone: {
                  type: 'box',
                  yMin: -0.05,
                  yMax: 0.05,
                  backgroundColor: 'rgba(100, 116, 139, 0.2)',
                  borderWidth: 0
                },
                pessimisticZone: {
                  type: 'box',
                  yMin: -0.3,
                  yMax: -0.05,
                  backgroundColor: 'rgba(239, 68, 68, 0.2)',
                  borderWidth: 0
                },
                zeroLine: {
                  type: 'line',
                  yMin: 0,
                  yMax: 0,
                  borderColor: 'rgba(136, 146, 162, 0.3)',
                  borderWidth: 1,
                  borderDash: [3, 3]
                }
              }
            }
          },
          scales: {
            x: {
              display: true,
              ticks: {
                maxRotation: 0,
                font: { size: 8 },
                color: '#8892a2',
                maxTicksLimit: 3
              },
              grid: { display: false }
            },
            y: {
              display: false,
              min: -0.15,
              max: 0.10
            }
          },
          interaction: { mode: 'index', intersect: false }
        }
      });
    }

    // Load dashboard data
    async function loadIndicatorsDashboard() {
      try {
        const response = await fetch("/data/dashboard.json");
        const data = await response.json();

        document.getElementById("indicators-last-update").textContent =
          new Date(data.updated).toLocaleDateString();

        // Consumer Confidence - bright blue for dark theme
        if(data.consumer_confidence && data.consumer_confidence.length > 0) {
          const ccSorted = sortByDate(data.consumer_confidence);
          const cc = ccSorted[ccSorted.length - 1];
          const ccChange = calcChange(ccSorted);
          document.getElementById("ind-consumer-confidence").innerHTML =
            Number(cc.value).toFixed(1) + ' ' + formatChangeIndicator(ccChange);
          createIndicatorSparkline('ind-sparkline-cc',
            ccSorted.map(d => d.date),
            ccSorted.map(d => d.value), '#60a5fa');
        }

        // S&P 500 - bright green for dark theme
        if(data.markets && data.markets.length > 0) {
          const sp = data.markets.find(m => m.symbol === "SPY");
          if (sp) {
            const currentClose = sp.current_close || sp.close;
            const spData = sp.history ? sp.history.map(h => ({value: h.close, date: h.date})) : [];
            const spSorted = sortByDate(spData);
            const spChange = calcChange(spSorted);
            document.getElementById("ind-sp500").innerHTML =
              Number(currentClose).toFixed(0) + ' ' + formatChangeIndicator(spChange);
            if (sp.history && sp.history.length > 0) {
              const historySorted = sortByDate(sp.history.map(h => ({date: h.date, close: h.close})));
              createIndicatorSparkline('ind-sparkline-spy',
                historySorted.map(d => d.date),
                historySorted.map(d => d.close), '#34d399');
            }
          }
        }

        // News Sentiment - uses special sparkline with colored bands
        if(data.news_sentiment && Array.isArray(data.news_sentiment) && data.news_sentiment.length > 0) {
          const sentimentSorted = sortByDate(data.news_sentiment);
          const latestSentiment = sentimentSorted[sentimentSorted.length - 1];
          const sentimentValue = Number(latestSentiment.value);
          const sentimentColor = sentimentValue >= 0 ? 'positive' : 'negative';
          const sentimentSign = sentimentValue >= 0 ? '+' : '';
          document.getElementById("ind-news-sentiment").innerHTML =
            `<span class="${sentimentColor}">${sentimentSign}${sentimentValue.toFixed(2)}</span>`;
          const recentSentiment = sentimentSorted.slice(-60);
          createSentimentSparkline('ind-sparkline-sentiment',
            recentSentiment.map(d => d.date),
            recentSentiment.map(d => d.value));
        }

        // Unemployment - bright amber for dark theme
        if(data.unemployment && Array.isArray(data.unemployment) && data.unemployment.length > 0) {
          const unempSorted = sortByDate(data.unemployment);
          const latestUnemp = unempSorted[unempSorted.length - 1];
          const unempChange = calcChange(unempSorted, true);
          document.getElementById("ind-unemployment").innerHTML =
            Number(latestUnemp.value).toFixed(1) + '% ' + formatChangeIndicator(unempChange, true);
          createIndicatorSparkline('ind-sparkline-unemp',
            unempSorted.map(d => d.date),
            unempSorted.map(d => d.value), '#fbbf24');
        }

        // Fed Funds Rate - bright red for dark theme
        if(data.fed_funds_rate && Array.isArray(data.fed_funds_rate) && data.fed_funds_rate.length > 0) {
          const fedSorted = sortByDate(data.fed_funds_rate);
          const latestFed = fedSorted[fedSorted.length - 1];
          const fedChange = calcChange(fedSorted, true);
          document.getElementById("ind-fed-rate").innerHTML =
            Number(latestFed.value).toFixed(2) + '% ' + formatChangeIndicator(fedChange);
          createIndicatorSparkline('ind-sparkline-fed',
            fedSorted.map(d => d.date),
            fedSorted.map(d => d.value), '#f87171');
        }

      } catch (error) {
        console.error("Failed to load indicators:", error);
        document.getElementById("indicators-last-update").textContent = "Error";
      }
    }

    loadIndicatorsDashboard();

    // Load snow cover data for homepage pane
    async function loadSnowCoverData() {
      try {
        const response = await fetch('/images/snow-globe.json');
        const data = await response.json();

        // Update timestamp
        if (data.current_date) {
          const date = new Date(data.current_date);
          document.getElementById('snow-last-update').textContent =
            date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        const stats = data.stats;

        // USA
        document.getElementById('hp-usa-cover').textContent = stats.usa_cover.toFixed(1) + '%';
        const usaChange = stats.usa_change;
        const usaClass = usaChange > 0 ? 'change-up' : usaChange < 0 ? 'change-down' : '';
        document.getElementById('hp-usa-change').innerHTML =
          `<span class="${usaClass}">${usaChange >= 0 ? '+' : ''}${usaChange.toFixed(1)}</span>`;

        // Canada
        document.getElementById('hp-ca-cover').textContent = stats.canada_cover.toFixed(1) + '%';
        const caChange = stats.canada_change;
        const caClass = caChange > 0 ? 'change-up' : caChange < 0 ? 'change-down' : '';
        document.getElementById('hp-ca-change').innerHTML =
          `<span class="${caClass}">${caChange >= 0 ? '+' : ''}${caChange.toFixed(1)}</span>`;

        // Combined
        document.getElementById('hp-combined-cover').textContent = stats.combined_cover.toFixed(1) + '%';

        // Update image with cache busting
        const img = document.getElementById('homepage-snow-globe');
        if (img && data.generated) {
          img.src = '/images/snow-globe.png?t=' + encodeURIComponent(data.generated);
        }
      } catch (error) {
        console.error('Failed to load snow data:', error);
      }
    }
    loadSnowCoverData();

    // Category metadata for ski news
    const CATEGORY_META = {
      'resort-operations': { name: 'Resort Ops', icon: '/images/ski-news-icons/resort-operations.svg' },
      'business-investment': { name: 'Business', icon: '/images/ski-news-icons/business-investment.svg' },
      'weather-snow': { name: 'Weather', icon: '/images/ski-news-icons/weather-snow.svg' },
      'transportation': { name: 'Transport', icon: '/images/ski-news-icons/transportation.svg' },
      'winter-sports': { name: 'Sports', icon: '/images/ski-news-icons/winter-sports.png' },
      'safety-incidents': { name: 'Safety', icon: '/images/ski-news-icons/safety-incidents.svg' },
      'canada': { name: 'Canada', icon: '/images/ski-news-icons/canada.png' },
      'international': { name: 'Intl', icon: '/images/ski-news-icons/international.svg' },
      'ski-history': { name: 'History', icon: '/images/ski-news-icons/ski-history.svg' },
      'hospitality': { name: 'Hospitality', icon: '/images/ski-news-icons/hospitality.svg?v=2' }
    };

    let skiNewsData = null;

    async function loadSkiNews() {
      const container = document.getElementById('ski-news-container');
      const emptyState = document.getElementById('ski-news-empty');
      const updateSpan = document.getElementById('ski-news-update');

      try {
        const response = await fetch('/data/ski-news.json');
        const data = await response.json();
        skiNewsData = data;

        if (updateSpan) {
          updateSpan.textContent = new Date(data.updated).toLocaleDateString();
        }

        if (!data.articles || data.articles.length === 0) {
          container.classList.add('dn');
          emptyState.classList.remove('dn');
          return;
        }

        renderSkiNews();

      } catch (error) {
        console.error('Failed to load ski news:', error);
        container.innerHTML = '<p class="f7 gray">Unable to load news.</p>';
      }
    }

    function renderSkiNews() {
      const container = document.getElementById('ski-news-container');
      const filterBy = document.getElementById('ski-news-filter').value;

      if (!skiNewsData || !skiNewsData.articles) return;

      let articles = skiNewsData.articles;
      if (filterBy !== 'all') {
        articles = articles.filter(a => a.category === filterBy);
      }

      // Sort by date, then score
      articles = [...articles].sort((a, b) => {
        const dateA = a.pub_date ? new Date(a.pub_date).toDateString() : '';
        const dateB = b.pub_date ? new Date(b.pub_date).toDateString() : '';
        if (dateA !== dateB) {
          return new Date(b.pub_date || 0) - new Date(a.pub_date || 0);
        }
        return (b.score || 0) - (a.score || 0);
      });

      // Show 8 articles in compact view
      const displayArticles = articles.slice(0, 8);
      let html = '';

      displayArticles.forEach(article => {
        const pubDate = article.pub_date ?
          new Date(article.pub_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';

        const category = article.category || 'resort-operations';
        const catMeta = CATEGORY_META[category] || CATEGORY_META['resort-operations'];

        html += `
          <div class="ski-news-card">
            <div class="ski-news-header">
              <img src="${catMeta.icon}" alt="${catMeta.name}" class="ski-news-icon" />
              <div class="ski-news-content">
                <h4><a href="${article.url}" target="_blank" rel="noopener">${article.title || 'Untitled'}</a></h4>
                <div class="ski-news-meta">
                  ${article.source || ''} ${pubDate ? '&bull; ' + pubDate : ''}
                  <span class="ski-news-category cat-${category}">${catMeta.name}</span>
                </div>
              </div>
            </div>
          </div>
        `;
      });

      if (displayArticles.length === 0) {
        html = '<p class="f7 gray">No articles match filter.</p>';
      }

      container.innerHTML = html;
    }

    document.getElementById('ski-news-filter').addEventListener('change', function() {
      renderSkiNews();
      // GA4 Event: Ski news category filter change
      if (typeof gtag === 'function') {
        gtag('event', 'ski_news_filter', {
          'filter_category': this.value
        });
      }
    });
    loadSkiNews();

    // GA4 Event: Ski news article click (delegated)
    document.getElementById('ski-news-container').addEventListener('click', function(e) {
      const link = e.target.closest('a');
      if (link && typeof gtag === 'function') {
        gtag('event', 'ski_news_click', {
          'article_title': link.textContent.trim().substring(0, 100),
          'destination_url': link.href
        });
      }
    });
  </script>
{{ end }}
