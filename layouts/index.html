{{ define "main" }}
  {{/* Compact intro - minimal text */}}
  <article class="cf ph3 ph5-l pv2 pv3-l f4 tc-l center measure-wide lh-copy nested-links {{ $.Param "text_color" | compare.Default "mid-gray" }}">
    {{ .Content }}
  </article>

  {{/* Three-column layout */}}
  {{ $mainSections := site.Params.mainSections | compare.Default (collections.Slice "post") }}
  {{ $show_recent_posts := site.Params.ananke.show_recent_posts }}
  {{ $section := collections.Where $.Site.RegularPages "Section" "in" $mainSections }}
  {{ $section_count := len $section }}

  {{ if and ($show_recent_posts) (compare.Ge $section_count 1) }}
    <div class="pa3 pa4-ns w-100 center" style="max-width: 1600px;">
      {{/* Three column container - Data Insights (40%) | Dashboard (20%) | Ski News (40%) */}}
      <div class="flex-l">

        {{/* Column 1: Data Insights - wider */}}
        <section class="w-100 ph2-l mb4 mb0-l" style="flex: 2;">
          <div class="section-frame ba b--light-gray br2 bg-white pa3 h-100">
            <h2 class="f4 fw6 mb2 pb2 bb b--light-gray">
              <a href="/post/" class="link dark-gray dim">Data Insights</a>
            </h2>
            {{ $n_posts := 5 }}

            <div class="section-content">
              {{/* Range through posts */}}
              {{ range (collections.First $n_posts $section) }}
                <div class="data-insight-item mb3 pb2 bb b--near-white flex items-start">
                  {{ if .Params.featured_image }}
                    <a href="{{ .RelPermalink }}" class="db flex-shrink-0 mr2" style="width: 80px;">
                      <img src="{{ .Params.featured_image }}" alt="{{ .Title }}" class="br2" style="width: 80px; height: 60px; object-fit: cover; background: #f8f8f8;">
                    </a>
                  {{ end }}
                  <div class="flex-auto">
                    <h4 class="f6 fw6 mt0 mb1 lh-title">
                      <a href="{{ .RelPermalink }}" class="link dark-gray dim">{{ .Title }}</a>
                    </h4>
                    {{ with .Params.description }}
                      <p class="f7 mid-gray ma0 mb1 lh-copy">{{ . | truncate 80 }}</p>
                    {{ end }}
                    <p class="f7 gray ma0">{{ .Date.Format "Jan 2, 2006" }}</p>
                  </div>
                </div>
              {{ end }}
            </div>

            <div class="tc mt3 pt2 bt b--light-gray">
              <a href="/post/" class="link blue dim fw6 f6">View All Articles &rarr;</a>
            </div>
          </div>
        </section>

        {{/* Column 2: Economic Dashboard - narrower for better sparklines */}}
        <section class="w-100 ph2-l mb4 mb0-l" style="flex: 1; min-width: 220px; max-width: 280px;">
          <div class="section-frame ba b--light-gray br2 bg-white pa3 h-100">
            <h2 class="f4 fw6 mb2 pb2 bb b--light-gray">
              <a href="/dashboard/" class="link dark-gray dim">Economic Dashboard</a>
            </h2>

            <div id="indicators-dashboard" class="section-content">
              <p class="f7 gray mb2">Updated: <span id="indicators-last-update">Loading...</span></p>

              <div class="indicator-card ba b--light-gray br2 pa2 mb2 bg-near-white">
                <h4 class="f6 fw6 mt0 mb1">
                  <a href="https://fred.stlouisfed.org/series/UMCSENT" target="_blank" rel="noopener" class="link dark-gray dim" title="University of Michigan Consumer Sentiment">Consumer Confidence</a>
                </h4>
                <div id="ind-consumer-confidence" class="f5 fw7 mb1">-</div>
                <div class="sparkline-container">
                  <canvas id="ind-sparkline-cc" class="sparkline-small"></canvas>
                </div>
              </div>

              <div class="indicator-card ba b--light-gray br2 pa2 mb2 bg-near-white">
                <h4 class="f6 fw6 mt0 mb1">
                  <a href="https://fred.stlouisfed.org/series/SP500" target="_blank" rel="noopener" class="link dark-gray dim" title="S&P 500 Index">S&P 500</a>
                </h4>
                <div id="ind-sp500" class="f5 fw7 mb1">-</div>
                <div class="sparkline-container">
                  <canvas id="ind-sparkline-spy" class="sparkline-small"></canvas>
                </div>
              </div>

              <div class="indicator-card ba b--light-gray br2 pa2 mb2 bg-near-white">
                <h4 class="f6 fw6 mt0 mb1">
                  <a href="https://www.frbsf.org/research-and-insights/data-and-indicators/daily-news-sentiment-index/" target="_blank" rel="noopener" class="link dark-gray dim" title="SF Fed Daily News Sentiment Index">News Sentiment</a>
                </h4>
                <div id="ind-news-sentiment" class="f5 fw7 mb1">-</div>
                <div class="sparkline-container">
                  <canvas id="ind-sparkline-sentiment" class="sparkline-small"></canvas>
                </div>
              </div>

              <div class="indicator-card ba b--light-gray br2 pa2 mb2 bg-near-white">
                <h4 class="f6 fw6 mt0 mb1">
                  <a href="https://fred.stlouisfed.org/series/UNRATE" target="_blank" rel="noopener" class="link dark-gray dim" title="U.S. Unemployment Rate">Unemployment</a>
                </h4>
                <div id="ind-unemployment" class="f5 fw7 mb1">-</div>
                <div class="sparkline-container">
                  <canvas id="ind-sparkline-unemp" class="sparkline-small"></canvas>
                </div>
              </div>

              <div class="indicator-card ba b--light-gray br2 pa2 bg-near-white">
                <h4 class="f6 fw6 mt0 mb1">
                  <a href="https://fred.stlouisfed.org/series/DFF" target="_blank" rel="noopener" class="link dark-gray dim" title="Federal Funds Rate">Fed Funds Rate</a>
                </h4>
                <div id="ind-fed-rate" class="f5 fw7 mb1">-</div>
                <div class="sparkline-container">
                  <canvas id="ind-sparkline-fed" class="sparkline-small"></canvas>
                </div>
              </div>
            </div>

            <div class="tc mt3 pt2 bt b--light-gray">
              <a href="/dashboard/" class="link blue dim fw6 f6">View Full Dashboard &rarr;</a>
            </div>
          </div>
        </section>

        {{/* Column 3: Ski Business News - wider */}}
        <section class="w-100 ph2-l mb4 mb0-l" style="flex: 2;">
          <div class="section-frame ba b--light-gray br2 bg-white pa3 h-100">
            <h2 class="f4 fw6 mb2 pb2 bb b--light-gray">
              <a href="/ski-news/" class="link dark-gray dim">Ski Business News</a>
            </h2>

            <div class="section-content">
              <p class="f7 gray mb2">Updated: <span id="ski-news-update">Loading...</span></p>

              <div class="flex items-center mb2">
                <label class="f7 gray mr1">Filter:</label>
                <select id="ski-news-filter" class="f7 pa1 br2 ba b--light-gray" style="max-width: 120px;">
                  <option value="all">All</option>
                  <option value="resort-operations">Resort Ops</option>
                  <option value="business-investment">Business</option>
                  <option value="weather-snow">Weather</option>
                  <option value="transportation">Transport</option>
                  <option value="winter-sports">Sports</option>
                  <option value="safety-incidents">Safety</option>
                  <option value="canada">Canada</option>
                  <option value="international">Intl</option>
                  <option value="ski-history">History</option>
                  <option value="hospitality">Hospitality</option>
                </select>
              </div>

              <div id="ski-news-container">
                <p class="f7 gray">Loading...</p>
              </div>

              <div id="ski-news-empty" class="dn tc pa3 gray f7">
                <p>No ski news available.</p>
              </div>
            </div>

            <div class="tc mt3 pt2 bt b--light-gray">
              <a href="/ski-news/" class="link blue dim fw6 f6">View All News &rarr;</a>
            </div>
          </div>
        </section>

      </div>
    </div>
  {{ end }}

  {{/* Styles */}}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
  <style>
    /* Section frames */
    .section-frame {
      display: flex;
      flex-direction: column;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .section-content {
      flex: 1;
      overflow-y: auto;
    }

    /* Constrain height on large screens for equal columns */
    @media screen and (min-width: 60em) {
      .section-frame {
        min-height: 600px;
        max-height: 700px;
      }
      .section-content {
        max-height: 520px;
      }
    }

    /* Sparkline containers - compact */
    .sparkline-container {
      position: relative;
      width: 100%;
      height: 50px;
      overflow: hidden;
    }
    .sparkline-small {
      display: block;
      width: 100%;
      height: 100%;
      max-height: 50px;
    }

    /* Indicator cards */
    .indicator-card {
      transition: box-shadow 0.2s ease;
    }
    .indicator-card:hover {
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    /* Change indicators */
    .change-indicator { font-size: 0.7em; margin-top: 2px; }
    .change-indicator .arrow { font-weight: bold; margin-right: 2px; }
    .change-indicator .yoy { margin-right: 4px; }
    .positive { color: #27ae60; }
    .negative { color: #e74c3c; }
    .neutral { color: #3498db; }

    /* Ski News Cards - compact for column layout */
    .ski-news-card {
      padding: 0.5rem 0;
      border-bottom: 1px solid #eee;
    }
    .ski-news-card:last-child {
      border-bottom: none;
    }
    .ski-news-header {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
    }
    .ski-news-icon {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }
    .ski-news-content {
      flex: 1;
      min-width: 0;
    }
    .ski-news-card h4 {
      margin: 0 0 0.25rem 0;
      font-size: 0.8rem;
      line-height: 1.25;
    }
    .ski-news-card h4 a {
      color: #333;
      text-decoration: none;
    }
    .ski-news-card h4 a:hover {
      color: #0066cc;
    }
    .ski-news-meta {
      font-size: 0.65rem;
      color: #666;
    }
    .ski-news-category {
      display: inline-block;
      font-size: 0.55rem;
      padding: 1px 4px;
      border-radius: 2px;
      font-weight: 600;
      text-transform: uppercase;
    }

    /* Category colors */
    .cat-resort-operations { background: #dbeafe; color: #2563eb; }
    .cat-business-investment { background: #d1fae5; color: #059669; }
    .cat-weather-snow { background: #e0f2fe; color: #0ea5e9; }
    .cat-transportation { background: #ede9fe; color: #8b5cf6; }
    .cat-winter-sports { background: #fee2e2; color: #ef4444; }
    .cat-safety-incidents { background: #fecaca; color: #dc2626; }
    .cat-canada { background: #fce7f3; color: #e11d48; }
    .cat-international { background: #e0e7ff; color: #6366f1; }
    .cat-ski-history { background: #f5f5f4; color: #78716c; }
    .cat-hospitality { background: #ccfbf1; color: #14b8a6; }

    /* Mobile stacking */
    @media screen and (max-width: 60em) {
      .section-frame {
        max-height: none;
      }
      .section-content {
        max-height: none;
      }
    }
  </style>

  <script>
    // Helper function to format dates for x-axis
    function formatDateLabel(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
    }

    // Calculate year-over-year or period change
    function calcChange(data, isPercent = false) {
      if (!data || data.length < 2) return null;
      const latest = data[data.length - 1].value;
      const oldest = data[0].value;
      if (oldest === 0) return null;

      if (isPercent) {
        const change = latest - oldest;
        return { change: change, pctChange: null, isPointChange: true };
      } else {
        const pctChange = ((latest - oldest) / oldest) * 100;
        return { change: latest - oldest, pctChange: pctChange, isPointChange: false };
      }
    }

    // Get trend arrow based on change
    function getTrendArrow(change) {
      if (change > 0.5) return { arrow: '\u2191', class: 'positive' };
      if (change < -0.5) return { arrow: '\u2193', class: 'negative' };
      return { arrow: '\u2192', class: 'neutral' };
    }

    // Format change indicator HTML
    function formatChangeIndicator(changeData, invertColors = false) {
      if (!changeData) return '';

      const change = changeData.pctChange !== null ? changeData.pctChange : changeData.change;
      const trend = getTrendArrow(change);

      let colorClass = trend.class;
      if (invertColors) {
        if (colorClass === 'positive') colorClass = 'negative';
        else if (colorClass === 'negative') colorClass = 'positive';
      }

      let changeText;
      if (changeData.isPointChange) {
        const sign = changeData.change >= 0 ? '+' : '';
        changeText = `${sign}${changeData.change.toFixed(2)} pts`;
      } else {
        const sign = changeData.pctChange >= 0 ? '+' : '';
        changeText = `${sign}${changeData.pctChange.toFixed(1)}%`;
      }

      return `<span class="change-indicator"><span class="arrow ${colorClass}">${trend.arrow}</span><span class="yoy ${colorClass}">${changeText} YoY</span></span>`;
    }

    // Helper function to sort data by date (oldest first for left-to-right display)
    function sortByDate(data) {
      return [...data].sort((a, b) => new Date(a.date) - new Date(b.date));
    }

    // Helper function to create sparkline charts
    function createIndicatorSparkline(canvasId, labels, values, color = '#3498db') {
      const ctx = document.getElementById(canvasId);
      if (!ctx) return;

      const formattedLabels = labels.map(formatDateLabel);

      if (ctx.chart) {
        ctx.chart.destroy();
      }

      ctx.chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: formattedLabels,
          datasets: [{
            data: values,
            borderColor: color,
            borderWidth: 1.5,
            fill: false,
            pointRadius: 0,
            pointHoverRadius: 2,
            pointHoverBackgroundColor: color,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              enabled: true,
              mode: 'index',
              intersect: false,
              displayColors: false,
              backgroundColor: 'rgba(0,0,0,0.8)',
              titleFont: { size: 10 },
              bodyFont: { size: 10 },
              padding: 6,
              callbacks: {
                title: function(context) { return context[0].label; },
                label: function(context) { return context.parsed.y.toFixed(2); }
              }
            }
          },
          scales: {
            x: {
              display: true,
              ticks: {
                maxRotation: 0,
                font: { size: 8 },
                color: '#999',
                maxTicksLimit: 3
              },
              grid: { display: false }
            },
            y: { display: false }
          },
          interaction: { mode: 'index', intersect: false }
        }
      });
    }

    // Special sparkline for News Sentiment with colored bands
    function createSentimentSparkline(canvasId, labels, values) {
      const ctx = document.getElementById(canvasId);
      if (!ctx) return;

      const formattedLabels = labels.map(formatDateLabel);

      if (ctx.chart) {
        ctx.chart.destroy();
      }

      ctx.chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: formattedLabels,
          datasets: [{
            data: values,
            borderColor: '#9b59b6',
            borderWidth: 1.5,
            fill: false,
            pointRadius: 0,
            pointHoverRadius: 2,
            pointHoverBackgroundColor: '#9b59b6',
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              enabled: true,
              mode: 'index',
              intersect: false,
              displayColors: false,
              backgroundColor: 'rgba(0,0,0,0.8)',
              titleFont: { size: 10 },
              bodyFont: { size: 10 },
              padding: 6,
              callbacks: {
                title: function(context) { return context[0].label; },
                label: function(context) {
                  const val = context.parsed.y;
                  const sign = val >= 0 ? '+' : '';
                  return sign + val.toFixed(3);
                }
              }
            },
            annotation: {
              annotations: {
                optimisticZone: {
                  type: 'box',
                  yMin: 0.05,
                  yMax: 0.3,
                  backgroundColor: 'rgba(39, 174, 96, 0.15)',
                  borderWidth: 0
                },
                neutralZone: {
                  type: 'box',
                  yMin: -0.05,
                  yMax: 0.05,
                  backgroundColor: 'rgba(200, 200, 200, 0.2)',
                  borderWidth: 0
                },
                pessimisticZone: {
                  type: 'box',
                  yMin: -0.3,
                  yMax: -0.05,
                  backgroundColor: 'rgba(231, 76, 60, 0.15)',
                  borderWidth: 0
                },
                zeroLine: {
                  type: 'line',
                  yMin: 0,
                  yMax: 0,
                  borderColor: 'rgba(0, 0, 0, 0.2)',
                  borderWidth: 1,
                  borderDash: [3, 3]
                }
              }
            }
          },
          scales: {
            x: {
              display: true,
              ticks: {
                maxRotation: 0,
                font: { size: 8 },
                color: '#999',
                maxTicksLimit: 3
              },
              grid: { display: false }
            },
            y: {
              display: false,
              min: -0.15,
              max: 0.10
            }
          },
          interaction: { mode: 'index', intersect: false }
        }
      });
    }

    // Load dashboard data
    async function loadIndicatorsDashboard() {
      try {
        const response = await fetch("/data/dashboard.json");
        const data = await response.json();

        document.getElementById("indicators-last-update").textContent =
          new Date(data.updated).toLocaleDateString();

        // Consumer Confidence
        if(data.consumer_confidence && data.consumer_confidence.length > 0) {
          const ccSorted = sortByDate(data.consumer_confidence);
          const cc = ccSorted[ccSorted.length - 1];
          const ccChange = calcChange(ccSorted);
          document.getElementById("ind-consumer-confidence").innerHTML =
            Number(cc.value).toFixed(1) + ' ' + formatChangeIndicator(ccChange);
          createIndicatorSparkline('ind-sparkline-cc',
            ccSorted.map(d => d.date),
            ccSorted.map(d => d.value), '#3498db');
        }

        // S&P 500
        if(data.markets && data.markets.length > 0) {
          const sp = data.markets.find(m => m.symbol === "SPY");
          if (sp) {
            const currentClose = sp.current_close || sp.close;
            const spData = sp.history ? sp.history.map(h => ({value: h.close, date: h.date})) : [];
            const spSorted = sortByDate(spData);
            const spChange = calcChange(spSorted);
            document.getElementById("ind-sp500").innerHTML =
              Number(currentClose).toFixed(0) + ' ' + formatChangeIndicator(spChange);
            if (sp.history && sp.history.length > 0) {
              const historySorted = sortByDate(sp.history.map(h => ({date: h.date, close: h.close})));
              createIndicatorSparkline('ind-sparkline-spy',
                historySorted.map(d => d.date),
                historySorted.map(d => d.close), '#27ae60');
            }
          }
        }

        // News Sentiment - uses special sparkline with colored bands
        if(data.news_sentiment && Array.isArray(data.news_sentiment) && data.news_sentiment.length > 0) {
          const sentimentSorted = sortByDate(data.news_sentiment);
          const latestSentiment = sentimentSorted[sentimentSorted.length - 1];
          const sentimentValue = Number(latestSentiment.value);
          const sentimentColor = sentimentValue >= 0 ? 'positive' : 'negative';
          const sentimentSign = sentimentValue >= 0 ? '+' : '';
          document.getElementById("ind-news-sentiment").innerHTML =
            `<span class="${sentimentColor}">${sentimentSign}${sentimentValue.toFixed(2)}</span>`;
          const recentSentiment = sentimentSorted.slice(-60);
          createSentimentSparkline('ind-sparkline-sentiment',
            recentSentiment.map(d => d.date),
            recentSentiment.map(d => d.value));
        }

        // Unemployment
        if(data.unemployment && Array.isArray(data.unemployment) && data.unemployment.length > 0) {
          const unempSorted = sortByDate(data.unemployment);
          const latestUnemp = unempSorted[unempSorted.length - 1];
          const unempChange = calcChange(unempSorted, true);
          document.getElementById("ind-unemployment").innerHTML =
            Number(latestUnemp.value).toFixed(1) + '% ' + formatChangeIndicator(unempChange, true);
          createIndicatorSparkline('ind-sparkline-unemp',
            unempSorted.map(d => d.date),
            unempSorted.map(d => d.value), '#f39c12');
        }

        // Fed Funds Rate
        if(data.fed_funds_rate && Array.isArray(data.fed_funds_rate) && data.fed_funds_rate.length > 0) {
          const fedSorted = sortByDate(data.fed_funds_rate);
          const latestFed = fedSorted[fedSorted.length - 1];
          const fedChange = calcChange(fedSorted, true);
          document.getElementById("ind-fed-rate").innerHTML =
            Number(latestFed.value).toFixed(2) + '% ' + formatChangeIndicator(fedChange);
          createIndicatorSparkline('ind-sparkline-fed',
            fedSorted.map(d => d.date),
            fedSorted.map(d => d.value), '#e74c3c');
        }

      } catch (error) {
        console.error("Failed to load indicators:", error);
        document.getElementById("indicators-last-update").textContent = "Error";
      }
    }

    loadIndicatorsDashboard();

    // Category metadata for ski news
    const CATEGORY_META = {
      'resort-operations': { name: 'Resort Ops', icon: '/images/ski-news-icons/resort-operations.svg' },
      'business-investment': { name: 'Business', icon: '/images/ski-news-icons/business-investment.svg' },
      'weather-snow': { name: 'Weather', icon: '/images/ski-news-icons/weather-snow.svg' },
      'transportation': { name: 'Transport', icon: '/images/ski-news-icons/transportation.svg' },
      'winter-sports': { name: 'Sports', icon: '/images/ski-news-icons/winter-sports.svg' },
      'safety-incidents': { name: 'Safety', icon: '/images/ski-news-icons/safety-incidents.svg' },
      'canada': { name: 'Canada', icon: '/images/ski-news-icons/canada.svg' },
      'international': { name: 'Intl', icon: '/images/ski-news-icons/international.svg' },
      'ski-history': { name: 'History', icon: '/images/ski-news-icons/ski-history.svg' },
      'hospitality': { name: 'Hospitality', icon: '/images/ski-news-icons/hospitality.svg' }
    };

    let skiNewsData = null;

    async function loadSkiNews() {
      const container = document.getElementById('ski-news-container');
      const emptyState = document.getElementById('ski-news-empty');
      const updateSpan = document.getElementById('ski-news-update');

      try {
        const response = await fetch('/data/ski-news.json');
        const data = await response.json();
        skiNewsData = data;

        if (updateSpan) {
          updateSpan.textContent = new Date(data.updated).toLocaleDateString();
        }

        if (!data.articles || data.articles.length === 0) {
          container.classList.add('dn');
          emptyState.classList.remove('dn');
          return;
        }

        renderSkiNews();

      } catch (error) {
        console.error('Failed to load ski news:', error);
        container.innerHTML = '<p class="f7 gray">Unable to load news.</p>';
      }
    }

    function renderSkiNews() {
      const container = document.getElementById('ski-news-container');
      const filterBy = document.getElementById('ski-news-filter').value;

      if (!skiNewsData || !skiNewsData.articles) return;

      let articles = skiNewsData.articles;
      if (filterBy !== 'all') {
        articles = articles.filter(a => a.category === filterBy);
      }

      // Sort by date, then score
      articles = [...articles].sort((a, b) => {
        const dateA = a.pub_date ? new Date(a.pub_date).toDateString() : '';
        const dateB = b.pub_date ? new Date(b.pub_date).toDateString() : '';
        if (dateA !== dateB) {
          return new Date(b.pub_date || 0) - new Date(a.pub_date || 0);
        }
        return (b.score || 0) - (a.score || 0);
      });

      // Show 8 articles in compact view
      const displayArticles = articles.slice(0, 8);
      let html = '';

      displayArticles.forEach(article => {
        const pubDate = article.pub_date ?
          new Date(article.pub_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';

        const category = article.category || 'resort-operations';
        const catMeta = CATEGORY_META[category] || CATEGORY_META['resort-operations'];

        html += `
          <div class="ski-news-card">
            <div class="ski-news-header">
              <img src="${catMeta.icon}" alt="${catMeta.name}" class="ski-news-icon" />
              <div class="ski-news-content">
                <h4><a href="${article.url}" target="_blank" rel="noopener">${article.title || 'Untitled'}</a></h4>
                <div class="ski-news-meta">
                  ${article.source || ''} ${pubDate ? '&bull; ' + pubDate : ''}
                  <span class="ski-news-category cat-${category}">${catMeta.name}</span>
                </div>
              </div>
            </div>
          </div>
        `;
      });

      if (displayArticles.length === 0) {
        html = '<p class="f7 gray">No articles match filter.</p>';
      }

      container.innerHTML = html;
    }

    document.getElementById('ski-news-filter').addEventListener('change', function() {
      renderSkiNews();
      // GA4 Event: Ski news category filter change
      if (typeof gtag === 'function') {
        gtag('event', 'ski_news_filter', {
          'filter_category': this.value
        });
      }
    });
    loadSkiNews();

    // GA4 Event: Ski news article click (delegated)
    document.getElementById('ski-news-container').addEventListener('click', function(e) {
      const link = e.target.closest('a');
      if (link && typeof gtag === 'function') {
        gtag('event', 'ski_news_click', {
          'article_title': link.textContent.trim().substring(0, 100),
          'destination_url': link.href
        });
      }
    });
  </script>
{{ end }}
