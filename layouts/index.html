{{ define "main" }}
  <article class="cf ph3 ph5-l pv3 pv4-l f4 tc-l center measure-wide lh-copy nested-links {{ $.Param "text_color" | compare.Default "mid-gray" }}">
    {{ .Content }}
  </article>

  {{/* Two-column layout: News and Indicators Dashboard */}}
  {{ $mainSections := site.Params.mainSections | compare.Default (collections.Slice "post") }}
  {{ $show_recent_posts := site.Params.ananke.show_recent_posts }}
  {{ $section := collections.Where $.Site.RegularPages "Section" "in" $mainSections }}
  {{ $section_count := len $section }}

  {{ if and ($show_recent_posts) (compare.Ge $section_count 1) }}
    <div class="pa3 pa4-ns w-100 center" style="max-width: 1400px;">

      {{/* Two column container */}}
      <div class="flex-l">

        {{/* Left Column: Data Insights Section */}}
        <section class="w-100 w-60-l pr4-l mb4 mb0-l">
          <h2 class="f3 fw6 mb3"><a href="/post/" class="link dark-gray dim">Data Insights</a></h2>
          {{ $n_posts := $.Param "recent_posts_number" | compare.Default 3 }}

          {{/* Range through the first $n_posts items of the section */}}
          {{ range (collections.First $n_posts $section) }}
            <div class="w-100 mb4 pb3 bb b--light-gray">
              {{ .Render "summary-with-image" }}
            </div>
          {{ end }}

          {{ if compare.Ge $section_count (math.Add $n_posts 1) }}
            <div class="w-100 mt3">
              <h3 class="f4 fw6 mb2">More Articles</h3>
              {{/* Range through the next four after the initial $n_posts items */}}
              {{ range (collections.First 4 (collections.After $n_posts $section))  }}
                <div class="mb2">
                  <a href="{{ .RelPermalink }}" class="link blue dim">
                    {{ .Title }}
                  </a>
                </div>
              {{ end }}
            </div>
          {{ end }}
        </section>

        {{/* Right Column: Economic Dashboard */}}
        <section class="w-100 w-40-l">
          <h2 class="f3 fw6 mb3"><a href="/dashboard/" class="link dark-gray dim">Economic Dashboard</a></h2>

          <div id="indicators-dashboard">
            <p class="f6 gray mb3">Last updated: <span id="indicators-last-update">Loading...</span></p>

            <div class="ba b--light-gray br2 pa3 mb3 bg-near-white">
              <h4 class="f5 fw6 mt0 mb2"><a href="https://fred.stlouisfed.org/series/UMCSENT" target="_blank" rel="noopener" class="link dark-gray dim" title="University of Michigan Consumer Sentiment">Consumer Confidence</a></h4>
              <div id="ind-consumer-confidence" class="f3 fw7 mb2">—</div>
              <div class="sparkline-container">
                <canvas id="ind-sparkline-cc" class="sparkline-small"></canvas>
              </div>
            </div>

            <div class="ba b--light-gray br2 pa3 mb3 bg-near-white">
              <h4 class="f5 fw6 mt0 mb2"><a href="https://fred.stlouisfed.org/series/SP500" target="_blank" rel="noopener" class="link dark-gray dim" title="S&P 500 Index">S&P 500</a></h4>
              <div id="ind-sp500" class="f3 fw7 mb2">—</div>
              <div class="sparkline-container">
                <canvas id="ind-sparkline-spy" class="sparkline-small"></canvas>
              </div>
            </div>

            <div class="ba b--light-gray br2 pa3 mb3 bg-near-white">
              <h4 class="f5 fw6 mt0 mb2"><a href="https://www.frbsf.org/research-and-insights/data-and-indicators/daily-news-sentiment-index/" target="_blank" rel="noopener" class="link dark-gray dim" title="SF Fed Daily News Sentiment Index">News Sentiment</a></h4>
              <div id="ind-news-sentiment" class="f3 fw7 mb2">—</div>
              <div class="sparkline-container">
                <canvas id="ind-sparkline-sentiment" class="sparkline-small"></canvas>
              </div>
            </div>

            <div class="ba b--light-gray br2 pa3 mb3 bg-near-white">
              <h4 class="f5 fw6 mt0 mb2"><a href="https://fred.stlouisfed.org/series/UNRATE" target="_blank" rel="noopener" class="link dark-gray dim" title="U.S. Unemployment Rate">Unemployment</a></h4>
              <div id="ind-unemployment" class="f3 fw7 mb2">—</div>
              <div class="sparkline-container">
                <canvas id="ind-sparkline-unemp" class="sparkline-small"></canvas>
              </div>
            </div>

            <div class="tc mt3">
              <a href="/dashboard" class="link blue dim fw6">View Full Dashboard →</a>
            </div>
          </div>
        </section>

      </div>
    </div>

    {{/* Ski Business News Section */}}
    <div class="pa3 pa4-ns w-100 center" style="max-width: 1400px;">
      <section class="w-100">
        <h2 class="f3 fw6 mb3"><a href="/ski-news/" class="link dark-gray dim">Ski Business News</a></h2>
        <div class="flex items-center justify-between mb3">
          <p class="f6 gray ma0">Curated industry news, updated daily. Last update: <span id="ski-news-update">Loading...</span></p>
          <div class="flex items-center">
            <label class="f6 gray mr2">Sort:</label>
            <select id="ski-news-sort" class="f6 pa1 br2 ba b--light-gray">
              <option value="date">Date</option>
              <option value="category">Category</option>
            </select>
            <label class="f6 gray ml3 mr2">Filter:</label>
            <select id="ski-news-filter" class="f6 pa1 br2 ba b--light-gray">
              <option value="all">All Categories</option>
              <option value="resort-operations">Resort Operations</option>
              <option value="business-investment">Business & Investment</option>
              <option value="weather-snow">Weather & Snow</option>
              <option value="transportation">Transportation</option>
              <option value="winter-sports">Winter Sports</option>
              <option value="safety-incidents">Safety</option>
              <option value="canada">Canada</option>
              <option value="international">International</option>
              <option value="ski-history">Ski History</option>
              <option value="hospitality">Hospitality</option>
            </select>
          </div>
        </div>

        <div id="ski-news-container" class="flex-l flex-wrap">
          <p class="gray">Loading ski business news...</p>
        </div>

        <div id="ski-news-empty" class="dn tc pa4 gray">
          <p>No ski business news available yet. Check back soon!</p>
        </div>
      </section>
    </div>
  {{ end }}

  {{/* Load Chart.js and dashboard script */}}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    .sparkline-container {
      position: relative;
      width: 100%;
      height: 80px;
      overflow: hidden;
    }

    .sparkline-small {
      display: block;
      width: 100%;
      height: 100%;
      max-height: 80px;
    }

    /* On large screens where the dashboard is in the right column, use slightly shorter height */
    @media screen and (min-width: 60em) {
      .sparkline-container {
        height: 70px;
      }
      .sparkline-small {
        max-height: 70px;
      }
    }

    .change-indicator { font-size: 0.75em; margin-top: 2px; }
    .change-indicator .arrow { font-weight: bold; margin-right: 2px; }
    .change-indicator .yoy { margin-right: 4px; }
    .positive { color: #27ae60; }
    .negative { color: #e74c3c; }
    .neutral { color: #3498db; }

    /* Ski News Cards */
    .ski-news-card {
      width: 100%;
      padding: 1rem;
      margin-bottom: 1rem;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      background: #fafafa;
      transition: box-shadow 0.2s ease;
    }
    .ski-news-card:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    @media screen and (min-width: 60em) {
      .ski-news-card {
        width: calc(50% - 1rem);
        margin-right: 1rem;
      }
    }
    .ski-news-header {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
    }
    .ski-news-icon {
      width: 32px;
      height: 32px;
      flex-shrink: 0;
    }
    .ski-news-content {
      flex: 1;
    }
    .ski-news-card h4 {
      margin: 0 0 0.5rem 0;
      font-size: 1rem;
      line-height: 1.3;
    }
    .ski-news-card h4 a {
      color: #333;
      text-decoration: none;
    }
    .ski-news-card h4 a:hover {
      color: #0066cc;
    }
    .ski-news-meta {
      font-size: 0.75rem;
      color: #666;
      margin-bottom: 0.5rem;
    }
    .ski-news-category {
      display: inline-block;
      font-size: 0.65rem;
      padding: 2px 6px;
      border-radius: 3px;
      margin-left: 6px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .ski-news-desc {
      font-size: 0.875rem;
      color: #444;
      line-height: 1.4;
    }
    /* Category colors */
    .cat-resort-operations { background: #dbeafe; color: #2563eb; }
    .cat-business-investment { background: #d1fae5; color: #059669; }
    .cat-weather-snow { background: #e0f2fe; color: #0ea5e9; }
    .cat-transportation { background: #ede9fe; color: #8b5cf6; }
    .cat-winter-sports { background: #fee2e2; color: #ef4444; }
    .cat-safety-incidents { background: #fecaca; color: #dc2626; }
    .cat-canada { background: #fce7f3; color: #e11d48; }
    .cat-international { background: #e0e7ff; color: #6366f1; }
    .cat-ski-history { background: #f5f5f4; color: #78716c; }
    .cat-hospitality { background: #ccfbf1; color: #14b8a6; }
    .ski-news-secondary { font-size: 0.6rem; opacity: 0.8; margin-left: 4px; }

    /* Mobile responsive for sort/filter controls */
    @media screen and (max-width: 60em) {
      .flex.items-center.justify-between {
        flex-direction: column;
        align-items: flex-start;
      }
      .flex.items-center.justify-between > div {
        margin-top: 0.5rem;
        flex-wrap: wrap;
        gap: 0.5rem;
      }
    }
  </style>
  <script>
    // Helper function to format dates for x-axis
    function formatDateLabel(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
    }

    // Calculate year-over-year or period change
    function calcChange(data, isPercent = false) {
      if (!data || data.length < 2) return null;
      const latest = data[data.length - 1].value;
      const oldest = data[0].value;
      if (oldest === 0) return null;

      if (isPercent) {
        const change = latest - oldest;
        return { change: change, pctChange: null, isPointChange: true };
      } else {
        const pctChange = ((latest - oldest) / oldest) * 100;
        return { change: latest - oldest, pctChange: pctChange, isPointChange: false };
      }
    }

    // Get trend arrow based on change
    function getTrendArrow(change) {
      if (change > 0.5) return { arrow: '\u2191', class: 'positive' };
      if (change < -0.5) return { arrow: '\u2193', class: 'negative' };
      return { arrow: '\u2192', class: 'neutral' };
    }

    // Format change indicator HTML
    function formatChangeIndicator(changeData, invertColors = false) {
      if (!changeData) return '';

      const change = changeData.pctChange !== null ? changeData.pctChange : changeData.change;
      const trend = getTrendArrow(change);

      let colorClass = trend.class;
      if (invertColors) {
        if (colorClass === 'positive') colorClass = 'negative';
        else if (colorClass === 'negative') colorClass = 'positive';
      }

      let changeText;
      if (changeData.isPointChange) {
        const sign = changeData.change >= 0 ? '+' : '';
        changeText = `${sign}${changeData.change.toFixed(2)} pts`;
      } else {
        const sign = changeData.pctChange >= 0 ? '+' : '';
        changeText = `${sign}${changeData.pctChange.toFixed(1)}%`;
      }

      return `<span class="change-indicator"><span class="arrow ${colorClass}">${trend.arrow}</span><span class="yoy ${colorClass}">${changeText} YoY</span></span>`;
    }

    // Helper function to create sparkline charts with visible x-axis
    function createIndicatorSparkline(canvasId, labels, values, color = '#3498db') {
      const ctx = document.getElementById(canvasId);
      if (!ctx) {
        console.error('Canvas not found:', canvasId);
        return;
      }

      // Format labels for display
      const formattedLabels = labels.map(formatDateLabel);

      // Destroy existing chart if it exists
      if (ctx.chart) {
        ctx.chart.destroy();
      }

      ctx.chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: formattedLabels,
          datasets: [{
            data: values,
            borderColor: color,
            borderWidth: 2,
            fill: false,
            pointRadius: 0,
            pointHoverRadius: 3,
            pointHoverBackgroundColor: color,
            pointHoverBorderColor: '#fff',
            pointHoverBorderWidth: 2,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              enabled: true,
              mode: 'index',
              intersect: false,
              displayColors: false,
              backgroundColor: 'rgba(0,0,0,0.8)',
              titleColor: '#fff',
              bodyColor: '#fff',
              titleFont: { size: 12, family: 'Arial, sans-serif' },
              bodyFont: { size: 12, family: 'Arial, sans-serif' },
              padding: 8,
              cornerRadius: 4,
              callbacks: {
                title: function(context) {
                  return context[0].label;
                },
                label: function(context) {
                  return context.parsed.y.toFixed(2);
                }
              }
            }
          },
          scales: {
            x: {
              display: true,
              ticks: {
                maxRotation: 45,
                minRotation: 45,
                font: { size: 9 },
                color: '#7f8c8d',
                maxTicksLimit: 4
              },
              grid: { display: false }
            },
            y: { display: false }
          },
          interaction: {
            mode: 'index',
            intersect: false
          }
        }
      });
    }

    // Load dashboard data
    async function loadIndicatorsDashboard() {
      try {
        const response = await fetch("/data/dashboard.json");
        const data = await response.json();

        document.getElementById("indicators-last-update").textContent =
          new Date(data.updated).toLocaleDateString();

        // Consumer Confidence
        if(data.consumer_confidence && data.consumer_confidence.length > 0) {
          const cc = data.consumer_confidence[data.consumer_confidence.length - 1];
          const ccChange = calcChange(data.consumer_confidence);
          document.getElementById("ind-consumer-confidence").innerHTML =
            Number(cc.value).toFixed(1) + ' ' + formatChangeIndicator(ccChange);
          const ccLabels = data.consumer_confidence.map(d => d.date);
          const ccValues = data.consumer_confidence.map(d => d.value);
          createIndicatorSparkline('ind-sparkline-cc', ccLabels, ccValues, '#3498db');
        }

        // S&P 500
        if(data.markets && data.markets.length > 0) {
          const sp = data.markets.find(m => m.symbol === "SPY");
          if (sp) {
            const currentClose = sp.current_close || sp.close;
            const spData = sp.history ? sp.history.map(h => ({value: h.close, date: h.date})) : [];
            const spChange = calcChange(spData);
            document.getElementById("ind-sp500").innerHTML =
              Number(currentClose).toFixed(0) + ' ' + formatChangeIndicator(spChange);
            if (sp.history && sp.history.length > 0) {
              const spLabels = sp.history.map(d => d.date);
              const spValues = sp.history.map(d => d.close);
              createIndicatorSparkline('ind-sparkline-spy', spLabels, spValues, '#27ae60');
            }
          }
        }

        // News Sentiment (from SF Fed - daily updates)
        if(data.news_sentiment) {
          if(Array.isArray(data.news_sentiment) && data.news_sentiment.length > 0) {
            const latestSentiment = data.news_sentiment[data.news_sentiment.length - 1];
            const sentimentValue = Number(latestSentiment.value);
            // Format sentiment with sign and color indicator
            const sentimentColor = sentimentValue >= 0 ? 'positive' : 'negative';
            const sentimentSign = sentimentValue >= 0 ? '+' : '';
            document.getElementById("ind-news-sentiment").innerHTML =
              `<span class="${sentimentColor}">${sentimentSign}${sentimentValue.toFixed(2)}</span>`;
            // Use last 60 days for sparkline (daily data has 365 points)
            const recentSentiment = data.news_sentiment.slice(-60);
            const sentimentLabels = recentSentiment.map(d => d.date);
            const sentimentValues = recentSentiment.map(d => d.value);
            createIndicatorSparkline('ind-sparkline-sentiment', sentimentLabels, sentimentValues, '#9b59b6');
          }
        }

        // Unemployment (invert colors - up is bad)
        if(data.unemployment) {
          if(Array.isArray(data.unemployment) && data.unemployment.length > 0) {
            const latestUnemp = data.unemployment[data.unemployment.length - 1];
            const unempChange = calcChange(data.unemployment, true);
            document.getElementById("ind-unemployment").innerHTML =
              Number(latestUnemp.value).toFixed(1) + '% ' + formatChangeIndicator(unempChange, true);
            const unempLabels = data.unemployment.map(d => d.date);
            const unempValues = data.unemployment.map(d => d.value);
            createIndicatorSparkline('ind-sparkline-unemp', unempLabels, unempValues, '#f39c12');
          }
        }

      } catch (error) {
        console.error("Failed to load indicators:", error);
        document.getElementById("indicators-last-update").textContent = "Error loading data";
      }
    }

    // Load on page load
    loadIndicatorsDashboard();

    // Category metadata
    const CATEGORY_META = {
      'resort-operations': { name: 'Resort Operations', icon: '/images/ski-news-icons/resort-operations.svg' },
      'business-investment': { name: 'Business & Investment', icon: '/images/ski-news-icons/business-investment.svg' },
      'weather-snow': { name: 'Weather & Snow', icon: '/images/ski-news-icons/weather-snow.svg' },
      'transportation': { name: 'Transportation', icon: '/images/ski-news-icons/transportation.svg' },
      'winter-sports': { name: 'Winter Sports', icon: '/images/ski-news-icons/winter-sports.svg' },
      'safety-incidents': { name: 'Safety & Incidents', icon: '/images/ski-news-icons/safety-incidents.svg' },
      'canada': { name: 'Canada', icon: '/images/ski-news-icons/canada.svg' },
      'international': { name: 'International', icon: '/images/ski-news-icons/international.svg' },
      'ski-history': { name: 'Ski History', icon: '/images/ski-news-icons/ski-history.svg' },
      'hospitality': { name: 'Hospitality', icon: '/images/ski-news-icons/hospitality.svg' }
    };

    // Global state for ski news
    let skiNewsData = null;

    // Load Ski Business News
    async function loadSkiNews() {
      const container = document.getElementById('ski-news-container');
      const emptyState = document.getElementById('ski-news-empty');
      const updateSpan = document.getElementById('ski-news-update');

      try {
        const response = await fetch('/data/ski-news.json');
        const data = await response.json();
        skiNewsData = data;

        if (updateSpan) {
          updateSpan.textContent = new Date(data.updated).toLocaleDateString();
        }

        if (!data.articles || data.articles.length === 0) {
          container.classList.add('dn');
          emptyState.classList.remove('dn');
          return;
        }

        renderSkiNews();

      } catch (error) {
        console.error('Failed to load ski news:', error);
        container.innerHTML = '<p class="gray">Unable to load ski business news.</p>';
      }
    }

    function renderSkiNews() {
      const container = document.getElementById('ski-news-container');
      const sortBy = document.getElementById('ski-news-sort').value;
      const filterBy = document.getElementById('ski-news-filter').value;

      if (!skiNewsData || !skiNewsData.articles) return;

      // Filter articles
      let articles = skiNewsData.articles;
      if (filterBy !== 'all') {
        articles = articles.filter(a => a.category === filterBy);
      }

      // Sort articles
      if (sortBy === 'category') {
        articles = [...articles].sort((a, b) => {
          const catA = a.category || 'resort-operations';
          const catB = b.category || 'resort-operations';
          if (catA !== catB) return catA.localeCompare(catB);
          return new Date(b.pub_date || 0) - new Date(a.pub_date || 0);
        });
      } else {
        articles = [...articles].sort((a, b) => {
          const dateA = a.pub_date ? new Date(a.pub_date).toDateString() : '';
          const dateB = b.pub_date ? new Date(b.pub_date).toDateString() : '';
          if (dateA !== dateB) {
            return new Date(b.pub_date || 0) - new Date(a.pub_date || 0);
          }
          return (b.score || 0) - (a.score || 0);
        });
      }

      // Display up to 6 articles on homepage
      const displayArticles = articles.slice(0, 6);
      let html = '';

      displayArticles.forEach(article => {
        const pubDate = article.pub_date ?
          new Date(article.pub_date).toLocaleDateString('en-US', {
            month: 'short', day: 'numeric', year: 'numeric'
          }) : '';

        const desc = article.description ?
          article.description.substring(0, 150) + (article.description.length > 150 ? '...' : '') : '';

        const category = article.category || 'resort-operations';
        const catMeta = CATEGORY_META[category] || CATEGORY_META['resort-operations'];

        // Build secondary categories display
        let secondaryHtml = '';
        if (article.secondary_categories && article.secondary_categories.length > 0) {
          const secondaryNames = article.secondary_categories
            .map(c => CATEGORY_META[c]?.name || c);
          secondaryHtml = `<span class="ski-news-secondary">+${secondaryNames.join(', ')}</span>`;
        }

        html += `
          <div class="ski-news-card">
            <div class="ski-news-header">
              <img src="${catMeta.icon}" alt="${catMeta.name}" class="ski-news-icon" />
              <div class="ski-news-content">
                <h4><a href="${article.url}" target="_blank" rel="noopener">${article.title || 'Untitled'}</a></h4>
                <div class="ski-news-meta">
                  ${article.source || ''} ${pubDate ? '&bull; ' + pubDate : ''}
                  <span class="ski-news-category cat-${category}">${catMeta.name}</span>${secondaryHtml}
                </div>
                ${desc ? `<div class="ski-news-desc">${desc}</div>` : ''}
              </div>
            </div>
          </div>
        `;
      });

      if (displayArticles.length === 0) {
        html = '<p class="gray w-100">No articles match the selected filter.</p>';
      }

      container.innerHTML = html;
    }

    // Event listeners for sort and filter
    document.getElementById('ski-news-sort').addEventListener('change', renderSkiNews);
    document.getElementById('ski-news-filter').addEventListener('change', renderSkiNews);

    loadSkiNews();
  </script>
{{ end }}
