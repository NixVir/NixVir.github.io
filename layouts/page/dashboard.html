{{ define "main" }}
<article class="pa3 pa4-ns">
  <div class="mw8 center">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

    <style>
    .dashboard-updated { text-align: center; margin-bottom: 20px; color: #666; }
    .accordion-section { margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
    .accordion-header { display: flex; align-items: center; justify-content: space-between; padding: 15px 20px; background: #f8f9fa; cursor: pointer; user-select: none; transition: background 0.2s; }
    .accordion-header:hover { background: #e9ecef; }
    .accordion-header h3 { margin: 0; font-size: 1.1em; color: #2c3e50; display: flex; align-items: center; gap: 10px; }
    .accordion-header .section-icon { font-size: 1.2em; }
    .accordion-header .metric-count { font-size: 0.8em; color: #7f8c8d; font-weight: normal; }
    .accordion-arrow { font-size: 1.2em; color: #7f8c8d; transition: transform 0.3s; }
    .accordion-section.open .accordion-arrow { transform: rotate(180deg); }
    .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background: #fff; }
    .accordion-section.open .accordion-content { max-height: none; }
    .accordion-inner { padding: 20px; }
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
    .metric-card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #f9f9f9; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .metric-card h4 { margin: 0 0 8px 0; color: #333; font-size: 1em; }
    .value { font-size: 1.8em; font-weight: bold; color: #2c3e50; }
    .period { color: #7f8c8d; font-size: 0.85em; margin-top: 3px; }
    .chart-container { height: 120px; margin-top: 12px; }
    .positive { color: #059669; }
    .negative { color: #dc2626; }
    .neutral { color: #3498db; }
    /* Standardized change indicator pills - prominent, scannable */
    .change-indicator { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; align-items: center; }
    .change-pill { display: inline-flex; align-items: center; gap: 4px; padding: 5px 10px; border-radius: 6px; font-size: 0.95em; font-weight: 600; }
    .change-pill.positive { background: #d1fae5; color: #059669; }
    .change-pill.negative { background: #fee2e2; color: #dc2626; }
    .change-pill.neutral { background: #e0f2fe; color: #0284c7; }
    .change-pill .arrow { font-weight: 700; }
    .change-secondary { font-size: 0.8em; color: #6b7280; padding: 3px 8px; background: #f3f4f6; border-radius: 4px; }
    .prediction-intro { font-size: 0.85em; color: #7f8c8d; margin-bottom: 15px; padding: 10px; background: #f0f4f8; border-radius: 6px; }
    .prediction-intro a { color: #3498db; }
    .prediction-card { min-height: 280px; }
    .prediction-meta { font-size: 0.75em; color: #95a5a6; margin-top: 8px; text-align: right; }
    .consensus-value { font-size: 2em; font-weight: bold; color: #2c3e50; }
    .consensus-prob { font-size: 0.9em; color: #27ae60; margin-left: 8px; }
    .consensus-label { font-size: 0.85em; color: #7f8c8d; }
    /* Tooltip icons for metric definitions */
    .tooltip-icon { cursor: help; color: #95a5a6; font-size: 0.85em; margin-left: 4px; }
    .tooltip-icon:hover { color: #3498db; }
    /* Region filter buttons for ski airports */
    .region-filter { padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; background: #fff; cursor: pointer; font-size: 0.85em; transition: all 0.2s; }
    .region-filter:hover { background: #f0f4f8; border-color: #3498db; }
    .region-filter.active { background: #3498db; color: #fff; border-color: #3498db; }
    /* Ski airport cards */
    .ski-airport-card { position: relative; }
    .ski-airport-card .resort-tag { font-size: 0.75em; color: #7f8c8d; margin-top: 4px; }
    .ski-airport-card .yoy-change { font-size: 0.85em; margin-top: 6px; }
    .ski-airport-card .airport-code { font-size: 0.9em; color: #95a5a6; font-weight: normal; }
    </style>

    <noscript>
      <div style="background: #fef3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 1rem; margin-bottom: 1.5rem; color: #856404;">
        <strong>JavaScript Required:</strong> The Economic Dashboard requires JavaScript to display interactive charts and real-time data.
        Please enable JavaScript in your browser settings to view the full dashboard.
      </div>
    </noscript>

    <div id="dashboard-container">
      <div class="dashboard-updated">Last updated: <span id="last-update">Loading...</span></div>

      <div class="accordion-section" data-section="economic">
        <div class="accordion-header" onclick="toggleSection(this)">
          <h3><span class="section-icon">üìä</span> Economic Indicators <span class="metric-count">(8 metrics)</span></h3>
          <span class="accordion-arrow">‚ñº</span>
        </div>
        <div class="accordion-content">
          <div class="accordion-inner">
            <div class="dashboard-grid">
              <div class="metric-card"><h4>GDP (Quarterly)</h4><div id="gdp">Loading...</div><div class="chart-container"><canvas id="chart-gdp"></canvas></div></div>
              <div class="metric-card"><h4>Consumer Confidence</h4><div id="consumer-confidence">Loading...</div><div class="chart-container"><canvas id="chart-cc"></canvas></div></div>
              <div class="metric-card"><h4>CPI (Consumer Price Index)</h4><div id="cpi">Loading...</div><div class="chart-container"><canvas id="chart-cpi"></canvas></div></div>
              <div class="metric-card"><h4>Unemployment Rate</h4><div id="unemployment">Loading...</div><div class="chart-container"><canvas id="chart-unemp"></canvas></div></div>
              <div class="metric-card"><h4>Employment (Thousands)</h4><div id="employment">Loading...</div><div class="chart-container"><canvas id="chart-emp"></canvas></div></div>
              <div class="metric-card"><h4>Average Hourly Wages</h4><div id="wages">Loading...</div><div class="chart-container"><canvas id="chart-wages"></canvas></div></div>
              <div class="metric-card"><h4>Housing Starts (Thousands)</h4><div id="housing">Loading...</div><div class="chart-container"><canvas id="chart-housing"></canvas></div></div>
              <div class="metric-card"><h4>Bankruptcy Activity (PPI)</h4><div id="bankruptcy">Loading...</div><div class="chart-container"><canvas id="chart-bankruptcy"></canvas></div></div>
            </div>
          </div>
        </div>
      </div>

      <div class="accordion-section" data-section="markets">
        <div class="accordion-header" onclick="toggleSection(this)">
          <h3><span class="section-icon">üìà</span> Markets & Interest Rates <span class="metric-count">(6 indices + Mag 7)</span></h3>
          <span class="accordion-arrow">‚ñº</span>
        </div>
        <div class="accordion-content">
          <div class="accordion-inner">
            <h4 style="margin: 0 0 15px 0; color: #7f8c8d; font-size: 0.9em; font-weight: 500;">Major Indices</h4>
            <div class="dashboard-grid">
              <div class="metric-card"><h4>S&P 500 Index</h4><div id="sp500">Loading...</div><div class="chart-container"><canvas id="chart-spy"></canvas></div></div>
              <div class="metric-card"><h4>Dow Jones Industrial</h4><div id="djia">Loading...</div><div class="chart-container"><canvas id="chart-djia"></canvas></div></div>
              <div class="metric-card"><h4>NASDAQ Composite</h4><div id="nasdaq">Loading...</div><div class="chart-container"><canvas id="chart-nasdaq"></canvas></div></div>
              <div class="metric-card"><h4>Hotel & Lodging REITs</h4><div id="hotel-reits">Loading...</div><div class="chart-container"><canvas id="chart-hotel"></canvas></div></div>
              <div class="metric-card"><h4>Fed Funds Rate</h4><div id="fed-rate">Loading...</div><div class="chart-container"><canvas id="chart-fed"></canvas></div></div>
              <div class="metric-card"><h4>10-Year Treasury Yield</h4><div id="treasury">Loading...</div><div class="chart-container"><canvas id="chart-treasury"></canvas></div></div>
            </div>
            <h4 style="margin: 25px 0 15px 0; color: #7f8c8d; font-size: 0.9em; font-weight: 500;">Magnificent 7 Stocks</h4>
            <div class="dashboard-grid" id="mag7-grid">
              <div class="metric-card"><div id="mag7-loading">Loading Magnificent 7...</div></div>
            </div>
          </div>
        </div>
      </div>

      <div class="accordion-section" data-section="currency">
        <div class="accordion-header" onclick="toggleSection(this)">
          <h3><span class="section-icon">üí±</span> Currency & Visitor Purchasing Power <span class="metric-count">(19 metrics)</span></h3>
          <span class="accordion-arrow">‚ñº</span>
        </div>
        <div class="accordion-content">
          <div class="accordion-inner">
            <div class="prediction-intro">
              <strong>Visitor Purchasing Power Perspective</strong> ‚Äî Metrics reoriented to show "what does 100 units of visitor currency buy in USD?" Higher values = more attractive destination. Research shows ski tourism is highly elastic to exchange rates (-1.5 to -2.2).
              <br><br>
              <strong>Thresholds:</strong> <span style="color: #2E7D32;">Green = favorable for your resort</span> | <span style="color: #757575;">Gray = neutral</span> | <span style="color: #C62828;">Red = headwind</span>. Currency impacts lag 3-6 months for destination travel bookings.
              <br><br>
              <span style="font-size: 0.9em; color: #95a5a6;">Sources: <a href="https://fred.stlouisfed.org/categories/105" target="_blank" rel="noopener">FRED Exchange Rates</a> | <a href="https://www.federalreserve.gov/releases/h10/summary/" target="_blank" rel="noopener">Fed H.10 Release</a></span>
            </div>

            <!-- US RESORT VIEW -->
            <h4 style="margin: 0 0 10px 0; color: #2c3e50; font-size: 1em; font-weight: 600; border-bottom: 2px solid #3498db; padding-bottom: 5px;">üá∫üá∏ US Resort Perspective</h4>
            <p style="font-size: 0.85em; color: #7f8c8d; margin: 0 0 15px 0;">"How attractive is skiing in the US for international visitors?" Higher = better.</p>
            <div class="dashboard-grid">
              <div class="metric-card"><h4>100 CAD buys...</h4><div id="pp-cad">Loading...</div><div class="chart-container"><canvas id="chart-pp-cad"></canvas></div></div>
              <div class="metric-card"><h4>100 MXN buys...</h4><div id="pp-mxn">Loading...</div><div class="chart-container"><canvas id="chart-pp-mxn"></canvas></div></div>
              <div class="metric-card"><h4>100 EUR buys...</h4><div id="pp-eur">Loading...</div><div class="chart-container"><canvas id="chart-pp-eur"></canvas></div></div>
              <div class="metric-card"><h4>100 GBP buys...</h4><div id="pp-gbp">Loading...</div><div class="chart-container"><canvas id="chart-pp-gbp"></canvas></div></div>
              <div class="metric-card"><h4>100 BRL buys...</h4><div id="pp-brl">Loading...</div><div class="chart-container"><canvas id="chart-pp-brl"></canvas></div></div>
              <div class="metric-card"><h4>100 AUD buys...</h4><div id="pp-aud">Loading...</div><div class="chart-container"><canvas id="chart-pp-aud"></canvas></div></div>
            </div>

            <!-- CANADIAN RESORT VIEW -->
            <h4 style="margin: 25px 0 10px 0; color: #2c3e50; font-size: 1em; font-weight: 600; border-bottom: 2px solid #e74c3c; padding-bottom: 5px;">üá®üá¶ Canadian Resort Perspective</h4>
            <p style="font-size: 0.85em; color: #7f8c8d; margin: 0 0 15px 0;">"How attractive is Canada for US/international visitors?" + Domestic retention signal.</p>
            <div class="dashboard-grid">
              <div class="metric-card"><h4>$100 USD buys (CAD)</h4><div id="pp-usd-cad">Loading...</div><div class="chart-container"><canvas id="chart-pp-usd-cad"></canvas></div></div>
              <div class="metric-card"><h4>Domestic Retention</h4><div id="ca-retention">Loading...</div><div class="chart-container"><canvas id="chart-ca-retention"></canvas></div></div>
              <div class="metric-card"><h4>100 EUR buys (CAD)</h4><div id="pp-eur-cad">Loading...</div><div class="chart-container"><canvas id="chart-pp-eur-cad"></canvas></div></div>
              <div class="metric-card"><h4>100 GBP buys (CAD)</h4><div id="pp-gbp-cad">Loading...</div><div class="chart-container"><canvas id="chart-pp-gbp-cad"></canvas></div></div>
            </div>

            <!-- LUXURY FEEDER MARKETS -->
            <h4 style="margin: 25px 0 10px 0; color: #2c3e50; font-size: 1em; font-weight: 600; border-bottom: 2px solid #9b59b6; padding-bottom: 5px;">üíé Luxury Feeder Markets</h4>
            <p style="font-size: 0.85em; color: #7f8c8d; margin: 0 0 15px 0;">Ultra-high-net-worth markets. Less price-elastic but affects ancillary spend, length of stay, and party size.</p>
            <div class="dashboard-grid">
              <div class="metric-card"><h4>100 HKD buys...</h4><div id="pp-hkd">Loading...</div><div class="chart-container"><canvas id="chart-pp-hkd"></canvas></div></div>
              <div class="metric-card"><h4>100 SGD buys...</h4><div id="pp-sgd">Loading...</div><div class="chart-container"><canvas id="chart-pp-sgd"></canvas></div></div>
              <div class="metric-card"><h4>100 AED buys...</h4><div id="pp-aed">Loading...</div><div class="chart-container"><canvas id="chart-pp-aed"></canvas></div></div>
              <div class="metric-card"><h4>100 CNY buys...</h4><div id="pp-cny">Loading...</div><div class="chart-container"><canvas id="chart-pp-cny"></canvas></div></div>
              <div class="metric-card"><h4>100 JPY buys...</h4><div id="pp-jpy">Loading...</div><div class="chart-container"><canvas id="chart-pp-jpy"></canvas></div></div>
              <div class="metric-card"><h4>100 INR buys...</h4><div id="pp-inr">Loading...</div><div class="chart-container"><canvas id="chart-pp-inr"></canvas></div></div>
              <div class="metric-card"><h4>100 RUB buys...</h4><div id="pp-rub">Loading...</div><div class="chart-container"><canvas id="chart-pp-rub"></canvas></div></div>
            </div>

            <!-- COMPETITIVE DESTINATION COMPARISON -->
            <h4 style="margin: 25px 0 10px 0; color: #2c3e50; font-size: 1em; font-weight: 600; border-bottom: 2px solid #f39c12; padding-bottom: 5px;">üèîÔ∏è Competitive Destination Comparison</h4>
            <p style="font-size: 0.85em; color: #7f8c8d; margin: 0 0 15px 0;">How does CAD compare vs Alps (EUR/CHF) and Niseko (JPY)?</p>
            <div class="dashboard-grid">
              <div class="metric-card"><h4>$100 USD ‚Üí Whistler (CAD)</h4><div id="comp-whistler">Loading...</div><div class="chart-container"><canvas id="chart-comp-whistler"></canvas></div></div>
              <div class="metric-card"><h4>$100 USD ‚Üí Alps/France (EUR)</h4><div id="comp-alps-eur">Loading...</div><div class="chart-container"><canvas id="chart-comp-alps-eur"></canvas></div></div>
              <div class="metric-card"><h4>$100 USD ‚Üí Swiss Alps (CHF)</h4><div id="comp-swiss">Loading...</div><div class="chart-container"><canvas id="chart-comp-swiss"></canvas></div></div>
              <div class="metric-card"><h4>$100 USD ‚Üí Niseko (JPY)</h4><div id="comp-niseko">Loading...</div><div class="chart-container"><canvas id="chart-comp-niseko"></canvas></div></div>
            </div>

            <!-- DOLLAR STRENGTH INDEX -->
            <h4 style="margin: 25px 0 10px 0; color: #7f8c8d; font-size: 0.9em; font-weight: 500;">Dollar Strength Indices (Reference)</h4>
            <div class="dashboard-grid">
              <div class="metric-card"><h4>Trade-Weighted USD (Nominal)</h4><div id="trade-weighted">Loading...</div><div class="chart-container"><canvas id="chart-tw"></canvas></div></div>
              <div class="metric-card"><h4>Trade-Weighted USD (Real)</h4><div id="real-trade-weighted">Loading...</div><div class="chart-container"><canvas id="chart-rtw"></canvas></div></div>
            </div>
          </div>
        </div>
      </div>

      <div class="accordion-section" data-section="commodities">
        <div class="accordion-header" onclick="toggleSection(this)">
          <h3><span class="section-icon">üõ¢Ô∏è</span> Commodity Prices <span class="metric-count">(4 commodities)</span></h3>
          <span class="accordion-arrow">‚ñº</span>
        </div>
        <div class="accordion-content">
          <div class="accordion-inner">
            <div class="dashboard-grid">
              <div class="metric-card"><h4>Gold ($/oz)</h4><div id="gold">Loading...</div><div class="chart-container"><canvas id="chart-gold"></canvas></div></div>
              <div class="metric-card"><h4>Crude Oil WTI ($/barrel)</h4><div id="crude-oil">Loading...</div><div class="chart-container"><canvas id="chart-oil"></canvas></div></div>
              <div class="metric-card"><h4>Natural Gas ($/MMBtu)</h4><div id="natural-gas">Loading...</div><div class="chart-container"><canvas id="chart-gas"></canvas></div></div>
              <div class="metric-card"><h4>Copper ($/lb)</h4><div id="copper">Loading...</div><div class="chart-container"><canvas id="chart-copper"></canvas></div></div>
            </div>
          </div>
        </div>
      </div>

      <div class="accordion-section" data-section="electricity">
        <div class="accordion-header" onclick="toggleSection(this)">
          <h3><span class="section-icon">‚ö°</span> Electricity Pricing <span class="metric-count">(8 ski states)</span></h3>
          <span class="accordion-arrow">‚ñº</span>
        </div>
        <div class="accordion-content">
          <div class="accordion-inner">
            <div class="prediction-intro">
              <strong>Commercial Sector Retail Electricity Rates</strong> (cents/kWh) ‚Äî Monthly average prices paid by commercial customers including ski resorts, lodges, and related businesses. Data from <a href="https://www.eia.gov/electricity/monthly/" target="_blank" rel="noopener">EIA Electric Power Monthly</a> (Form EIA-861M), updated ~60 days after month-end.
              <br><br>
              <strong>Why these states?</strong> Selected for major ski markets: <em>Colorado/Utah/Wyoming</em> (Rocky Mountain region), <em>California</em> (Tahoe/Mammoth), <em>Vermont/New Hampshire</em> (Northeast), and <em>Washington</em> (Pacific Northwest). Rates vary significantly by region due to generation mix, grid infrastructure, and state policy.
              <br><br>
              <strong>Forward indicator:</strong> Natural gas prices (Henry Hub, above) lead electricity rates by 1-3 months since gas-fired generation sets marginal prices in most U.S. markets. When gas prices rise, expect electricity costs to follow.
              <br><br>
              <span style="font-size: 0.9em; color: #95a5a6;">Sources: <a href="https://www.eia.gov/electricity/data/state/" target="_blank" rel="noopener">EIA State Electricity Profiles</a> | <a href="https://www.eia.gov/opendata/documentation.php" target="_blank" rel="noopener">EIA Open Data API v2</a> | Commercial sector = NAICS codes for lodging, retail, services</span>
            </div>
            <div class="dashboard-grid">
              <div class="metric-card"><h4>U.S. Average</h4><div id="elec-us">Loading...</div><div class="chart-container"><canvas id="chart-elec-us"></canvas></div></div>
              <div class="metric-card"><h4>Colorado (Rockies)</h4><div id="elec-co">Loading...</div><div class="chart-container"><canvas id="chart-elec-co"></canvas></div></div>
              <div class="metric-card"><h4>Utah (Wasatch)</h4><div id="elec-ut">Loading...</div><div class="chart-container"><canvas id="chart-elec-ut"></canvas></div></div>
              <div class="metric-card"><h4>California (Tahoe/Mammoth)</h4><div id="elec-ca">Loading...</div><div class="chart-container"><canvas id="chart-elec-ca"></canvas></div></div>
              <div class="metric-card"><h4>Vermont</h4><div id="elec-vt">Loading...</div><div class="chart-container"><canvas id="chart-elec-vt"></canvas></div></div>
              <div class="metric-card"><h4>New Hampshire</h4><div id="elec-nh">Loading...</div><div class="chart-container"><canvas id="chart-elec-nh"></canvas></div></div>
              <div class="metric-card"><h4>Washington (PNW)</h4><div id="elec-wa">Loading...</div><div class="chart-container"><canvas id="chart-elec-wa"></canvas></div></div>
              <div class="metric-card"><h4>Wyoming (Jackson)</h4><div id="elec-wy">Loading...</div><div class="chart-container"><canvas id="chart-elec-wy"></canvas></div></div>
            </div>
          </div>
        </div>
      </div>

      <div class="accordion-section" data-section="border">
        <div class="accordion-header" onclick="toggleSection(this)">
          <h3><span class="section-icon">üõÇ</span> US/Canada Border Crossings <span class="metric-count">(16 metrics)</span></h3>
          <span class="accordion-arrow">‚ñº</span>
        </div>
        <div class="accordion-content">
          <div class="accordion-inner">
            <div class="prediction-intro">
              <strong>Personal Vehicle Passengers</strong> ‚Äî Monthly counts of passengers crossing US/Canada land border ports. Key indicator for Canadian visitor flows to US ski markets. Data from <a href="https://data.bts.gov/Research-and-Statistics/Border-Crossing-Entry-Data/keg4-3bc2" target="_blank" rel="noopener">Bureau of Transportation Statistics</a>, updated monthly with ~2 month lag.
              <br><br>
              <strong>Ski Market Relevance:</strong> Canadian visitors represent a significant segment for Montana (Whitefish/Big Sky), Vermont, and Washington (Crystal/Stevens Pass) resorts. Strong CAD and favorable exchange rates typically correlate with increased border crossings.
              <br><br>
              <strong>2019 Baseline:</strong> All metrics include comparison to 2019 (pre-COVID) levels to contextualize current recovery status. Shaded areas on charts indicate ski season (Nov-Apr).
              <br><br>
              <span style="font-size: 0.9em; color: #95a5a6;">Sources: <a href="https://data.bts.gov" target="_blank" rel="noopener">BTS Border Crossing Portal</a> | <a href="https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=2410007101" target="_blank" rel="noopener">Statistics Canada Table 24-10-0071</a></span>
            </div>

            <!-- NATIONAL TOTALS WITH CAD OVERLAY -->
            <h4 style="margin: 0 0 10px 0; color: #2c3e50; font-size: 1em; font-weight: 600; border-bottom: 2px solid #3498db; padding-bottom: 5px;">üá∫üá∏ US Border Entry (BTS)</h4>
            <p style="font-size: 0.9em; color: #7f8c8d; margin: 0 0 15px 0;">Canadian visitors entering US ‚Äî all land border crossings combined. <span id="border-vs-2019-badge" class="change-pill" style="font-size: 1.1em; padding: 6px 14px; margin-left: 8px;"></span></p>
            <div class="dashboard-grid">
              <div class="metric-card" style="grid-column: span 2;">
                <h4>US/Canada Total (Monthly) <span class="tooltip-icon" title="Total personal vehicle passengers entering US from Canada across all border ports. Includes both US residents returning and Canadian visitors.">‚ìò</span></h4>
                <div id="border-national">Loading...</div>
                <div style="font-size: 0.8em; color: #7f8c8d; margin-top: 5px;">CAD/USD trend shown in orange overlay</div>
                <div class="chart-container" style="height: 180px;"><canvas id="chart-border-national"></canvas></div>
              </div>
            </div>

            <!-- CANADIAN ORIGIN MARKETS (StatCan) -->
            <h4 style="margin: 25px 0 10px 0; color: #2c3e50; font-size: 1em; font-weight: 600; border-bottom: 2px solid #e74c3c; padding-bottom: 5px;">üá®üá¶ Canadian Origin Markets (StatCan)</h4>
            <p style="font-size: 0.85em; color: #7f8c8d; margin: 0 0 15px 0;">Quarterly Canadian outbound visits to US by province of origin. Shows which Canadian markets are generating US-bound travel.</p>
            <div id="canadian-outbound-grid" class="dashboard-grid">
              <!-- Dynamically populated -->
            </div>

            <!-- SKI-RELEVANT STATES -->
            <h4 style="margin: 25px 0 10px 0; color: #2c3e50; font-size: 1em; font-weight: 600; border-bottom: 2px solid #27ae60; padding-bottom: 5px;">US Entry by State</h4>
            <p style="font-size: 0.85em; color: #7f8c8d; margin: 0 0 15px 0;">State-level crossings for major ski market corridors. Shaded regions indicate ski season (Nov-Apr).</p>
            <div class="dashboard-grid">
              <div class="metric-card"><h4>Montana <span class="tooltip-icon" title="Entry points: Sweetgrass (Calgary corridor), Roosville (BC corridor). Primary resorts: Big Sky, Whitefish, Bridger Bowl.">‚ìò</span></h4><div id="border-montana">Loading...</div><div class="chart-container"><canvas id="chart-border-montana"></canvas></div></div>
              <div class="metric-card"><h4>Vermont <span class="tooltip-icon" title="Entry points: Derby Line, Highgate Springs (Montreal/Quebec corridor). Primary resorts: Stowe, Jay Peak, Killington, Smugglers' Notch.">‚ìò</span></h4><div id="border-vermont">Loading...</div><div class="chart-container"><canvas id="chart-border-vermont"></canvas></div></div>
              <div class="metric-card"><h4>Washington <span class="tooltip-icon" title="Entry points: Blaine (I-5/Vancouver), Sumas. Primary resorts: Mt. Baker, Stevens Pass, Crystal Mountain.">‚ìò</span></h4><div id="border-washington">Loading...</div><div class="chart-container"><canvas id="chart-border-washington"></canvas></div></div>
              <div class="metric-card"><h4>New York <span class="tooltip-icon" title="Entry points: Champlain (I-87/Montreal corridor). Primary resorts: Whiteface, Gore Mountain, Lake Placid.">‚ìò</span></h4><div id="border-ny">Loading...</div><div class="chart-container"><canvas id="chart-border-ny"></canvas></div></div>
              <div class="metric-card"><h4>Maine <span class="tooltip-icon" title="Entry points: Houlton, Calais (New Brunswick corridor). Primary resorts: Sugarloaf, Sunday River.">‚ìò</span></h4><div id="border-maine">Loading...</div><div class="chart-container"><canvas id="chart-border-maine"></canvas></div></div>
              <div class="metric-card"><h4>Idaho <span class="tooltip-icon" title="Entry points: Eastport (BC corridor). Primary resorts: Sun Valley, Schweitzer.">‚ìò</span></h4><div id="border-idaho">Loading...</div><div class="chart-container"><canvas id="chart-border-idaho"></canvas></div></div>
            </div>

            <!-- KEY PORTS WITH RESORT MAPPING -->
            <h4 style="margin: 25px 0 10px 0; color: #2c3e50; font-size: 1em; font-weight: 600; border-bottom: 2px solid #9b59b6; padding-bottom: 5px;">Key Border Ports</h4>
            <p style="font-size: 0.85em; color: #7f8c8d; margin: 0 0 15px 0;">Major crossing points with resort destinations served. Click port for details.</p>
            <div id="border-ports-grid" class="dashboard-grid">
              <!-- Dynamically populated with resort tags -->
            </div>
          </div>
        </div>
      </div>

      <div class="accordion-section" data-section="air-travel">
        <div class="accordion-header" onclick="toggleSection(this)">
          <h3><span class="section-icon">‚úàÔ∏è</span> Air Travel Indicators <span class="metric-count">(5 metrics + 16 ski airports)</span></h3>
          <span class="accordion-arrow">‚ñº</span>
        </div>
        <div class="accordion-content">
          <div class="accordion-inner">
            <div class="prediction-intro">
              <strong>Air Travel Demand Signals</strong> ‚Äî Key indicators for understanding air travel patterns affecting ski destination access. Jet fuel prices are a leading indicator for airfare changes; TSA checkpoints provide real-time demand signals.
              <br><br>
              <strong>Why it matters:</strong> Air connectivity is critical for destination resorts drawing fly-in visitors. Rising fuel costs typically lead to fare increases within 4-8 weeks. Load factors above 85% indicate capacity constraints and potential pricing pressure.
              <br><br>
              <span style="font-size: 0.9em; color: #95a5a6;">Sources: <a href="https://fred.stlouisfed.org/series/WJFUELUSGULF" target="_blank" rel="noopener">EIA via FRED (Jet Fuel)</a> | <a href="https://www.tsa.gov/travel/passenger-volumes" target="_blank" rel="noopener">TSA Checkpoint Data</a> | <a href="https://data.bts.gov" target="_blank" rel="noopener">BTS T-100</a></span>
            </div>

            <!-- PRICING INDICATORS -->
            <h4 style="margin: 0 0 10px 0; color: #2c3e50; font-size: 1em; font-weight: 600; border-bottom: 2px solid #e74c3c; padding-bottom: 5px;">Pricing Indicators</h4>
            <p style="font-size: 0.85em; color: #7f8c8d; margin: 0 0 15px 0;">Leading indicators for airfare changes. Fuel costs typically pass through to fares within 4-8 weeks.</p>
            <div class="dashboard-grid">
              <div class="metric-card">
                <h4>Jet Fuel Price ($/gal) <span class="tooltip-icon" title="Gulf Coast kerosene-type jet fuel spot price (EIA). A leading indicator for airfare changes‚Äîfuel costs typically pass through to ticket prices within 4-8 weeks.">‚ìò</span></h4>
                <div id="jet-fuel">Loading...</div>
                <div class="chart-container"><canvas id="chart-jet-fuel"></canvas></div>
              </div>
            </div>

            <!-- DEMAND INDICATORS -->
            <h4 style="margin: 25px 0 10px 0; color: #2c3e50; font-size: 1em; font-weight: 600; border-bottom: 2px solid #3498db; padding-bottom: 5px;">Demand Indicators</h4>
            <p style="font-size: 0.85em; color: #7f8c8d; margin: 0 0 15px 0;">Overall air travel demand and capacity utilization signals.</p>
            <div class="dashboard-grid">
              <div class="metric-card">
                <h4>National Enplanements <span class="tooltip-icon" title="Total passengers boarding flights at US airports (FRED/BTS). Includes domestic and international. Data is in thousands‚Äîmultiply by 1,000 for actual passenger counts. Monthly data with ~2 month lag.">‚ìò</span></h4>
                <div id="enplanements">Loading...</div>
                <div class="chart-container"><canvas id="chart-enplanements"></canvas></div>
              </div>
              <div class="metric-card">
                <h4>Domestic Load Factor <span class="tooltip-icon" title="Percentage of available seats filled on domestic flights (FRED/BTS). Above 85% indicates capacity pressure, potential pricing increases, and booking challenges. Below 75% may signal weak demand or overcapacity.">‚ìò</span></h4>
                <div id="load-factor">Loading...</div>
                <div class="chart-container"><canvas id="chart-load-factor"></canvas></div>
              </div>
              <div class="metric-card">
                <h4>T-100 Passengers <span class="tooltip-icon" title="Total passengers on domestic flight segments from BTS Form 41 T-100 reports. Unlike enplanements, this counts each segment separately‚Äîconnecting passengers count once per flight. Provides actual flown capacity data.">‚ìò</span></h4>
                <div id="t100-passengers">Loading...</div>
                <div class="chart-container"><canvas id="chart-t100"></canvas></div>
              </div>
            </div>

            <!-- REAL-TIME ACTIVITY -->
            <h4 style="margin: 25px 0 10px 0; color: #2c3e50; font-size: 1em; font-weight: 600; border-bottom: 2px solid #27ae60; padding-bottom: 5px;">Real-Time Activity</h4>
            <p style="font-size: 0.85em; color: #7f8c8d; margin: 0 0 15px 0;">Daily TSA checkpoint data provides near-real-time travel demand signals.</p>
            <div class="dashboard-grid">
              <div class="metric-card">
                <h4>TSA Checkpoint Volume <span class="tooltip-icon" title="Daily passenger screenings at TSA airport checkpoints. Published daily with 1-day lag. Highly variable by day of week‚Äîdisplayed as 7-day rolling average to smooth volatility. Compare to same period last year for trend analysis.">‚ìò</span></h4>
                <div id="tsa-checkpoint">Loading...</div>
                <div class="chart-container"><canvas id="chart-tsa"></canvas></div>
              </div>
            </div>

            <!-- SKI GATEWAY AIRPORTS -->
            <h4 style="margin: 25px 0 10px 0; color: #2c3e50; font-size: 1em; font-weight: 600; border-bottom: 2px solid #9b59b6; padding-bottom: 5px;">Ski Gateway Airports <span class="tooltip-icon" title="Annual passenger volumes at airports serving major North American ski destinations. Data from BTS T-100 Segment reports. Useful for understanding air access capacity to specific resort markets.">‚ìò</span></h4>
            <p style="font-size: 0.85em; color: #7f8c8d; margin: 0 0 15px 0;">Annual passenger traffic at airports serving major ski destinations. Filter by region or view all.</p>

            <!-- Region filter buttons -->
            <div style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 8px;">
              <button class="region-filter active" data-region="all" onclick="filterSkiAirports('all')">All Regions</button>
              <button class="region-filter" data-region="colorado" onclick="filterSkiAirports('colorado')">Colorado</button>
              <button class="region-filter" data-region="rockies" onclick="filterSkiAirports('rockies')">Northern Rockies</button>
              <button class="region-filter" data-region="california" onclick="filterSkiAirports('california')">California/Nevada</button>
              <button class="region-filter" data-region="hubs" onclick="filterSkiAirports('hubs')">Major Hubs</button>
            </div>

            <div id="ski-airports-grid" class="dashboard-grid">
              <!-- Populated by JavaScript -->
            </div>
          </div>
        </div>
      </div>

      <div class="accordion-section" data-section="prediction">
        <div class="accordion-header" onclick="toggleSection(this)">
          <h3><span class="section-icon">üéØ</span> Prediction Markets <span class="metric-count">(Kalshi)</span></h3>
          <span class="accordion-arrow">‚ñº</span>
        </div>
        <div class="accordion-content">
          <div class="accordion-inner">
            <div class="prediction-intro">
              Market-implied probabilities from <a href="https://kalshi.com" target="_blank" rel="noopener">Kalshi</a> prediction markets. These reflect trader expectations for economic outcomes.
            </div>
            <div class="dashboard-grid">
              <div class="metric-card prediction-card">
                <h4>2025 Annual Inflation</h4>
                <div id="inflation-consensus">Loading...</div>
                <div class="chart-container" style="height: 180px;"><canvas id="chart-inflation-dist"></canvas></div>
                <div class="prediction-meta" id="inflation-meta"></div>
              </div>
              <div class="metric-card prediction-card">
                <h4>Jobs Report Outlook</h4>
                <div id="payrolls-consensus">Loading...</div>
                <div class="chart-container" style="height: 180px;"><canvas id="chart-payrolls"></canvas></div>
                <div class="prediction-meta" id="payrolls-meta"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
    const charts = {};

    function toggleSection(header) {
      const section = header.parentElement;
      const wasOpen = section.classList.contains('open');
      section.classList.toggle('open');
      if (!wasOpen) {
        setTimeout(function() {
          Object.keys(charts).forEach(function(chartId) {
            if (charts[chartId]) charts[chartId].resize();
          });
        }, 350);
      }
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
    }

    function formatShortDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function calcChange(data, isPercent) {
      if (!data || data.length < 2) return null;
      const latest = data[data.length - 1].value;
      const oldest = data[0].value;
      if (oldest === 0) return null;
      if (isPercent) {
        return { change: latest - oldest, pctChange: null, isPointChange: true };
      } else {
        return { change: latest - oldest, pctChange: ((latest - oldest) / oldest) * 100, isPointChange: false };
      }
    }

    function calc30DayMomentum(data, isPercent) {
      if (!data || data.length < 30) return null;
      const latest = data[data.length - 1].value;
      const thirtyDaysAgo = data[data.length - 30].value;
      if (thirtyDaysAgo === 0) return null;
      if (isPercent) {
        return { change: latest - thirtyDaysAgo, isPointChange: true };
      } else {
        return { pctChange: ((latest - thirtyDaysAgo) / thirtyDaysAgo) * 100, isPointChange: false };
      }
    }

    function getTrendArrow(change) {
      if (change > 0.5) return { arrow: '‚Üë', cls: 'positive' };
      if (change < -0.5) return { arrow: '‚Üì', cls: 'negative' };
      return { arrow: '‚Üí', cls: 'neutral' };
    }

    function formatChangeIndicator(changeData, momentumData, invertColors) {
      if (!changeData) return '';
      const change = changeData.pctChange !== null ? changeData.pctChange : changeData.change;
      const trend = getTrendArrow(change);
      let colorClass = trend.cls;
      if (invertColors) {
        if (colorClass === 'positive') colorClass = 'negative';
        else if (colorClass === 'negative') colorClass = 'positive';
      }
      // Primary change pill with arrow - standardized prominent display
      let changeText = changeData.isPointChange
        ? (changeData.change >= 0 ? '+' : '') + changeData.change.toFixed(2) + ' pts'
        : (changeData.pctChange >= 0 ? '+' : '') + changeData.pctChange.toFixed(1) + '%';
      let html = '<div class="change-indicator">';
      html += '<span class="change-pill ' + colorClass + '"><span class="arrow">' + trend.arrow + '</span> ' + changeText + ' YoY</span>';
      // Secondary momentum indicator (if available)
      if (momentumData) {
        const momChange = momentumData.pctChange !== null ? momentumData.pctChange : momentumData.change;
        const momTrend = getTrendArrow(momChange);
        let momColorClass = momTrend.cls;
        if (invertColors) {
          if (momColorClass === 'positive') momColorClass = 'negative';
          else if (momColorClass === 'negative') momColorClass = 'positive';
        }
        let momText = momentumData.isPointChange
          ? (momentumData.change >= 0 ? '+' : '') + momentumData.change.toFixed(2) + ' pts'
          : (momentumData.pctChange >= 0 ? '+' : '') + momentumData.pctChange.toFixed(1) + '%';
        html += '<span class="change-secondary">' + momTrend.arrow + ' ' + momText + ' 30d</span>';
      }
      return html + '</div>';
    }

    function createChart(canvasId, labels, values, color, options) {
      options = options || {};
      const ctx = document.getElementById(canvasId);
      if (!ctx) return;
      if (charts[canvasId]) charts[canvasId].destroy();
      charts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            data: values,
            borderColor: color,
            backgroundColor: color + '20',
            borderWidth: 2,
            fill: true,
            pointRadius: 2,
            pointHoverRadius: 5,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              mode: 'index',
              intersect: false,
              displayColors: false,
              callbacks: {
                label: function(context) {
                  return (options.prefix || '') + context.parsed.y.toLocaleString(undefined, {
                    minimumFractionDigits: options.decimals || 2,
                    maximumFractionDigits: options.decimals || 2
                  }) + (options.suffix || '');
                }
              }
            }
          },
          scales: {
            x: { display: true, ticks: { maxRotation: 45, minRotation: 45, font: { size: 9 }, color: '#7f8c8d', maxTicksLimit: 5 }, grid: { display: false } },
            y: { display: true, ticks: { font: { size: 9 }, color: '#7f8c8d' }, grid: { color: '#ecf0f1' } }
          }
        }
      });
    }

    // Create chart with horizontal threshold line
    function createChartWithThreshold(canvasId, labels, values, color, thresholdValue, thresholdLabel, options) {
      options = options || {};
      const ctx = document.getElementById(canvasId);
      if (!ctx) return;
      if (charts[canvasId]) charts[canvasId].destroy();

      // Create threshold line data (same value for all points)
      const thresholdData = labels.map(() => thresholdValue);

      charts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Value',
              data: values,
              borderColor: color,
              backgroundColor: color + '20',
              borderWidth: 2,
              fill: true,
              pointRadius: 2,
              pointHoverRadius: 5,
              tension: 0.3
            },
            {
              label: thresholdLabel,
              data: thresholdData,
              borderColor: '#e74c3c',
              borderWidth: 2,
              borderDash: [5, 5],
              fill: false,
              pointRadius: 0,
              pointHoverRadius: 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true, position: 'bottom', labels: { font: { size: 9 }, boxWidth: 12, padding: 5 } },
            tooltip: {
              mode: 'index',
              intersect: false,
              displayColors: true,
              callbacks: {
                label: function(context) {
                  if (context.datasetIndex === 1) return thresholdLabel + ': ' + thresholdValue + (options.suffix || '');
                  return (options.prefix || '') + context.parsed.y.toLocaleString(undefined, {
                    minimumFractionDigits: options.decimals || 2,
                    maximumFractionDigits: options.decimals || 2
                  }) + (options.suffix || '');
                }
              }
            }
          },
          scales: {
            x: { display: true, ticks: { maxRotation: 45, minRotation: 45, font: { size: 9 }, color: '#7f8c8d', maxTicksLimit: 5 }, grid: { display: false } },
            y: { display: true, ticks: { font: { size: 9 }, color: '#7f8c8d' }, grid: { color: '#ecf0f1' } }
          }
        }
      });
    }

    function renderMetric(id, data, label, opts) {
      opts = opts || {};
      const el = document.getElementById(id);
      if (!el) return;
      if (!data || data.length === 0) {
        el.innerHTML = '<div class="value">--</div><div class="period">No data</div>';
        return;
      }
      const latest = data[data.length - 1];
      const val = opts.format ? opts.format(latest.value) : latest.value;
      const dateStr = opts.shortDate ? formatShortDate(latest.date) : formatDate(latest.date);
      const change = calcChange(data, opts.isPercent);
      const momentum = opts.hasMomentum ? calc30DayMomentum(data, opts.isPercent) : null;
      el.innerHTML = '<div class="value' + (opts.colorClass ? ' ' + opts.colorClass : '') + '">' + val + '</div><div class="period">' + dateStr + (opts.periodSuffix || '') + '</div>' + formatChangeIndicator(change, momentum, opts.invertColors);
    }

    // Render metric with 2019 baseline comparison
    function renderMetricWithBaseline(id, data, label, vs2019, opts) {
      opts = opts || {};
      const el = document.getElementById(id);
      if (!el) return;
      if (!data || data.length === 0) {
        el.innerHTML = '<div class="value">--</div><div class="period">No data</div>';
        return;
      }
      const latest = data[data.length - 1];
      const val = opts.format ? opts.format(latest.value) : latest.value;
      const dateStr = opts.shortDate ? formatShortDate(latest.date) : formatDate(latest.date);
      const change = calcChange(data, opts.isPercent);

      // Add 2019 baseline pill - uses standardized change-pill class
      let baselineBadge = '';
      if (vs2019 !== undefined && vs2019 !== null) {
        const colorClass = vs2019 >= 0 ? 'positive' : 'negative';
        const sign = vs2019 >= 0 ? '+' : '';
        const arrow = vs2019 >= 0 ? '‚Üë' : '‚Üì';
        baselineBadge = `<span class="change-pill ${colorClass}"><span class="arrow">${arrow}</span> ${sign}${vs2019.toFixed(0)}% vs 2019</span>`;
      }

      // Combine YoY change and 2019 baseline in same indicator row
      let indicatorHtml = formatChangeIndicator(change, null, opts.invertColors);
      if (baselineBadge) {
        // Insert baseline badge into the change-indicator div
        indicatorHtml = indicatorHtml.replace('</div>', baselineBadge + '</div>');
      }
      el.innerHTML = '<div class="value">' + val + '</div><div class="period">' + dateStr + '</div>' + indicatorHtml;
    }

    // Create chart with ski season shading (Nov-Apr highlighted)
    function createChartWithSkiSeason(canvasId, data, color) {
      const ctx = document.getElementById(canvasId);
      if (!ctx) return;

      const labels = data.map(d => formatDate(d.date));
      const values = data.map(d => d.value);

      // Build ski season bands (Nov-Apr for each winter)
      // Group consecutive ski season months into bands
      const skiSeasonBands = [];
      let currentBand = null;

      data.forEach((d, i) => {
        const month = new Date(d.date).getMonth(); // 0-indexed
        const isSkiSeason = (month >= 10 || month <= 3); // Nov(10)-Apr(3)

        if (isSkiSeason) {
          if (currentBand === null) {
            currentBand = { start: i, end: i };
          } else {
            currentBand.end = i;
          }
        } else {
          if (currentBand !== null) {
            skiSeasonBands.push(currentBand);
            currentBand = null;
          }
        }
      });
      // Don't forget the last band if data ends in ski season
      if (currentBand !== null) {
        skiSeasonBands.push(currentBand);
      }

      // Create annotation objects for each band
      const annotations = {};
      skiSeasonBands.forEach((band, idx) => {
        annotations['skiSeason' + idx] = {
          type: 'box',
          xMin: band.start - 0.5,
          xMax: band.end + 0.5,
          backgroundColor: 'rgba(52, 152, 219, 0.08)',
          borderWidth: 0
        };
      });

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Passengers',
            data: values,
            borderColor: color,
            backgroundColor: color + '33',
            borderWidth: 2,
            fill: true,
            tension: 0.3,
            pointRadius: 0,
            pointHoverRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            annotation: { annotations: annotations }
          },
          scales: {
            x: { display: true, ticks: { maxRotation: 45, minRotation: 45, font: { size: 9 }, maxTicksLimit: 6 }, grid: { display: false } },
            y: { display: true, ticks: { font: { size: 9 }, callback: v => (v/1000).toFixed(0) + 'K' }, grid: { color: '#ecf0f1' } }
          }
        }
      });
    }

    // Create dual-axis chart for border crossings with CAD/USD overlay
    function createChartWithDualAxis(canvasId, borderData, cadData, borderColor, cadColor) {
      const ctx = document.getElementById(canvasId);
      if (!ctx) return;

      const labels = borderData.map(d => formatDate(d.date));
      const borderValues = borderData.map(d => d.value);

      // Match CAD data to border data dates if available
      let cadValues = [];
      if (cadData && cadData.length > 0) {
        const cadMap = {};
        cadData.forEach(d => { cadMap[d.date.substring(0, 7)] = d.value; });
        cadValues = borderData.map(d => cadMap[d.date.substring(0, 7)] || null);
      }

      const datasets = [{
        label: 'Border Crossings',
        data: borderValues,
        borderColor: borderColor,
        backgroundColor: borderColor + '33',
        borderWidth: 2,
        fill: true,
        tension: 0.3,
        pointRadius: 0,
        yAxisID: 'y'
      }];

      if (cadValues.some(v => v !== null)) {
        datasets.push({
          label: 'CAD/USD',
          data: cadValues,
          borderColor: cadColor,
          borderWidth: 2,
          borderDash: [4, 4],
          fill: false,
          tension: 0.3,
          pointRadius: 0,
          yAxisID: 'y1'
        });
      }

      new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: { legend: { display: true, position: 'bottom', labels: { font: { size: 9 }, boxWidth: 12 } } },
          scales: {
            x: { display: true, ticks: { maxRotation: 45, font: { size: 9 }, maxTicksLimit: 8 }, grid: { display: false } },
            y: { type: 'linear', display: true, position: 'left', ticks: { font: { size: 9 }, callback: v => (v/1000000).toFixed(1) + 'M' }, grid: { color: '#ecf0f1' } },
            y1: { type: 'linear', display: cadValues.some(v => v !== null), position: 'right', ticks: { font: { size: 9 } }, grid: { display: false } }
          }
        }
      });
    }

    // Render Canadian outbound travel by province
    function renderCanadianOutbound(outboundData) {
      const grid = document.getElementById('canadian-outbound-grid');
      if (!grid || !outboundData) {
        if (grid) grid.innerHTML = '<div class="metric-card"><div class="value">--</div><div class="period">Data unavailable</div></div>';
        return;
      }

      const provinces = ['alberta', 'british_columbia', 'ontario', 'quebec'];

      grid.innerHTML = provinces.map(key => {
        const prov = outboundData[key];
        if (!prov) return '';

        const vs2019 = prov.vs_2019;
        const colorClass = vs2019 >= 0 ? 'positive' : 'negative';
        const sign = vs2019 >= 0 ? '+' : '';
        const arrow = vs2019 >= 0 ? '‚Üë' : '‚Üì';
        const vs2019Badge = vs2019 !== null ? `<div class="change-indicator"><span class="change-pill ${colorClass}"><span class="arrow">${arrow}</span> ${sign}${vs2019.toFixed(0)}% vs 2019</span></div>` : '';

        return `
          <div class="metric-card" style="padding: 16px;">
            <h4 style="font-size: 1.1em; margin-bottom: 4px;">${prov.name} <span class="tooltip-icon" title="Primary US ski destinations: ${prov.feeder_for}">‚ìò</span></h4>
            <div class="value" style="font-size: 1.8em; font-weight: 700; color: #2c3e50;">${prov.latest.toLocaleString()}K visits</div>
            <div class="period" style="color: #7f8c8d;">${prov.latest_date} (quarterly)</div>
            ${vs2019Badge}
            <div style="font-size: 0.85em; color: #7f8c8d; margin-top: 8px;">‚Üí ${prov.feeder_for}</div>
          </div>
        `;
      }).join('');
    }

    // Render border ports dynamically with resort tags
    function renderBorderPorts(portsData) {
      const grid = document.getElementById('border-ports-grid');
      if (!grid || !portsData) {
        if (grid) grid.innerHTML = '<div class="metric-card"><div class="value">--</div><div class="period">Data unavailable</div></div>';
        return;
      }

      const portNames = {
        sweetgrass: 'Sweetgrass, MT',
        roosville: 'Roosville, MT',
        derby_line: 'Derby Line, VT',
        highgate_springs: 'Highgate Springs, VT',
        blaine: 'Blaine, WA',
        sumas: 'Sumas, WA',
        champlain: 'Champlain, NY',
        houlton: 'Houlton, ME',
        calais: 'Calais, ME',
        piegan: 'Piegan, MT'
      };

      grid.innerHTML = Object.entries(portsData).map(([key, port]) => {
        if (!port.data || port.data.length === 0) return '';

        const latest = port.data[port.data.length - 1];
        const vs2019 = port.vs_2019;
        const colorClass = vs2019 >= 0 ? 'positive' : 'negative';
        const sign = vs2019 >= 0 ? '+' : '';
        const arrow = vs2019 >= 0 ? '‚Üë' : '‚Üì';
        const vs2019Badge = vs2019 !== null ? `<div class="change-indicator"><span class="change-pill ${colorClass}"><span class="arrow">${arrow}</span> ${sign}${vs2019.toFixed(0)}% vs 2019</span></div>` : '';

        return `
          <div class="metric-card" style="padding: 18px;">
            <h4 style="font-size: 1.15em; margin-bottom: 6px; color: #2c3e50;">${portNames[key] || key}</h4>
            <div class="value" style="font-size: 2.2em; font-weight: 700; color: #2c3e50; line-height: 1.1;">${latest.value.toLocaleString()}</div>
            <div class="period" style="color: #7f8c8d; font-size: 0.85em;">${formatDate(latest.date)} (passengers)</div>
            ${vs2019Badge}
            <div class="resort-tag" style="font-size: 0.9em; color: #059669; margin-top: 12px; font-weight: 500;">‚õ∑Ô∏è ${port.resorts}</div>
            <div style="font-size: 0.8em; color: #7f8c8d; font-style: italic;">${port.route}</div>
          </div>
        `;
      }).join('');
    }

    async function loadDashboard() {
      try {
        const response = await fetch("/data/dashboard.json");
        const data = await response.json();
        document.getElementById("last-update").textContent = new Date(data.updated).toLocaleString();

        // Economic Indicators
        renderMetric('gdp', data.gdp, 'GDP', { format: v => '$' + Number(v).toLocaleString() + 'B' });
        if (data.gdp && data.gdp.length > 0) createChart('chart-gdp', data.gdp.map(d => formatDate(d.date)), data.gdp.map(d => d.value), '#2ecc71', { prefix: '$', suffix: 'B', decimals: 0 });

        renderMetric('consumer-confidence', data.consumer_confidence, 'CC', { format: v => Number(v).toFixed(1) });
        if (data.consumer_confidence && data.consumer_confidence.length > 0) createChart('chart-cc', data.consumer_confidence.map(d => formatDate(d.date)), data.consumer_confidence.map(d => d.value), '#3498db', { decimals: 1 });

        renderMetric('cpi', data.cpi, 'CPI', { format: v => Number(v).toFixed(1) });
        if (data.cpi && data.cpi.length > 0) createChart('chart-cpi', data.cpi.map(d => formatDate(d.date)), data.cpi.map(d => d.value), '#9b59b6', { decimals: 1 });

        renderMetric('unemployment', data.unemployment, 'Unemployment', { format: v => Number(v).toFixed(1) + '%', isPercent: true, invertColors: true });
        if (data.unemployment && data.unemployment.length > 0) createChart('chart-unemp', data.unemployment.map(d => formatDate(d.date)), data.unemployment.map(d => d.value), '#f39c12', { suffix: '%', decimals: 1 });

        renderMetric('employment', data.employment, 'Employment', { format: v => Number(v).toLocaleString() });
        if (data.employment && data.employment.length > 0) createChart('chart-emp', data.employment.map(d => formatDate(d.date)), data.employment.map(d => d.value), '#1abc9c', { suffix: 'K', decimals: 0 });

        renderMetric('wages', data.wages, 'Wages', { format: v => '$' + Number(v).toFixed(2) });
        if (data.wages && data.wages.length > 0) createChart('chart-wages', data.wages.map(d => formatDate(d.date)), data.wages.map(d => d.value), '#16a085', { prefix: '$', decimals: 2 });

        renderMetric('housing', data.housing_starts, 'Housing', { format: v => Number(v).toLocaleString() });
        if (data.housing_starts && data.housing_starts.length > 0) createChart('chart-housing', data.housing_starts.map(d => formatDate(d.date)), data.housing_starts.map(d => d.value), '#8e44ad', { suffix: 'K', decimals: 0 });

        renderMetric('bankruptcy', data.bankruptcy_ppi, 'Bankruptcy', { format: v => Number(v).toFixed(1) });
        if (data.bankruptcy_ppi && data.bankruptcy_ppi.length > 0) createChart('chart-bankruptcy', data.bankruptcy_ppi.map(d => formatDate(d.date)), data.bankruptcy_ppi.map(d => d.value), '#c0392b', { decimals: 1 });

        // Markets & Interest Rates
        if (data.markets) {
          const sp = data.markets.find(m => m.symbol === "SPY");
          if (sp) {
            const spData = sp.history ? sp.history.map(h => ({value: h.close, date: h.date})) : [];
            renderMetric('sp500', spData, 'S&P 500', { format: v => Number(v).toLocaleString(undefined, {minimumFractionDigits: 2}), colorClass: 'positive', shortDate: true });
            if (sp.history && sp.history.length > 0) createChart('chart-spy', sp.history.map(d => formatShortDate(d.date)), sp.history.map(d => d.close), '#27ae60', { decimals: 2 });
          }
        } else {
          document.getElementById('sp500').innerHTML = '<div class="value">--</div><div class="period">No data</div>';
        }

        // Dow Jones Industrial Average
        renderMetric('djia', data.djia, 'DJIA', { format: v => Number(v).toLocaleString(undefined, {minimumFractionDigits: 2}), hasMomentum: true, shortDate: true });
        if (data.djia && data.djia.length > 0) createChart('chart-djia', data.djia.map(d => formatShortDate(d.date)), data.djia.map(d => d.value), '#2980b9', { decimals: 0 });

        // NASDAQ Composite
        renderMetric('nasdaq', data.nasdaq, 'NASDAQ', { format: v => Number(v).toLocaleString(undefined, {minimumFractionDigits: 2}), hasMomentum: true, shortDate: true });
        if (data.nasdaq && data.nasdaq.length > 0) createChart('chart-nasdaq', data.nasdaq.map(d => formatShortDate(d.date)), data.nasdaq.map(d => d.value), '#8e44ad', { decimals: 0 });

        // Hotel & Lodging REITs
        renderMetric('hotel-reits', data.hotel_reits, 'Hotel REITs', { format: v => Number(v).toFixed(2), hasMomentum: true, shortDate: true });
        if (data.hotel_reits && data.hotel_reits.length > 0) createChart('chart-hotel', data.hotel_reits.map(d => formatShortDate(d.date)), data.hotel_reits.map(d => d.value), '#e67e22', { decimals: 2 });

        renderMetric('fed-rate', data.fed_funds_rate, 'Fed Rate', { format: v => Number(v).toFixed(2) + '%', isPercent: true, hasMomentum: true, shortDate: true, colorClass: 'neutral' });
        if (data.fed_funds_rate && data.fed_funds_rate.length > 0) createChart('chart-fed', data.fed_funds_rate.map(d => formatShortDate(d.date)), data.fed_funds_rate.map(d => d.value), '#e74c3c', { suffix: '%', decimals: 2 });

        renderMetric('treasury', data.treasury_10y, 'Treasury', { format: v => Number(v).toFixed(2) + '%', isPercent: true, hasMomentum: true, shortDate: true, colorClass: 'neutral' });
        if (data.treasury_10y && data.treasury_10y.length > 0) createChart('chart-treasury', data.treasury_10y.map(d => formatShortDate(d.date)), data.treasury_10y.map(d => d.value), '#c0392b', { suffix: '%', decimals: 2 });

        // Magnificent 7 Stocks
        if (data.mag7 && data.mag7.length > 0) {
          const mag7Grid = document.getElementById('mag7-grid');
          const stockColors = { 'AAPL': '#555555', 'MSFT': '#00a4ef', 'GOOGL': '#4285f4', 'AMZN': '#ff9900', 'NVDA': '#76b900', 'META': '#0866ff', 'TSLA': '#cc0000' };
          mag7Grid.innerHTML = data.mag7.map(stock => {
            const change = stock.previousClose ? ((stock.price - stock.previousClose) / stock.previousClose * 100) : 0;
            const changeClass = change >= 0 ? 'positive' : 'negative';
            const changeArrow = change >= 0 ? '‚Üë' : '‚Üì';
            return '<div class="metric-card">' +
              '<h4>' + stock.name.replace(' Inc.', '').replace(' Platforms', '').replace(', Inc.', '').replace(' Corp', '') + ' (' + stock.symbol + ')</h4>' +
              '<div class="value">$' + stock.price.toFixed(2) + '</div>' +
              '<div class="period"><span class="' + changeClass + '">' + changeArrow + ' ' + Math.abs(change).toFixed(2) + '%</span> today</div>' +
              '<div class="chart-container"><canvas id="chart-' + stock.symbol.toLowerCase() + '"></canvas></div>' +
              '</div>';
          }).join('');
          // Create mini charts for each stock
          data.mag7.forEach(stock => {
            if (stock.history && stock.history.length > 0) {
              createChart('chart-' + stock.symbol.toLowerCase(),
                stock.history.map(h => formatShortDate(h.date)),
                stock.history.map(h => h.value),
                stockColors[stock.symbol] || '#3498db',
                { decimals: 2, prefix: '$' }
              );
            }
          });
        } else {
          document.getElementById('mag7-grid').innerHTML = '<div class="metric-card"><div class="value">--</div><div class="period">Stock data unavailable</div></div>';
        }

        // ==================== CURRENCY & VISITOR PURCHASING POWER ====================

        // Helper: Convert rate to visitor purchasing power (100 foreign currency -> USD)
        function toPurchasingPower(rateData, multiplier = 100) {
          if (!rateData) return null;
          return rateData.map(d => ({ date: d.date, value: multiplier / d.value }));
        }

        // Helper: Cross-rate to CAD (for Canadian resort view)
        function toCadPurchasingPower(foreignData, cadData, multiplier = 100) {
          if (!foreignData || !cadData) return null;
          return foreignData.map((d, i) => {
            const cadRate = cadData[i] ? cadData[i].value : cadData[cadData.length - 1].value;
            return { date: d.date, value: (multiplier / d.value) * cadRate };
          });
        }

        // Helper: Get threshold color for US resort perspective (higher PP = better)
        function getUsThresholdColor(currency, ppValue) {
          const thresholds = {
            'CAD': { favorable: 80, unfavorable: 70 },  // $80+ per 100 CAD is good
            'MXN': { favorable: 5.5, unfavorable: 5.0 },
            'EUR': { favorable: 110, unfavorable: 100 },
            'GBP': { favorable: 130, unfavorable: 120 },
            'BRL': { favorable: 22, unfavorable: 18 },
            'AUD': { favorable: 70, unfavorable: 62 }
          };
          const t = thresholds[currency];
          if (!t) return '#3498db';
          if (ppValue >= t.favorable) return '#2E7D32';  // Green - favorable
          if (ppValue <= t.unfavorable) return '#C62828'; // Red - unfavorable
          return '#757575'; // Gray - neutral
        }

        // Helper: Get Canadian domestic retention status
        function getCaRetentionStatus(usdCadRate) {
          if (usdCadRate >= 1.40) return { status: 'Strong Retention', color: '#2E7D32', note: 'USD expensive for Canadians - they stay home' };
          if (usdCadRate <= 1.25) return { status: 'Weak Retention', color: '#C62828', note: 'USD cheap - Canadians may ski in US' };
          return { status: 'Neutral', color: '#757575', note: 'Normal range' };
        }

        // ===== US RESORT PERSPECTIVE =====
        const ppCad = toPurchasingPower(data.usd_cad);
        const ppMxn = toPurchasingPower(data.usd_mxn);
        const ppEur = toPurchasingPower(data.usd_eur);
        const ppGbp = toPurchasingPower(data.usd_gbp);
        const ppBrl = toPurchasingPower(data.usd_brl);
        const ppAud = toPurchasingPower(data.usd_aud);

        // Render US resort view metrics
        if (ppCad) {
          const latestPP = ppCad[ppCad.length - 1].value;
          const color = getUsThresholdColor('CAD', latestPP);
          renderMetric('pp-cad', ppCad, '100 CAD', { format: v => '$' + Number(v).toFixed(2) + ' USD', hasMomentum: true, shortDate: true, invertColors: true });
          createChart('chart-pp-cad', ppCad.map(d => formatShortDate(d.date)), ppCad.map(d => d.value), color, { decimals: 2, prefix: '$' });
        }
        if (ppMxn) {
          const latestPP = ppMxn[ppMxn.length - 1].value;
          const color = getUsThresholdColor('MXN', latestPP);
          renderMetric('pp-mxn', ppMxn, '100 MXN', { format: v => '$' + Number(v).toFixed(2) + ' USD', hasMomentum: true, shortDate: true, invertColors: true });
          createChart('chart-pp-mxn', ppMxn.map(d => formatShortDate(d.date)), ppMxn.map(d => d.value), color, { decimals: 2, prefix: '$' });
        }
        if (ppEur) {
          const latestPP = ppEur[ppEur.length - 1].value;
          const color = getUsThresholdColor('EUR', latestPP);
          renderMetric('pp-eur', ppEur, '100 EUR', { format: v => '$' + Number(v).toFixed(2) + ' USD', hasMomentum: true, shortDate: true, invertColors: true });
          createChart('chart-pp-eur', ppEur.map(d => formatShortDate(d.date)), ppEur.map(d => d.value), color, { decimals: 2, prefix: '$' });
        }
        if (ppGbp) {
          const latestPP = ppGbp[ppGbp.length - 1].value;
          const color = getUsThresholdColor('GBP', latestPP);
          renderMetric('pp-gbp', ppGbp, '100 GBP', { format: v => '$' + Number(v).toFixed(2) + ' USD', hasMomentum: true, shortDate: true, invertColors: true });
          createChart('chart-pp-gbp', ppGbp.map(d => formatShortDate(d.date)), ppGbp.map(d => d.value), color, { decimals: 2, prefix: '$' });
        }
        if (ppBrl) {
          const latestPP = ppBrl[ppBrl.length - 1].value;
          const color = getUsThresholdColor('BRL', latestPP);
          renderMetric('pp-brl', ppBrl, '100 BRL', { format: v => '$' + Number(v).toFixed(2) + ' USD', hasMomentum: true, shortDate: true, invertColors: true });
          createChart('chart-pp-brl', ppBrl.map(d => formatShortDate(d.date)), ppBrl.map(d => d.value), color, { decimals: 2, prefix: '$' });
        }
        if (ppAud) {
          const latestPP = ppAud[ppAud.length - 1].value;
          const color = getUsThresholdColor('AUD', latestPP);
          renderMetric('pp-aud', ppAud, '100 AUD', { format: v => '$' + Number(v).toFixed(2) + ' USD', hasMomentum: true, shortDate: true, invertColors: true });
          createChart('chart-pp-aud', ppAud.map(d => formatShortDate(d.date)), ppAud.map(d => d.value), color, { decimals: 2, prefix: '$' });
        }

        // ===== CANADIAN RESORT PERSPECTIVE =====
        // $100 USD buys X CAD
        if (data.usd_cad) {
          const usdToCad = data.usd_cad.map(d => ({ date: d.date, value: 100 * d.value }));
          const latestRate = data.usd_cad[data.usd_cad.length - 1].value;
          const cadColor = latestRate >= 1.35 ? '#2E7D32' : (latestRate <= 1.28 ? '#C62828' : '#757575');
          renderMetric('pp-usd-cad', usdToCad, '$100 USD', { format: v => 'C$' + Number(v).toFixed(2), hasMomentum: true, shortDate: true, invertColors: true });
          createChart('chart-pp-usd-cad', usdToCad.map(d => formatShortDate(d.date)), usdToCad.map(d => d.value), cadColor, { decimals: 2, prefix: 'C$' });

          // Domestic retention indicator
          const retention = getCaRetentionStatus(latestRate);
          document.getElementById('ca-retention').innerHTML =
            '<div class="value" style="color: ' + retention.color + ';">' + retention.status + '</div>' +
            '<div class="period">USD/CAD: ' + latestRate.toFixed(4) + '</div>' +
            '<div style="font-size: 0.8em; color: #7f8c8d; margin-top: 5px;">' + retention.note + '</div>';
          createChart('chart-ca-retention', data.usd_cad.map(d => formatShortDate(d.date)), data.usd_cad.map(d => d.value), retention.color, { decimals: 4 });
        }

        // EUR/GBP cross-rate to CAD for Canadian resorts
        const ppEurCad = toCadPurchasingPower(data.usd_eur, data.usd_cad);
        const ppGbpCad = toCadPurchasingPower(data.usd_gbp, data.usd_cad);
        if (ppEurCad) {
          renderMetric('pp-eur-cad', ppEurCad, '100 EUR', { format: v => 'C$' + Number(v).toFixed(2), hasMomentum: true, shortDate: true, invertColors: true });
          createChart('chart-pp-eur-cad', ppEurCad.map(d => formatShortDate(d.date)), ppEurCad.map(d => d.value), '#3498db', { decimals: 2, prefix: 'C$' });
        }
        if (ppGbpCad) {
          renderMetric('pp-gbp-cad', ppGbpCad, '100 GBP', { format: v => 'C$' + Number(v).toFixed(2), hasMomentum: true, shortDate: true, invertColors: true });
          createChart('chart-pp-gbp-cad', ppGbpCad.map(d => formatShortDate(d.date)), ppGbpCad.map(d => d.value), '#1a5276', { decimals: 2, prefix: 'C$' });
        }

        // ===== LUXURY FEEDER MARKETS =====
        const ppHkd = toPurchasingPower(data.usd_hkd);
        const ppSgd = toPurchasingPower(data.usd_sgd);
        const ppAed = toPurchasingPower(data.usd_aed);
        const ppCny = toPurchasingPower(data.usd_cny);
        const ppJpy = toPurchasingPower(data.usd_jpy);
        const ppInr = toPurchasingPower(data.usd_inr);
        const ppRub = toPurchasingPower(data.usd_rub);

        if (ppHkd) {
          renderMetric('pp-hkd', ppHkd, '100 HKD', { format: v => '$' + Number(v).toFixed(2) + ' USD', hasMomentum: true, shortDate: true, invertColors: true });
          createChart('chart-pp-hkd', ppHkd.map(d => formatShortDate(d.date)), ppHkd.map(d => d.value), '#9b59b6', { decimals: 2, prefix: '$' });
        }
        if (ppSgd) {
          renderMetric('pp-sgd', ppSgd, '100 SGD', { format: v => '$' + Number(v).toFixed(2) + ' USD', hasMomentum: true, shortDate: true, invertColors: true });
          createChart('chart-pp-sgd', ppSgd.map(d => formatShortDate(d.date)), ppSgd.map(d => d.value), '#8e44ad', { decimals: 2, prefix: '$' });
        }
        if (ppAed) {
          renderMetric('pp-aed', ppAed, '100 AED', { format: v => '$' + Number(v).toFixed(2) + ' USD', shortDate: true });
          createChart('chart-pp-aed', ppAed.map(d => formatShortDate(d.date)), ppAed.map(d => d.value), '#27ae60', { decimals: 2, prefix: '$' });
        }
        if (ppCny) {
          renderMetric('pp-cny', ppCny, '100 CNY', { format: v => '$' + Number(v).toFixed(2) + ' USD', hasMomentum: true, shortDate: true, invertColors: true });
          createChart('chart-pp-cny', ppCny.map(d => formatShortDate(d.date)), ppCny.map(d => d.value), '#c0392b', { decimals: 2, prefix: '$' });
        }
        if (ppJpy) {
          renderMetric('pp-jpy', ppJpy, '100 JPY', { format: v => '$' + Number(v).toFixed(2) + ' USD', hasMomentum: true, shortDate: true, invertColors: true });
          createChart('chart-pp-jpy', ppJpy.map(d => formatShortDate(d.date)), ppJpy.map(d => d.value), '#e74c3c', { decimals: 2, prefix: '$' });
        }
        if (ppInr) {
          renderMetric('pp-inr', ppInr, '100 INR', { format: v => '$' + Number(v).toFixed(2) + ' USD', hasMomentum: true, shortDate: true, invertColors: true });
          createChart('chart-pp-inr', ppInr.map(d => formatShortDate(d.date)), ppInr.map(d => d.value), '#e67e22', { decimals: 2, prefix: '$' });
        }
        if (ppRub) {
          renderMetric('pp-rub', ppRub, '100 RUB', { format: v => '$' + Number(v).toFixed(2) + ' USD', shortDate: true });
          createChart('chart-pp-rub', ppRub.map(d => formatShortDate(d.date)), ppRub.map(d => d.value), '#7f8c8d', { decimals: 2, prefix: '$' });
        }

        // ===== COMPETITIVE DESTINATION COMPARISON =====
        // Shows what $100 USD buys at each destination
        if (data.usd_cad) {
          const whistlerValue = data.usd_cad.map(d => ({ date: d.date, value: 100 * d.value }));
          renderMetric('comp-whistler', whistlerValue, 'Whistler', { format: v => 'C$' + Number(v).toFixed(0), hasMomentum: true, shortDate: true });
          createChart('chart-comp-whistler', whistlerValue.map(d => formatShortDate(d.date)), whistlerValue.map(d => d.value), '#e74c3c', { decimals: 0, prefix: 'C$' });
        }
        if (data.usd_eur) {
          const alpsEurValue = data.usd_eur.map(d => ({ date: d.date, value: 100 * d.value }));
          renderMetric('comp-alps-eur', alpsEurValue, 'Alps (EUR)', { format: v => '‚Ç¨' + Number(v).toFixed(0), hasMomentum: true, shortDate: true });
          createChart('chart-comp-alps-eur', alpsEurValue.map(d => formatShortDate(d.date)), alpsEurValue.map(d => d.value), '#3498db', { decimals: 0, prefix: '‚Ç¨' });
        }
        if (data.usd_chf) {
          const swissValue = data.usd_chf.map(d => ({ date: d.date, value: 100 * d.value }));
          renderMetric('comp-swiss', swissValue, 'Swiss', { format: v => 'CHF ' + Number(v).toFixed(0), hasMomentum: true, shortDate: true });
          createChart('chart-comp-swiss', swissValue.map(d => formatShortDate(d.date)), swissValue.map(d => d.value), '#c0392b', { decimals: 0, prefix: 'CHF ' });
        }
        if (data.usd_jpy) {
          const nisekoValue = data.usd_jpy.map(d => ({ date: d.date, value: 100 * d.value }));
          renderMetric('comp-niseko', nisekoValue, 'Niseko', { format: v => '¬•' + Number(v).toLocaleString(undefined, {maximumFractionDigits: 0}), hasMomentum: true, shortDate: true });
          createChart('chart-comp-niseko', nisekoValue.map(d => formatShortDate(d.date)), nisekoValue.map(d => d.value), '#9b59b6', { decimals: 0, prefix: '¬•' });
        }

        // ===== DOLLAR STRENGTH INDICES (Reference) =====
        renderMetric('trade-weighted', data.trade_weighted_usd, 'TW-USD', { format: v => Number(v).toFixed(2), hasMomentum: true, shortDate: true, periodSuffix: ' (index)' });
        if (data.trade_weighted_usd && data.trade_weighted_usd.length > 0) createChart('chart-tw', data.trade_weighted_usd.map(d => formatShortDate(d.date)), data.trade_weighted_usd.map(d => d.value), '#2c3e50', { decimals: 2 });

        renderMetric('real-trade-weighted', data.real_trade_weighted_usd, 'Real TW-USD', { format: v => Number(v).toFixed(2), hasMomentum: true, shortDate: true, periodSuffix: ' (index)' });
        if (data.real_trade_weighted_usd && data.real_trade_weighted_usd.length > 0) createChart('chart-rtw', data.real_trade_weighted_usd.map(d => formatShortDate(d.date)), data.real_trade_weighted_usd.map(d => d.value), '#7f8c8d', { decimals: 2 });

        // Commodity Prices
        renderMetric('gold', data.gold, 'Gold', { format: v => '$' + Number(v).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}), hasMomentum: true, shortDate: true });
        if (data.gold && data.gold.length > 0) createChart('chart-gold', data.gold.map(d => formatShortDate(d.date)), data.gold.map(d => d.value), '#f1c40f', { prefix: '$', decimals: 2 });

        renderMetric('crude-oil', data.crude_oil, 'Oil', { format: v => '$' + Number(v).toFixed(2), hasMomentum: true, shortDate: true });
        if (data.crude_oil && data.crude_oil.length > 0) createChart('chart-oil', data.crude_oil.map(d => formatShortDate(d.date)), data.crude_oil.map(d => d.value), '#2c3e50', { prefix: '$', decimals: 2 });

        renderMetric('natural-gas', data.natural_gas, 'Gas', { format: v => '$' + Number(v).toFixed(2), hasMomentum: true, shortDate: true });
        if (data.natural_gas && data.natural_gas.length > 0) createChart('chart-gas', data.natural_gas.map(d => formatShortDate(d.date)), data.natural_gas.map(d => d.value), '#e67e22', { prefix: '$', decimals: 2 });

        renderMetric('copper', data.copper, 'Copper', { format: v => '$' + Number(v).toFixed(2), hasMomentum: true, shortDate: true });
        if (data.copper && data.copper.length > 0) createChart('chart-copper', data.copper.map(d => formatShortDate(d.date)), data.copper.map(d => d.value), '#d35400', { prefix: '$', decimals: 2 });

        // Electricity Pricing (State-Level from EIA - cents/kWh)
        renderMetric('elec-us', data.electricity_us, 'US Elec', { format: v => Number(v).toFixed(2) + '¬¢', periodSuffix: '/kWh' });
        if (data.electricity_us && data.electricity_us.length > 0) createChart('chart-elec-us', data.electricity_us.map(d => formatDate(d.date)), data.electricity_us.map(d => d.value), '#f39c12', { suffix: '¬¢', decimals: 2 });

        renderMetric('elec-co', data.electricity_co, 'CO Elec', { format: v => Number(v).toFixed(2) + '¬¢', periodSuffix: '/kWh' });
        if (data.electricity_co && data.electricity_co.length > 0) createChart('chart-elec-co', data.electricity_co.map(d => formatDate(d.date)), data.electricity_co.map(d => d.value), '#3498db', { suffix: '¬¢', decimals: 2 });

        renderMetric('elec-ut', data.electricity_ut, 'UT Elec', { format: v => Number(v).toFixed(2) + '¬¢', periodSuffix: '/kWh' });
        if (data.electricity_ut && data.electricity_ut.length > 0) createChart('chart-elec-ut', data.electricity_ut.map(d => formatDate(d.date)), data.electricity_ut.map(d => d.value), '#e67e22', { suffix: '¬¢', decimals: 2 });

        renderMetric('elec-ca', data.electricity_ca, 'CA Elec', { format: v => Number(v).toFixed(2) + '¬¢', periodSuffix: '/kWh' });
        if (data.electricity_ca && data.electricity_ca.length > 0) createChart('chart-elec-ca', data.electricity_ca.map(d => formatDate(d.date)), data.electricity_ca.map(d => d.value), '#9b59b6', { suffix: '¬¢', decimals: 2 });

        renderMetric('elec-vt', data.electricity_vt, 'VT Elec', { format: v => Number(v).toFixed(2) + '¬¢', periodSuffix: '/kWh' });
        if (data.electricity_vt && data.electricity_vt.length > 0) createChart('chart-elec-vt', data.electricity_vt.map(d => formatDate(d.date)), data.electricity_vt.map(d => d.value), '#27ae60', { suffix: '¬¢', decimals: 2 });

        renderMetric('elec-nh', data.electricity_nh, 'NH Elec', { format: v => Number(v).toFixed(2) + '¬¢', periodSuffix: '/kWh' });
        if (data.electricity_nh && data.electricity_nh.length > 0) createChart('chart-elec-nh', data.electricity_nh.map(d => formatDate(d.date)), data.electricity_nh.map(d => d.value), '#e74c3c', { suffix: '¬¢', decimals: 2 });

        renderMetric('elec-wa', data.electricity_wa, 'WA Elec', { format: v => Number(v).toFixed(2) + '¬¢', periodSuffix: '/kWh' });
        if (data.electricity_wa && data.electricity_wa.length > 0) createChart('chart-elec-wa', data.electricity_wa.map(d => formatDate(d.date)), data.electricity_wa.map(d => d.value), '#1abc9c', { suffix: '¬¢', decimals: 2 });

        renderMetric('elec-wy', data.electricity_wy, 'WY Elec', { format: v => Number(v).toFixed(2) + '¬¢', periodSuffix: '/kWh' });
        if (data.electricity_wy && data.electricity_wy.length > 0) createChart('chart-elec-wy', data.electricity_wy.map(d => formatDate(d.date)), data.electricity_wy.map(d => d.value), '#8e44ad', { suffix: '¬¢', decimals: 2 });

        // --- US/CANADA BORDER CROSSINGS ---
        const borderFormat = v => Number(v).toLocaleString() + ' passengers';

        // National totals with 2019 baseline badge
        renderMetric('border-national', data.border_national, 'Border', { format: borderFormat });

        // Display vs 2019 badge - HEADLINE metric for the section
        const vs2019Badge = document.getElementById('border-vs-2019-badge');
        if (vs2019Badge && data.border_national_vs_2019 !== undefined && data.border_national_vs_2019 !== null) {
          const vs2019 = data.border_national_vs_2019;
          const colorClass = vs2019 >= 0 ? 'positive' : 'negative';
          const sign = vs2019 >= 0 ? '+' : '';
          const arrow = vs2019 >= 0 ? '‚Üë' : '‚Üì';
          vs2019Badge.className = 'change-pill ' + colorClass;
          vs2019Badge.innerHTML = `<span class="arrow">${arrow}</span> ${sign}${vs2019.toFixed(1)}% vs 2019`;
          vs2019Badge.style.fontSize = '1.1em';
          vs2019Badge.style.padding = '6px 14px';
        }

        // Create chart with CAD/USD overlay if available
        if (data.border_national && data.border_national.length > 0) {
          createChartWithDualAxis('chart-border-national', data.border_national, data.cad, '#3498db', '#f39c12');
        }

        // Canadian outbound markets (StatCan)
        renderCanadianOutbound(data.canadian_outbound);

        // State-level (ski-relevant states) with ski season shading
        const stateBaselines = data.border_state_baselines || {};

        renderMetricWithBaseline('border-montana', data.border_montana, 'MT Border', stateBaselines.montana, { format: borderFormat });
        if (data.border_montana && data.border_montana.length > 0) createChartWithSkiSeason('chart-border-montana', data.border_montana, '#27ae60');

        renderMetricWithBaseline('border-vermont', data.border_vermont, 'VT Border', stateBaselines.vermont, { format: borderFormat });
        if (data.border_vermont && data.border_vermont.length > 0) createChartWithSkiSeason('chart-border-vermont', data.border_vermont, '#27ae60');

        renderMetricWithBaseline('border-washington', data.border_washington, 'WA Border', stateBaselines.washington, { format: borderFormat });
        if (data.border_washington && data.border_washington.length > 0) createChartWithSkiSeason('chart-border-washington', data.border_washington, '#27ae60');

        renderMetricWithBaseline('border-ny', data.border_new_york, 'NY Border', stateBaselines.new_york, { format: borderFormat });
        if (data.border_new_york && data.border_new_york.length > 0) createChartWithSkiSeason('chart-border-ny', data.border_new_york, '#27ae60');

        renderMetricWithBaseline('border-maine', data.border_maine, 'ME Border', stateBaselines.maine, { format: borderFormat });
        if (data.border_maine && data.border_maine.length > 0) createChartWithSkiSeason('chart-border-maine', data.border_maine, '#27ae60');

        renderMetricWithBaseline('border-idaho', data.border_idaho, 'ID Border', stateBaselines.idaho, { format: borderFormat });
        if (data.border_idaho && data.border_idaho.length > 0) createChartWithSkiSeason('chart-border-idaho', data.border_idaho, '#27ae60');

        // Render border ports dynamically with resort tags
        renderBorderPorts(data.border_ports);

        // --- AIR TRAVEL INDICATORS ---
        // Jet Fuel Price
        renderMetric('jet-fuel', data.jet_fuel, 'Jet Fuel', { format: v => '$' + Number(v).toFixed(2) + '/gal' });
        if (data.jet_fuel && data.jet_fuel.length > 0) createChart('chart-jet-fuel', data.jet_fuel.map(d => formatDate(d.date)), data.jet_fuel.map(d => d.value), '#e74c3c', { suffix: '', decimals: 2 });

        // National Enplanements (FRED data is in thousands, so divide by 1000 to get millions)
        renderMetric('enplanements', data.enplanements, 'Enplane', { format: v => (Number(v) / 1000).toFixed(1) + 'M passengers' });
        if (data.enplanements && data.enplanements.length > 0) createChart('chart-enplanements', data.enplanements.map(d => formatDate(d.date)), data.enplanements.map(d => d.value / 1000), '#3498db', { suffix: 'M', decimals: 1 });

        // Domestic Load Factor (85% threshold = capacity pressure indicator)
        renderMetric('load-factor', data.load_factor, 'Load', { format: v => Number(v).toFixed(1) + '%' });
        if (data.load_factor && data.load_factor.length > 0) createChartWithThreshold('chart-load-factor', data.load_factor.map(d => formatDate(d.date)), data.load_factor.map(d => d.value), '#9b59b6', 85, '85% Threshold', { suffix: '%', decimals: 1 });

        // T-100 Passengers
        renderMetric('t100-passengers', data.t100_passengers, 'T-100', { format: v => (Number(v) / 1000000).toFixed(1) + 'M passengers' });
        if (data.t100_passengers && data.t100_passengers.length > 0) createChart('chart-t100', data.t100_passengers.map(d => formatDate(d.date)), data.t100_passengers.map(d => d.value / 1000000), '#3498db', { suffix: 'M', decimals: 1 });

        // TSA Checkpoint (daily data - use 7-day rolling average to smooth volatility)
        if (data.tsa_checkpoint && data.tsa_checkpoint.length > 0) {
          // Calculate 7-day rolling average
          const tsa7dayAvg = data.tsa_checkpoint.slice(0, 7).reduce((sum, d) => sum + d.value, 0) / Math.min(7, data.tsa_checkpoint.length);
          renderMetric('tsa-checkpoint', data.tsa_checkpoint, 'TSA', {
            format: v => (tsa7dayAvg / 1000000).toFixed(2) + 'M/day (7d avg)',
            customValue: tsa7dayAvg
          });
          createChart('chart-tsa', data.tsa_checkpoint.map(d => formatDate(d.date)), data.tsa_checkpoint.map(d => d.value / 1000000), '#27ae60', { suffix: 'M', decimals: 2 });
        }

        // --- SKI GATEWAY AIRPORTS ---
        if (data.ski_gateway_airports && data.ski_gateway_airports.length > 0) {
          window.skiAirportsData = data.ski_gateway_airports;
          renderSkiAirports('all');
        }

      } catch (error) {
        console.error("Failed to load dashboard:", error);
        document.getElementById("last-update").textContent = "Error loading data";
      }
    }

    // Ski Gateway Airports rendering
    function renderSkiAirports(region) {
      const grid = document.getElementById('ski-airports-grid');
      if (!grid || !window.skiAirportsData) return;

      const airports = region === 'all'
        ? window.skiAirportsData
        : window.skiAirportsData.filter(a => a.region === region);

      if (airports.length === 0) {
        grid.innerHTML = '<p style="color: #7f8c8d; font-style: italic;">No airports found for this region.</p>';
        return;
      }

      grid.innerHTML = airports.map(apt => {
        const paxFormatted = apt.passengers >= 1000000
          ? (apt.passengers / 1000000).toFixed(1) + 'M'
          : (apt.passengers / 1000).toFixed(0) + 'K';

        const yoyHtml = apt.yoy_change !== null
          ? '<div class="change-indicator"><span class="change-pill ' + (apt.yoy_change >= 0 ? 'positive' : 'negative') + '">' +
            '<span class="arrow">' + (apt.yoy_change >= 0 ? '‚Üë' : '‚Üì') + '</span> ' + (apt.yoy_change >= 0 ? '+' : '') + apt.yoy_change.toFixed(1) + '% YoY</span></div>'
          : '';

        return '<div class="metric-card ski-airport-card" data-region="' + apt.region + '">' +
          '<h4>' + apt.city + ' <span class="airport-code">(' + apt.code + ')</span></h4>' +
          '<div class="value">' + paxFormatted + '</div>' +
          '<div class="period">' + apt.year + ' passengers</div>' +
          yoyHtml +
          '<div class="resort-tag">‚ú± ' + apt.resorts + '</div>' +
          '</div>';
      }).join('');
    }

    function filterSkiAirports(region) {
      // Update active button
      document.querySelectorAll('.region-filter').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.region === region);
      });
      renderSkiAirports(region);
    }

    loadDashboard();
    setInterval(loadDashboard, 300000);

    // Prediction Markets
    async function loadPredictionMarkets() {
      try {
        const response = await fetch("/data/prediction-markets.json");
        const data = await response.json();

        // Render Inflation Distribution
        if (data.inflation && data.inflation.markets) {
          const inf = data.inflation;
          const el = document.getElementById('inflation-consensus');
          if (el) {
            el.innerHTML = '<div class="consensus-value">' + inf.consensus_strike + '%</div>' +
              '<div class="consensus-label">Market consensus: ' + Math.round(inf.consensus_probability * 100) + '% probability inflation stays below ' + inf.consensus_strike + '%</div>';
          }

          // Create distribution bar chart
          const ctx = document.getElementById('chart-inflation-dist');
          if (ctx) {
            if (charts['chart-inflation-dist']) charts['chart-inflation-dist'].destroy();
            charts['chart-inflation-dist'] = new Chart(ctx, {
              type: 'bar',
              data: {
                labels: inf.markets.map(m => m.strike + '%'),
                datasets: [{
                  label: 'Market Price',
                  data: inf.markets.map(m => m.yes_bid * 100),
                  backgroundColor: inf.markets.map(m => m.strike === inf.consensus_strike ? '#3498db' : '#bdc3c7'),
                  borderRadius: 4
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: { display: false },
                  tooltip: {
                    callbacks: {
                      label: function(ctx) {
                        return 'Prob above ' + inf.markets[ctx.dataIndex].strike + '%: ' + ctx.parsed.y.toFixed(0) + '%';
                      },
                      afterLabel: function(ctx) {
                        return 'Volume: ' + inf.markets[ctx.dataIndex].volume.toLocaleString();
                      }
                    }
                  }
                },
                scales: {
                  x: { grid: { display: false }, ticks: { font: { size: 9 }, maxRotation: 45 } },
                  y: { max: 100, ticks: { callback: v => v + '%', font: { size: 9 } }, grid: { color: '#ecf0f1' } }
                }
              }
            });
          }

          const meta = document.getElementById('inflation-meta');
          if (meta) {
            meta.textContent = 'Total volume: ' + inf.total_volume.toLocaleString() + ' contracts';
          }
        }

        // Render Payrolls - show most liquid month with meaningful framing
        if (data.payrolls && data.payrolls.months && data.payrolls.months.length > 0) {
          const pay = data.payrolls;
          // Months are already sorted by volume (most liquid first)
          const topMonth = pay.months[0];
          const el = document.getElementById('payrolls-consensus');
          const monthLabel = topMonth.month.replace(/(\d{2})(\w+)/, (_, y, m) => m + ' 20' + y);

          if (el) {
            // Show probability of job losses as the key metric (more meaningful for economic health)
            const probLoss = topMonth.prob_job_loss || 0;
            const probPositive = topMonth.prob_positive || 0;
            const probStrong = topMonth.prob_strong || 0;

            // Color code based on job loss probability
            let riskClass = 'positive';
            let riskLabel = 'Low Risk';
            if (probLoss >= 50) { riskClass = 'negative'; riskLabel = 'High Risk'; }
            else if (probLoss >= 30) { riskClass = 'neutral'; riskLabel = 'Moderate Risk'; }

            el.innerHTML = '<div class="consensus-value ' + riskClass + '">' + probLoss.toFixed(0) + '%</div>' +
              '<div class="consensus-label">Probability of job losses in ' + monthLabel + '</div>' +
              '<div style="margin-top:8px; font-size:0.8em; color:#7f8c8d;">' +
              '<span style="margin-right:12px;">Positive growth: ' + probPositive.toFixed(0) + '%</span>' +
              '<span>Strong (+100K): ' + probStrong.toFixed(0) + '%</span></div>';
          }

          // Create payrolls probability curve
          const ctx = document.getElementById('chart-payrolls');
          if (ctx) {
            if (charts['chart-payrolls']) charts['chart-payrolls'].destroy();
            charts['chart-payrolls'] = new Chart(ctx, {
              type: 'line',
              data: {
                labels: topMonth.markets.map(m => (m.strike / 1000) + 'K'),
                datasets: [{
                  label: 'P(Above)',
                  data: topMonth.markets.map(m => m.yes_bid * 100),
                  borderColor: '#3498db',
                  backgroundColor: 'rgba(52, 152, 219, 0.1)',
                  fill: true,
                  tension: 0.4,
                  pointRadius: 3,
                  pointHoverRadius: 6
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: { display: false },
                  tooltip: {
                    callbacks: {
                      label: function(ctx) {
                        const strike = topMonth.markets[ctx.dataIndex].strike;
                        const label = strike === 0 ? 'Prob of positive growth' : 'Prob > ' + strike.toLocaleString() + ' jobs';
                        return label + ': ' + ctx.parsed.y.toFixed(0) + '%';
                      }
                    }
                  }
                },
                scales: {
                  x: { grid: { display: false }, ticks: { font: { size: 9 } }, title: { display: true, text: 'Jobs Added', font: { size: 9 }, color: '#95a5a6' } },
                  y: { max: 100, min: 0, ticks: { callback: v => v + '%', font: { size: 9 } }, grid: { color: '#ecf0f1' }, title: { display: true, text: 'Probability', font: { size: 9 }, color: '#95a5a6' } }
                }
              }
            });
          }

          const meta = document.getElementById('payrolls-meta');
          if (meta) {
            meta.textContent = monthLabel + ' (most liquid) | ' + topMonth.total_volume.toLocaleString() + ' contracts traded';
          }
        }

      } catch (error) {
        console.error("Failed to load prediction markets:", error);
        const el = document.getElementById('inflation-consensus');
        if (el) el.innerHTML = '<div class="value">--</div><div class="period">Data unavailable</div>';
      }
    }

    loadPredictionMarkets();
    setInterval(loadPredictionMarkets, 300000);
    </script>
  </div>
</article>
{{ end }}
