<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snow Cover Intelligence Dashboard | NixVir</title>

    <!-- D3.js and TopoJSON -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>

    <!-- Chart.js for trend chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-E2QD5PNRWE"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-E2QD5PNRWE');
    </script>

    <style>
        :root {
            --bg-deep: #0a0e14;
            --bg-card: #111820;
            --bg-elevated: #1a2230;
            --border: #2a3444;
            --border-light: #3a4454;
            --text-primary: #e8ecf2;
            --text-secondary: #8892a2;
            --text-muted: #5c6678;
            --accent-cold: #3b82f6;
            --accent-cold-bright: #60a5fa;
            --accent-warm: #f97316;
            --accent-warm-bright: #fb923c;
            --snow-heavy: #dbeafe;
            --snow-moderate: #60a5fa;
            --snow-light: #1e40af;
            --snow-none: #475569;
            --geo-fill: #1e293b;
            --geo-stroke: #334155;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-deep);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .bg-gradient {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(ellipse at 15% 10%, rgba(59, 130, 246, 0.06) 0%, transparent 50%),
                radial-gradient(ellipse at 85% 90%, rgba(249, 115, 22, 0.04) 0%, transparent 50%),
                var(--bg-deep);
            z-index: -1;
        }

        .dashboard {
            max-width: 1700px;
            margin: 0 auto;
            padding: 1.5rem 2rem;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            padding-bottom: 1.25rem;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-left h1 {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: 0.35rem;
        }

        .header-left h1 span {
            color: var(--accent-cold-bright);
        }

        .header-left .subtitle {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .back-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: var(--text-primary);
        }

        /* Site Navigation Bar - Matching main site exactly */
        .site-nav {
            background: #000;
            padding: 0.75rem 1rem 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .site-nav-left {
            display: flex;
            align-items: center;
        }

        .site-nav-logo {
            display: flex;
            align-items: center;
        }

        .site-nav-logo img {
            height: 40px;
            width: auto;
        }

        .site-nav-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .site-nav-links {
            display: flex;
            align-items: center;
            gap: 0;
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .site-nav-links li {
            padding-right: 1rem;
        }

        .site-nav-links a {
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            font-size: 1rem;
            font-weight: 400;
            transition: color 0.2s;
        }

        .site-nav-links a:hover {
            color: #fff;
        }

        .site-nav-links .current {
            color: #fff;
        }

        .last-updated {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-muted);
            white-space: nowrap;
        }

        @media (max-width: 1200px) {
            .site-nav-links a {
                font-size: 0.9rem;
            }

            .site-nav-links li {
                padding-right: 0.75rem;
            }
        }

        @media (max-width: 900px) {
            .site-nav {
                padding: 0.5rem 1rem;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .site-nav-logo img {
                height: 32px;
            }

            .site-nav-links {
                flex-wrap: wrap;
                gap: 0.25rem;
            }

            .site-nav-links li {
                padding-right: 0.5rem;
            }

            .site-nav-links a {
                font-size: 0.8rem;
            }

            .last-updated {
                width: 100%;
                text-align: center;
                font-size: 0.65rem;
            }
        }

        /* Headline Insight Banner */
        .headline-insight {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(16, 185, 129, 0.1) 100%);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 1.25rem 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .headline-icon {
            width: 48px;
            height: 48px;
            background: rgba(59, 130, 246, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .headline-icon svg {
            width: 24px;
            height: 24px;
            color: var(--accent-cold-bright);
        }

        .headline-content {
            flex: 1;
        }

        .headline-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .headline-subtitle {
            font-size: 0.95rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .headline-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.25rem 0.6rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-left: 0.5rem;
        }

        .headline-badge.positive {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .headline-badge.negative {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .headline-badge.neutral {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        @media (max-width: 768px) {
            .headline-insight {
                flex-direction: column;
                text-align: center;
            }

            .headline-title {
                font-size: 1rem;
            }
        }

        /* Region Control Panel - Prominent Selector */
        .region-control-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem 2rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .region-control-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .region-control-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 1.25rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .region-control-actions {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .region-preset {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .region-preset label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .region-preset select {
            background: var(--bg-elevated);
            border: 2px solid var(--border);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            cursor: pointer;
            min-width: 220px;
            transition: border-color 0.2s;
        }

        .region-preset select:hover {
            border-color: var(--border-light);
        }

        .region-preset select:focus {
            outline: none;
            border-color: var(--accent-cold);
        }

        .region-divider {
            color: var(--text-muted);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .customize-btn-large {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 500;
            border-radius: 8px;
            border: 2px solid var(--accent-cold);
            background: rgba(59, 130, 246, 0.1);
            color: var(--accent-cold-bright);
            cursor: pointer;
            transition: all 0.2s;
        }

        .customize-btn-large svg {
            width: 18px;
            height: 18px;
        }

        .customize-btn-large:hover {
            background: var(--accent-cold);
            color: white;
        }

        .region-control-hint {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 1rem;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .region-control-panel {
                padding: 1.25rem;
            }

            .region-control-actions {
                flex-direction: column;
                gap: 1rem;
            }

            .region-divider {
                display: none;
            }

            .region-preset select {
                min-width: 100%;
            }

            .customize-btn-large {
                width: 100%;
                justify-content: center;
            }
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 1.25rem;
            align-items: start;
        }

        /* Card */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
        }

        .card-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 0.8rem;
            font-weight: 600;
        }

        .card-subtitle {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 0.15rem;
        }

        .card-body {
            padding: 0.875rem;
        }

        /* Map */
        .map-card {
            grid-column: 1;
        }

        .map-container {
            height: 620px;
            position: relative;
            background: linear-gradient(180deg, var(--bg-card) 0%, var(--bg-elevated) 100%);
        }

        #feeder-map {
            width: 100%;
            height: 100%;
        }

        .state-path {
            fill: var(--geo-fill);
            stroke: var(--geo-stroke);
            stroke-width: 0.5;
        }

        .metro-bubble {
            stroke: var(--bg-deep);
            stroke-width: 1.5;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .metro-bubble:hover {
            opacity: 1 !important;
            stroke-width: 2.5;
        }

        .metro-label {
            fill: var(--text-secondary);
            font-size: 0.6rem;
            font-weight: 500;
            pointer-events: none;
        }

        .region-badge {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: rgba(17, 24, 32, 0.92);
            backdrop-filter: blur(8px);
            padding: 0.5rem 0.875rem;
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .region-badge-title {
            font-size: 0.55rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .region-badge-name {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .map-legend {
            position: absolute;
            bottom: 0.875rem;
            left: 0.875rem;
            background: rgba(17, 24, 32, 0.92);
            backdrop-filter: blur(8px);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            display: flex;
            gap: 1.5rem;
        }

        .legend-group {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .legend-title {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }

        .legend-scale {
            display: flex;
            gap: 2px;
            height: 8px;
        }

        .legend-scale div {
            width: 24px;
            border-radius: 2px;
        }

        .legend-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--text-primary);
        }

        .legend-size {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .legend-size-item {
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .legend-circle {
            background: var(--snow-moderate);
            border-radius: 50%;
            opacity: 0.7;
        }

        .legend-size span {
            font-size: 0.7rem;
            color: var(--text-primary);
        }

        /* Right Column */
        .right-column {
            grid-column: 2;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        /* Summary Grid */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .summary-stat {
            background: var(--bg-elevated);
            padding: 0.75rem;
            border-radius: 6px;
            text-align: center;
        }

        .summary-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
            font-weight: 500;
        }

        .summary-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.25rem;
            font-weight: 600;
        }

        /* Insight Box */
        .insight-box {
            background: rgba(59, 130, 246, 0.08);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 6px;
            padding: 0.75rem;
            margin-top: 0.75rem;
        }

        .insight-header {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin-bottom: 0.4rem;
        }

        .insight-icon {
            width: 14px;
            height: 14px;
            color: var(--accent-cold);
        }

        .insight-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--accent-cold-bright);
        }

        .insight-text {
            font-size: 0.9rem;
            color: var(--text-primary);
            line-height: 1.5;
        }

        /* Market Table */
        .market-table-container {
            max-height: 240px;
            overflow-y: auto;
        }

        .market-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .market-table th {
            text-align: left;
            padding: 0.5rem 0.6rem;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: sticky;
            top: 0;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
        }

        .market-table td {
            padding: 0.55rem 0.6rem;
            border-bottom: 1px solid var(--border);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
        }

        .market-table tr:hover {
            background: var(--bg-elevated);
        }

        .market-name-cell {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .snow-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .market-name {
            font-family: 'DM Sans', sans-serif;
            font-weight: 500;
        }

        .market-state {
            color: var(--text-muted);
            font-family: 'DM Sans', sans-serif;
            font-size: 0.6rem;
        }

        .temp-warm { color: var(--accent-warm-bright); }
        .temp-cool { color: var(--accent-cold-bright); }
        .temp-normal { color: var(--text-secondary); }

        .awareness-badge {
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-size: 0.55rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .awareness-high {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .awareness-moderate {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .awareness-low {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }


        /* Tooltip */
        .tooltip {
            position: fixed;
            background: rgba(17, 24, 32, 0.95);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 0.75rem;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.15s;
            backdrop-filter: blur(8px);
            min-width: 160px;
        }

        .tooltip.visible {
            opacity: 1;
        }

        .tooltip-title {
            font-weight: 600;
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
            padding-bottom: 0.4rem;
            border-bottom: 1px solid var(--border);
        }

        .tooltip-row {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
        }

        .tooltip-row:last-child {
            margin-bottom: 0;
        }

        .tooltip-label {
            color: var(--text-secondary);
        }

        .tooltip-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
        }

        /* Bottom Section - National Overview */
        .bottom-section {
            margin-top: 1.25rem;
        }

        /* Units Toggle */
        .units-toggle {
            display: flex;
            background: var(--bg-elevated);
            border-radius: 6px;
            padding: 3px;
            gap: 2px;
        }

        .units-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 0.4rem 0.8rem;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .units-btn:hover {
            color: var(--text-primary);
        }

        .units-btn.active {
            background: var(--accent-cold);
            color: white;
        }

        /* National Overview Card */
        .national-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .national-stat-card {
            background: var(--bg-elevated);
            padding: 1.5rem 1.25rem;
            border-radius: 10px;
            text-align: center;
        }

        .national-stat-country {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 1.25rem;
        }

        .national-stat-metrics {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .stat-metric {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-metric-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            line-height: 1.1;
        }

        .stat-metric-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.3rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            font-weight: 500;
        }

        /* Metric colors */
        .stat-positive { color: var(--accent-cold-bright); }
        .stat-negative { color: var(--accent-warm-bright); }
        .stat-neutral { color: var(--text-primary); }

        /* Temperature colors (inverted - warm is bad for snow) */
        .temp-warm { color: var(--accent-warm-bright); }
        .temp-cold { color: var(--accent-cold-bright); }

        /* Legacy styles for backward compatibility */
        .national-stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .national-stat-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .national-stat-temp {
            font-size: 0.75rem;
            margin-top: 0.5rem;
        }

        .chart-header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin: 1rem 0 0.5rem 0;
            gap: 1rem;
        }

        .chart-header-row > div {
            flex: 1;
        }

        .chart-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 0.25rem 0;
            text-align: center;
        }

        .chart-note {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin: 0;
            text-align: center;
            font-style: italic;
        }

        .reset-zoom-btn {
            background: var(--accent-cold);
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .reset-zoom-btn:hover {
            background: var(--accent-cold-bright);
            transform: scale(1.02);
        }

        .national-chart-container {
            height: 280px;
            cursor: crosshair;
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 300px;
            color: var(--text-muted);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-cold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1300px) {
            .main-layout {
                grid-template-columns: 1fr;
            }

            .map-card,
            .right-column {
                grid-column: 1;
            }

            .map-container {
                height: 450px;
            }

        }

        @media (max-width: 768px) {
            .dashboard {
                padding: 1rem;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-right {
                width: 100%;
                justify-content: space-between;
            }

            .map-container {
                height: 350px;
            }

            .national-stats {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Custom Market Selector Sidebar */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .sidebar-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .market-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            max-width: 90vw;
            height: 100vh;
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            transition: right 0.3s ease;
        }

        .market-sidebar.open {
            right: 0;
        }

        .sidebar-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .sidebar-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
            line-height: 1;
        }

        .sidebar-close:hover {
            color: var(--text-primary);
        }

        .sidebar-actions {
            padding: 0.75rem 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .sidebar-btn {
            padding: 0.4rem 0.75rem;
            font-size: 0.75rem;
            border-radius: 4px;
            border: 1px solid var(--border);
            background: var(--bg-elevated);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .sidebar-btn:hover {
            border-color: var(--accent-cold);
            color: var(--text-primary);
        }

        .sidebar-btn.primary {
            background: var(--accent-cold);
            border-color: var(--accent-cold);
            color: white;
        }

        .sidebar-btn.primary:hover {
            background: var(--accent-cold-bright);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 1.25rem;
        }

        .market-group {
            margin-bottom: 1.25rem;
        }

        .market-group-header {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--accent-cold-bright);
            margin-top: 1.25rem;
            margin-bottom: 0.75rem;
            padding-bottom: 0.35rem;
            border-bottom: 1px solid var(--border);
        }

        .market-group-header:first-child {
            margin-top: 0;
        }

        .market-region {
            margin-bottom: 1rem;
            background: var(--bg-elevated);
            border-radius: 6px;
            padding: 0.75rem;
        }

        .market-region-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .market-region-header .region-name {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .region-select-all {
            font-size: 0.65rem;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
        }

        .region-select-all:hover {
            border-color: var(--accent-cold);
            color: var(--accent-cold-bright);
        }

        .market-checkboxes {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .market-checkbox-label {
            display: flex;
            align-items: center;
            padding: 0.35rem 0.5rem;
            margin: 0 -0.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .market-checkbox-label:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .market-checkbox {
            margin-right: 0.6rem;
            accent-color: var(--accent-cold);
            width: 15px;
            height: 15px;
            cursor: pointer;
        }

        .market-checkbox-label .market-name {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .market-checkbox:checked + .market-name {
            color: var(--text-primary);
        }

        .sidebar-footer {
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--border);
            background: var(--bg-elevated);
        }

        .selected-count {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
        }

        .selected-count strong {
            color: var(--accent-cold-bright);
        }

    </style>
</head>
<body>
    <div class="bg-gradient"></div>

    <!-- Market Selector Sidebar -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    <aside class="market-sidebar" id="market-sidebar">
        <div class="sidebar-header">
            <h3>Build Custom Region</h3>
            <button class="sidebar-close" id="sidebar-close">&times;</button>
        </div>
        <div class="sidebar-actions">
            <button class="sidebar-btn" id="select-all-btn">Select All</button>
            <button class="sidebar-btn" id="clear-all-btn">Clear All</button>
            <button class="sidebar-btn primary" id="apply-selection-btn">Apply Selection</button>
        </div>
        <div class="sidebar-content" id="market-list">
            <!-- Market checkboxes populated by JavaScript -->
        </div>
        <div class="sidebar-footer">
            <div class="selected-count"><strong id="selected-count">0</strong> markets selected</div>
        </div>
    </aside>

    <!-- Site Navigation - Matching main site exactly -->
    <nav class="site-nav">
        <div class="site-nav-left">
            <a href="/" class="site-nav-logo">
                <img src="/images/nixvirlogo.png" alt="NixVir">
            </a>
        </div>
        <div class="site-nav-right">
            <ul class="site-nav-links">
                <li><a href="/dashboard/">Economic Dashboard</a></li>
                <li><a href="/ski-news/">Ski Business News</a></li>
                <li><a href="/post/">Data Insights</a></li>
                <li><a href="/snow-cover/" class="current">Snow Cover</a></li>
                <li><a href="/about/">About</a></li>
                <li><a href="/contact/">Contact</a></li>
            </ul>
            <div class="last-updated" id="last-updated">Loading...</div>
        </div>
    </nav>

    <div class="dashboard">
        <header class="header">
            <div class="header-left">
                <h1>Snow Cover <span>Intelligence</span></h1>
                <p class="subtitle">Tracking ski industry conditions across North America</p>
            </div>
            <div class="header-right">
                <div class="units-toggle">
                    <button class="units-btn active" id="units-english" data-units="english">English</button>
                    <button class="units-btn" id="units-metric" data-units="metric">Metric</button>
                </div>
            </div>
        </header>

        <!-- Hidden region selector for JS compatibility -->
        <select id="region-select" style="display: none;">
            <optgroup label="NSAA Regions">
                <option value="rocky-mountain">Rocky Mountain</option>
                <option value="pacific-northwest">Pacific Northwest</option>
                <option value="pacific-southwest">Pacific Southwest</option>
                <option value="midwest">Midwest</option>
                <option value="northeast">Northeast</option>
                <option value="southeast">Southeast</option>
            </optgroup>
            <optgroup label="Canada Ski Council">
                <option value="canada-bc">British Columbia</option>
                <option value="canada-alberta">Alberta</option>
                <option value="canada-prairies">Prairies (SK/MB)</option>
                <option value="canada-ontario">Ontario</option>
                <option value="canada-quebec">Quebec</option>
                <option value="canada-atlantic">Atlantic Canada</option>
            </optgroup>
            <optgroup label="View All">
                <option value="north-america" selected>North America</option>
            </optgroup>
        </select>

        <!-- National Snow Cover Chart - Front and Center -->
        <div class="card national-overview" style="margin-bottom: 1.25rem;">
            <div class="card-header">
                <div>
                    <div class="card-title" id="snow-chart-title">National Snow Cover</div>
                    <div class="card-subtitle">Full 2025-26 ski season (Oct 1 - Apr 30) vs 5-year average</div>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-header-row">
                    <div>
                        <h3 class="chart-title">Current Winter of 2025/26 Percent Snow Cover vs. Prior 5-Year Average</h3>
                        <p class="chart-note">Gray bars show holidays. <strong>Click and drag</strong> on chart to zoom in. Double-click to reset.</p>
                    </div>
                    <button id="reset-zoom-btn" class="reset-zoom-btn" style="display: none;">Reset Zoom</button>
                </div>
                <div class="national-chart-container" style="height: 320px;">
                    <canvas id="national-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Temperature Anomaly Chart -->
        <div class="card national-overview" style="margin-bottom: 1.25rem;">
            <div class="card-header">
                <div>
                    <div class="card-title" id="temp-chart-title">Temperature Anomaly</div>
                    <div class="card-subtitle">How current temperatures compare to historical averages</div>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-header-row">
                    <div>
                        <h3 class="chart-title">Current Winter of 2025/26 Temperature Anomaly vs. Normal</h3>
                        <p class="chart-note">Positive values = warmer than normal (red), Negative = colder (blue)</p>
                    </div>
                    <button id="reset-temp-zoom-btn" class="reset-zoom-btn" style="display: none;">Reset Zoom</button>
                </div>
                <div class="national-chart-container" style="height: 280px;">
                    <canvas id="temperature-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- National Stats Cards -->
        <div class="national-stats" id="national-stats" style="margin-bottom: 1.25rem;">
            <div class="national-stat-card" id="usa-stat-card">
                <div class="national-stat-country">United States</div>
                <div class="national-stat-metrics">
                    <div class="stat-metric">
                        <div class="stat-metric-value stat-neutral" id="usa-cover">--</div>
                        <div class="stat-metric-label">Snow Coverage</div>
                    </div>
                    <div class="stat-metric">
                        <div class="stat-metric-value" id="usa-snow-diff">--</div>
                        <div class="stat-metric-label">vs 5-Year Average</div>
                    </div>
                    <div class="stat-metric">
                        <div class="stat-metric-value" id="usa-temp">--</div>
                        <div class="stat-metric-label">Temp vs Normal</div>
                    </div>
                </div>
            </div>
            <div class="national-stat-card" id="canada-stat-card">
                <div class="national-stat-country">Canada</div>
                <div class="national-stat-metrics">
                    <div class="stat-metric">
                        <div class="stat-metric-value stat-neutral" id="canada-cover">--</div>
                        <div class="stat-metric-label">Snow Coverage</div>
                    </div>
                    <div class="stat-metric">
                        <div class="stat-metric-value" id="canada-snow-diff">--</div>
                        <div class="stat-metric-label">vs 5-Year Average</div>
                    </div>
                    <div class="stat-metric">
                        <div class="stat-metric-value" id="canada-temp">--</div>
                        <div class="stat-metric-label">Temp vs Normal</div>
                    </div>
                </div>
            </div>
            <div class="national-stat-card" id="combined-stat-card">
                <div class="national-stat-country">North America</div>
                <div class="national-stat-metrics">
                    <div class="stat-metric">
                        <div class="stat-metric-value stat-neutral" id="combined-cover">--</div>
                        <div class="stat-metric-label">Snow Coverage</div>
                    </div>
                    <div class="stat-metric">
                        <div class="stat-metric-value" id="combined-snow-diff">--</div>
                        <div class="stat-metric-label">vs 5-Year Average</div>
                    </div>
                    <div class="stat-metric">
                        <div class="stat-metric-value" id="combined-temp">--</div>
                        <div class="stat-metric-label">Temp vs Normal</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map Section -->
        <div class="main-layout">
            <div class="card map-card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Detailed Market Conditions</div>
                        <div class="card-subtitle">Click on an NSAA or CSC region below for detailed breakdowns | Bubble size = population | Color = snow depth</div>
                    </div>
                    <button id="reset-map-btn" class="reset-zoom-btn" style="display: none;">Reset to North America</button>
                </div>
                <div class="map-container" id="map-container">
                    <div class="loading" id="map-loading">
                        <div class="loading-spinner"></div>
                        <span>Loading map data...</span>
                    </div>
                    <svg id="feeder-map" style="display: none;"></svg>
                    <div class="region-badge">
                        <div class="region-badge-title">Viewing</div>
                        <div class="region-badge-name" id="region-display">North America</div>
                    </div>
                    <div class="map-legend">
                        <div class="legend-group">
                            <div class="legend-title">Snow Depth</div>
                            <div class="legend-scale">
                                <div style="background: var(--snow-none)"></div>
                                <div style="background: var(--snow-light)"></div>
                                <div style="background: var(--snow-moderate)"></div>
                                <div style="background: var(--snow-heavy)"></div>
                            </div>
                            <div class="legend-labels">
                                <span>0"</span>
                                <span>6"+</span>
                            </div>
                        </div>
                        <div class="legend-group">
                            <div class="legend-title">Market Size</div>
                            <div class="legend-size">
                                <div class="legend-size-item">
                                    <div class="legend-circle" style="width: 10px; height: 10px;"></div>
                                    <span>Small</span>
                                </div>
                                <div class="legend-size-item">
                                    <div class="legend-circle" style="width: 18px; height: 18px;"></div>
                                    <span>Large</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-column">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Regional Summary</div>
                    </div>
                    <div class="card-body">
                        <div class="summary-grid" id="summary-stats">
                            <div class="summary-stat">
                                <div class="summary-label">Avg Snow Cover</div>
                                <div class="summary-value">--</div>
                            </div>
                            <div class="summary-stat">
                                <div class="summary-label">Temp Anomaly</div>
                                <div class="summary-value">--</div>
                            </div>
                            <div class="summary-stat">
                                <div class="summary-label">Markets w/ Snow</div>
                                <div class="summary-value">--</div>
                            </div>
                            <div class="summary-stat">
                                <div class="summary-label">Low Awareness</div>
                                <div class="summary-value">--</div>
                            </div>
                        </div>
                        <div class="insight-box" id="insight-box">
                            <div class="insight-header">
                                <svg class="insight-icon" viewBox="0 0 16 16" fill="currentColor">
                                    <path d="M8 1.5a.5.5 0 0 1 .5.5v5a.5.5 0 0 1-1 0V2a.5.5 0 0 1 .5-.5zm0 9a.75.75 0 1 1 0 1.5.75.75 0 0 1 0-1.5z"/>
                                    <path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zM1 8a7 7 0 1 1 14 0A7 7 0 0 1 1 8z"/>
                                </svg>
                                <span class="insight-title">Market Insight</span>
                            </div>
                            <div class="insight-text">Loading market conditions...</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">Ski Markets</div>
                            <div class="card-subtitle">Winter awareness = snow visible + seasonable temps</div>
                        </div>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div class="market-table-container">
                            <table class="market-table">
                                <thead>
                                    <tr>
                                        <th>Market</th>
                                        <th>Snow</th>
                                        <th>Depth</th>
                                        <th>Temp</th>
                                        <th>vs Norm</th>
                                        <th>Awareness</th>
                                    </tr>
                                </thead>
                                <tbody id="market-table-body">
                                    <tr><td colspan="6" style="text-align: center; color: var(--text-muted);">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        console.log('Snow Cover Dashboard: JavaScript loaded');
        console.log('Page URL:', window.location.href);
        console.log('Protocol:', window.location.protocol);

        // Check if loaded via file:// protocol (fetch won't work)
        if (window.location.protocol === 'file:') {
            console.error('Page loaded via file:// protocol - data fetching will fail!');
            document.addEventListener('DOMContentLoaded', () => {
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'background: #ff4444; color: white; padding: 20px; margin: 20px; border-radius: 8px; text-align: center;';
                errorDiv.innerHTML = '<strong>Cannot load via file:// protocol</strong><br>Please serve this page via a web server (e.g., Hugo or Python http.server)';
                document.querySelector('.dashboard')?.prepend(errorDiv);
                document.getElementById('last-updated').textContent = 'Error: file:// not supported';
            });
        }

        // ============================================
        // State
        // ============================================
        let snowData = null;
        let historicalData = null;  // 5-year seasonal averages
        let temperatureHistoryData = null;  // Per-metro temperature history (REAL data)
        let currentRegion = 'north-america';
        let currentMarkets = [];
        let usGeoData = null;
        let canadaGeoData = null;
        let nationalChart = null;
        let temperatureChart = null;
        let customSelectedMarkets = new Set(); // For custom region builder

        // 2025/2026 Winter Holiday Markers
        const WINTER_HOLIDAYS = [
            { name: 'Canadian Thanksgiving', start: '2025-10-13', end: '2025-10-13', country: 'CA' },
            { name: 'US Thanksgiving', start: '2025-11-27', end: '2025-11-30', country: 'US' },
            { name: 'Christmas/New Year', start: '2025-12-20', end: '2026-01-05', country: 'Both' },
            { name: 'MLK Day', start: '2026-01-19', end: '2026-01-19', country: 'US' },
            { name: "Presidents' Day", start: '2026-02-16', end: '2026-02-16', country: 'US' },
            { name: 'Spring Break', start: '2026-03-14', end: '2026-03-28', country: 'Both' },
            { name: 'Easter', start: '2026-04-05', end: '2026-04-05', country: 'Both' }
        ];

        // NSAA/CSC Region Definitions (state/province groupings)
        const NSAA_REGIONS = {
            'rocky-mountain': {
                name: 'Rocky Mountain',
                states: ['Colorado', 'Utah', 'Wyoming', 'Montana', 'Idaho', 'New Mexico', 'Arizona'],
                abbrevs: ['CO', 'UT', 'WY', 'MT', 'ID', 'NM', 'AZ'],
                stateIds: [8, 49, 56, 30, 16, 35, 4],
                color: 'rgba(59, 130, 246, 0.15)'
            },
            'pacific-northwest': {
                name: 'Pacific Northwest',
                states: ['Washington', 'Oregon', 'Alaska'],
                abbrevs: ['WA', 'OR', 'AK'],
                stateIds: [53, 41, 2],
                color: 'rgba(16, 185, 129, 0.15)'
            },
            'pacific-southwest': {
                name: 'Pacific Southwest',
                states: ['California', 'Nevada'],
                abbrevs: ['CA', 'NV'],
                stateIds: [6, 32],
                color: 'rgba(249, 115, 22, 0.15)'
            },
            'midwest': {
                name: 'Midwest',
                states: ['Michigan', 'Wisconsin', 'Minnesota', 'Iowa', 'Illinois', 'Indiana', 'Ohio', 'Missouri', 'Nebraska', 'Kansas', 'South Dakota', 'North Dakota'],
                abbrevs: ['MI', 'WI', 'MN', 'IA', 'IL', 'IN', 'OH', 'MO', 'NE', 'KS', 'SD', 'ND'],
                stateIds: [26, 55, 27, 19, 17, 18, 39, 29, 31, 20, 46, 38],
                color: 'rgba(147, 51, 234, 0.15)'
            },
            'northeast': {
                name: 'Northeast',
                states: ['Maine', 'New Hampshire', 'Vermont', 'Massachusetts', 'Rhode Island', 'Connecticut', 'New York', 'New Jersey', 'Pennsylvania'],
                abbrevs: ['ME', 'NH', 'VT', 'MA', 'RI', 'CT', 'NY', 'NJ', 'PA'],
                stateIds: [23, 33, 50, 25, 44, 9, 36, 34, 42],
                color: 'rgba(236, 72, 153, 0.15)'
            },
            'southeast': {
                name: 'Southeast',
                states: ['Virginia', 'West Virginia', 'North Carolina', 'Tennessee', 'Kentucky', 'Maryland', 'Delaware'],
                abbrevs: ['VA', 'WV', 'NC', 'TN', 'KY', 'MD', 'DE'],
                stateIds: [51, 54, 37, 47, 21, 24, 10],
                color: 'rgba(245, 158, 11, 0.15)'
            }
        };

        const CSC_REGIONS = {
            'canada-bc': {
                name: 'British Columbia',
                provinces: ['British Columbia'],
                abbrevs: ['BC'],
                color: 'rgba(59, 130, 246, 0.15)'
            },
            'canada-alberta': {
                name: 'Alberta',
                provinces: ['Alberta'],
                abbrevs: ['AB'],
                color: 'rgba(16, 185, 129, 0.15)'
            },
            'canada-prairies': {
                name: 'Prairies',
                provinces: ['Saskatchewan', 'Manitoba'],
                abbrevs: ['SK', 'MB'],
                color: 'rgba(249, 115, 22, 0.15)'
            },
            'canada-ontario': {
                name: 'Ontario',
                provinces: ['Ontario'],
                abbrevs: ['ON'],
                color: 'rgba(147, 51, 234, 0.15)'
            },
            'canada-quebec': {
                name: 'Quebec',
                provinces: ['Quebec', 'Qubec'],
                abbrevs: ['QC'],
                color: 'rgba(236, 72, 153, 0.15)'
            },
            'canada-atlantic': {
                name: 'Atlantic Canada',
                provinces: ['New Brunswick', 'Nova Scotia', 'Prince Edward Island', 'Newfoundland and Labrador'],
                abbrevs: ['NB', 'NS', 'PE', 'NL'],
                color: 'rgba(245, 158, 11, 0.15)'
            }
        };

        // ============================================
        // Data Loading
        // ============================================
        async function loadSnowData() {
            try {
                console.log('Loading snow data...');
                document.getElementById('last-updated').textContent = 'Loading data...';

                // Load core data files (required)
                console.log('Fetching /data/snow-cover.json and /data/snow-cover-historical.json...');
                const [snowResponse, historicalResponse] = await Promise.all([
                    fetch('/data/snow-cover.json'),
                    fetch('/data/snow-cover-historical.json')
                ]);

                console.log('Snow response status:', snowResponse.status);
                console.log('Historical response status:', historicalResponse.status);

                if (!snowResponse.ok) {
                    throw new Error(`Failed to load snow-cover.json: ${snowResponse.status}`);
                }

                snowData = await snowResponse.json();
                console.log('Snow data loaded:', snowData?.updated);
                console.log('Snow data has usa.history:', snowData?.usa?.history?.length, 'entries');
                console.log('Snow data has canada.history:', snowData?.canada?.history?.length, 'entries');

                if (!historicalResponse.ok) {
                    console.warn('Historical response not ok:', historicalResponse.status);
                    historicalData = null;
                } else {
                    try {
                        historicalData = await historicalResponse.json();
                        console.log('Historical data loaded, usa:', historicalData?.usa?.length, 'entries');
                        console.log('Historical data loaded, canada:', historicalData?.canada?.length, 'entries');
                    } catch (e) {
                        console.warn('Historical data parse error:', e);
                        historicalData = null;
                    }
                }

                // Load temperature history separately (optional, large file)
                try {
                    const tempHistoryResponse = await fetch('/data/temperature-history.json');
                    if (tempHistoryResponse.ok) {
                        temperatureHistoryData = await tempHistoryResponse.json();
                        console.log('Temperature history loaded:', Object.keys(temperatureHistoryData?.metros || {}).length, 'metros');
                    } else {
                        console.warn('Temperature history not available:', tempHistoryResponse.status);
                        temperatureHistoryData = null;
                    }
                } catch (e) {
                    console.warn('Temperature history load error:', e);
                    temperatureHistoryData = null;
                }

                // Update timestamp
                document.getElementById('last-updated').textContent = `Updated ${snowData.updated}`;

                // Update national overview
                console.log('Calling updateNationalOverview...');
                updateNationalOverview();
                console.log('updateNationalOverview complete');

                // Update regional dashboard
                console.log('Calling updateDashboard...');
                updateDashboard();
                console.log('updateDashboard complete');

            } catch (error) {
                console.error('Error loading snow data:', error);
                document.getElementById('last-updated').textContent = 'Error loading data';
                // Show more visible error on page
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'background: #ff4444; color: white; padding: 20px; margin: 20px; border-radius: 8px; text-align: center;';
                errorDiv.innerHTML = `<strong>Data Load Error:</strong> ${error.message}<br><small>Check browser console (F12) for details</small>`;
                document.querySelector('.dashboard')?.prepend(errorDiv);
            }
        }

        async function loadGeoData() {
            try {
                // Load US states
                const usResponse = await fetch('https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json');
                const usData = await usResponse.json();
                usGeoData = topojson.feature(usData, usData.objects.states);

                // Load Canada provinces
                const caResponse = await fetch('https://raw.githubusercontent.com/codeforamerica/click_that_hood/master/public/data/canada.geojson');
                canadaGeoData = await caResponse.json();

                // Hide loading, show map
                document.getElementById('map-loading').style.display = 'none';
                document.getElementById('feeder-map').style.display = 'block';

            } catch (e) {
                console.error('Error loading geo data:', e);
                document.getElementById('map-loading').innerHTML =
                    '<span style="color: var(--danger);">Error loading map data</span>';
            }

            if (snowData) {
                drawMap();
            }
        }

        // ============================================
        // Data Processing
        // ============================================

        // Get markets for current region from snow data
        function getRegionMarkets() {
            if (!snowData || !snowData.metros) {
                return [];
            }

            // Handle "North America" - show all markets
            if (currentRegion === 'north-america') {
                return snowData.metros.map(metro => {
                    const snowCover = metro.cover || 0;
                    const tempAnomaly = metro.temperature?.anomaly_f || 0;

                    let awareness;
                    if (snowCover >= 50 && tempAnomaly <= 5) {
                        awareness = 'high';
                    } else if (snowCover > 0 || tempAnomaly <= 8) {
                        awareness = 'moderate';
                    } else {
                        awareness = 'low';
                    }

                    return {
                        name: metro.city,
                        state: metro.region,
                        country: metro.country || 'usa',
                        lat: metro.lat,
                        lng: metro.lng,
                        importance: metro.importance || 100,
                        snowCover: snowCover,
                        snowDepth: metro.depthInches || 0,
                        temp: metro.temperature?.temp_f || null,
                        tempAnomaly: Math.round(tempAnomaly),
                        awareness: awareness
                    };
                });
            }

            // Handle NSAA regions (US states)
            if (NSAA_REGIONS[currentRegion]) {
                const regionDef = NSAA_REGIONS[currentRegion];
                return snowData.metros.filter(metro => {
                    // Match by state abbreviation
                    return regionDef.abbrevs.includes(metro.region) && metro.country !== 'canada';
                }).map(metro => {
                    const snowCover = metro.cover || 0;
                    const tempAnomaly = metro.temperature?.anomaly_f || 0;
                    let awareness;
                    if (snowCover >= 50 && tempAnomaly <= 5) {
                        awareness = 'high';
                    } else if (snowCover > 0 || tempAnomaly <= 8) {
                        awareness = 'moderate';
                    } else {
                        awareness = 'low';
                    }
                    return {
                        name: metro.city,
                        state: metro.region,
                        country: metro.country || 'usa',
                        lat: metro.lat,
                        lng: metro.lng,
                        importance: metro.importance || 100,
                        snowCover: snowCover,
                        snowDepth: metro.depthInches || 0,
                        temp: metro.temperature?.temp_f || null,
                        tempAnomaly: Math.round(tempAnomaly),
                        awareness: awareness
                    };
                });
            }

            // Handle CSC regions (Canadian provinces)
            if (CSC_REGIONS[currentRegion]) {
                const regionDef = CSC_REGIONS[currentRegion];
                return snowData.metros.filter(metro => {
                    // Match by province abbreviation
                    return regionDef.abbrevs.includes(metro.region) && metro.country === 'canada';
                }).map(metro => {
                    const snowCover = metro.cover || 0;
                    const tempAnomaly = metro.temperature?.anomaly_f || 0;
                    let awareness;
                    if (snowCover >= 50 && tempAnomaly <= 5) {
                        awareness = 'high';
                    } else if (snowCover > 0 || tempAnomaly <= 8) {
                        awareness = 'moderate';
                    } else {
                        awareness = 'low';
                    }
                    return {
                        name: metro.city,
                        state: metro.region,
                        country: metro.country || 'canada',
                        lat: metro.lat,
                        lng: metro.lng,
                        importance: metro.importance || 100,
                        snowCover: snowCover,
                        snowDepth: metro.depthInches || 0,
                        temp: metro.temperature?.temp_f || null,
                        tempAnomaly: Math.round(tempAnomaly),
                        awareness: awareness
                    };
                });
            }

            // Handle custom region selection
            let marketNames;
            if (currentRegion === 'custom') {
                marketNames = Array.from(customSelectedMarkets);
                if (marketNames.length === 0) return [];
            } else {
                // Fallback to feederRegions from JSON data
                if (!snowData.feederRegions) return [];
                const regionConfig = snowData.feederRegions[currentRegion];
                if (!regionConfig) return [];
                marketNames = regionConfig.markets;
            }

            // Find metro data for each market in the region
            return marketNames.map(name => {
                // Find the metro in our data (handle slight name variations)
                const metro = snowData.metros.find(m =>
                    m.city === name ||
                    m.city.includes(name) ||
                    name.includes(m.city)
                );

                if (!metro) {
                    console.warn(`Metro not found: ${name}`);
                    return null;
                }

                // Calculate winter awareness based on conditions
                const snowCover = metro.cover || 0;
                const tempAnomaly = metro.temperature?.anomaly_f || 0;

                let awareness;
                if (snowCover >= 50 && tempAnomaly <= 5) {
                    awareness = 'high';
                } else if (snowCover > 0 || tempAnomaly <= 8) {
                    awareness = 'moderate';
                } else {
                    awareness = 'low';
                }

                return {
                    name: metro.city,
                    state: metro.region,
                    country: metro.country || 'usa',
                    lat: metro.lat,
                    lng: metro.lng,
                    importance: metro.importance || 100,
                    snowCover: snowCover,
                    snowDepth: metro.depthInches || 0,
                    temp: metro.temperature?.temp_f || null,
                    tempAnomaly: Math.round(tempAnomaly),
                    awareness: awareness
                };
            }).filter(m => m !== null);
        }

        // Get region config with projection settings
        function getRegionConfig() {
            const configs = {
                'north-america': { name: 'North America', center: [-98, 48], scale: 450 },
                'rocky-mountain': { name: 'Rocky Mountain', center: [-106, 40], scale: 1100 },
                'pacific-northwest': { name: 'Pacific Northwest', center: [-120, 46], scale: 1400 },
                'pacific-southwest': { name: 'Pacific Southwest', center: [-118, 35], scale: 1200 },
                'midwest': { name: 'Midwest', center: [-89, 43], scale: 1400 },
                'northeast': { name: 'Northeast', center: [-74, 42], scale: 1600 },
                'southeast': { name: 'Southeast', center: [-82, 35], scale: 1400 },
                'canada-bc': { name: 'British Columbia', center: [-124, 52], scale: 1000 },
                'canada-alberta': { name: 'Alberta', center: [-114, 53], scale: 1100 },
                'canada-prairies': { name: 'Prairies', center: [-102, 52], scale: 1000 },
                'canada-ontario': { name: 'Ontario', center: [-81, 45], scale: 1200 },
                'canada-quebec': { name: 'Quebec', center: [-72, 48], scale: 1100 },
                'canada-atlantic': { name: 'Atlantic Canada', center: [-63, 46], scale: 1200 }
            };

            // Handle custom region - calculate center and scale from selected markets
            if (currentRegion === 'custom') {
                const markets = getRegionMarkets();
                if (markets.length === 0) {
                    return { name: 'Custom Selection', center: [-98, 40], scale: 600 };
                }

                // Calculate bounding box of selected markets
                const lngs = markets.map(m => m.lng);
                const lats = markets.map(m => m.lat);
                const minLng = Math.min(...lngs);
                const maxLng = Math.max(...lngs);
                const minLat = Math.min(...lats);
                const maxLat = Math.max(...lats);

                // Center point
                const centerLng = (minLng + maxLng) / 2;
                const centerLat = (minLat + maxLat) / 2;

                // Calculate appropriate scale based on geographic span
                const lngSpan = maxLng - minLng;
                const latSpan = maxLat - minLat;
                const maxSpan = Math.max(lngSpan, latSpan);

                // Scale heuristic: smaller span = higher zoom
                let scale;
                if (maxSpan < 5) scale = 2000;
                else if (maxSpan < 10) scale = 1400;
                else if (maxSpan < 20) scale = 900;
                else if (maxSpan < 40) scale = 600;
                else scale = 400;

                return {
                    name: `Custom (${markets.length} markets)`,
                    center: [centerLng, centerLat],
                    scale: scale
                };
            }

            // Merge with feederRegions name if available
            const config = configs[currentRegion] || configs['rocky-mountain'];
            if (snowData?.feederRegions?.[currentRegion]) {
                config.name = snowData.feederRegions[currentRegion].name;
            }
            return config;
        }

        // ============================================
        // National Overview
        // ============================================
        function updateNationalOverview() {
            console.log('updateNationalOverview called, snowData:', !!snowData);
            if (!snowData) {
                console.warn('updateNationalOverview: No snowData, returning early');
                return;
            }
            console.log('updateNationalOverview: snowData.usa:', !!snowData.usa, 'snowData.canada:', !!snowData.canada);

            // Update chart titles based on current region
            const regionConfig = getRegionConfig();
            const regionName = regionConfig.name || 'North America';

            // Update snow cover chart title
            const snowChartTitle = document.getElementById('snow-chart-title');
            if (snowChartTitle) {
                snowChartTitle.textContent = currentRegion === 'north-america'
                    ? 'National Snow Cover'
                    : `${regionName} Snow Cover`;
            }

            // Update temperature chart title
            const tempChartTitle = document.getElementById('temp-chart-title');
            if (tempChartTitle) {
                tempChartTitle.textContent = currentRegion === 'north-america'
                    ? 'Temperature Anomaly'
                    : `${regionName} Temperature Anomaly`;
            }

            // Update all national stat cards with new 3-metric format
            updateNationalStatCards();

            // Draw national chart
            try {
                console.log('About to call drawNationalChart');
                drawNationalChart();
                console.log('drawNationalChart completed');
            } catch (e) {
                console.error('Error in drawNationalChart:', e);
            }

            // Draw temperature anomaly chart
            try {
                console.log('About to call drawTemperatureChart');
                drawTemperatureChart();
                console.log('drawTemperatureChart completed');
            } catch (e) {
                console.error('Error in drawTemperatureChart:', e);
            }
        }

        // Units toggle state (english or metric)
        let currentUnits = 'english';

        // Function to update a single stat card with 3 metrics
        function updateStatCard(prefix, coverValue, snowDiff, tempAnomaly) {
            const coverEl = document.getElementById(`${prefix}-cover`);
            const snowDiffEl = document.getElementById(`${prefix}-snow-diff`);
            const tempEl = document.getElementById(`${prefix}-temp`);

            if (!coverEl || !snowDiffEl || !tempEl) return;

            // Get absolute values for proportional sizing
            const absValues = [
                Math.abs(coverValue ?? 0),
                Math.abs(snowDiff ?? 0),
                Math.abs(tempAnomaly ?? 0)
            ];

            // Base font size - the snow coverage percentage sets the scale
            const baseFontSize = 2.2; // rem for the cover percentage
            const minFontSize = 1.0; // minimum readable size

            // Calculate font sizes proportional to absolute values
            // Cover is the reference (always shown at base size)
            const coverFontSize = baseFontSize;

            // Snow diff and temp scale relative to cover value, but with min size
            const snowDiffFontSize = coverValue > 0
                ? Math.max(minFontSize, baseFontSize * (Math.abs(snowDiff) / coverValue))
                : minFontSize;
            const tempFontSize = coverValue > 0
                ? Math.max(minFontSize, baseFontSize * (Math.abs(tempAnomaly) / coverValue) * 3) // Scale temp more aggressively
                : minFontSize;

            // Cap the font sizes to prevent them from being too large
            const cappedSnowDiffSize = Math.min(snowDiffFontSize, baseFontSize * 0.9);
            const cappedTempSize = Math.min(tempFontSize, baseFontSize * 0.8);

            // Update snow coverage (white/neutral)
            coverEl.textContent = coverValue != null ? `${coverValue.toFixed(1)}%` : '--';
            coverEl.style.fontSize = `${coverFontSize}rem`;
            coverEl.className = 'stat-metric-value stat-neutral';

            // Update snow diff vs 5-year average (blue positive = more snow, red negative = less snow)
            if (snowDiff != null) {
                const sign = snowDiff >= 0 ? '+' : '';
                snowDiffEl.textContent = `${sign}${snowDiff.toFixed(1)}%`;
                snowDiffEl.style.fontSize = `${cappedSnowDiffSize}rem`;
                snowDiffEl.className = `stat-metric-value ${snowDiff >= 0 ? 'stat-positive' : 'stat-negative'}`;
            } else {
                snowDiffEl.textContent = '--';
                snowDiffEl.className = 'stat-metric-value stat-neutral';
            }

            // Update temperature anomaly (red warm = above normal, blue cold = below normal)
            if (tempAnomaly != null) {
                const sign = tempAnomaly >= 0 ? '+' : '';
                const tempValue = currentUnits === 'english' ? tempAnomaly : (tempAnomaly * 5 / 9);
                const tempUnit = currentUnits === 'english' ? 'F' : 'C';
                tempEl.textContent = `${sign}${tempValue.toFixed(1)}${tempUnit}`;
                tempEl.style.fontSize = `${cappedTempSize}rem`;
                // Warm (above normal) = red, Cold (below normal) = blue
                tempEl.className = `stat-metric-value ${tempAnomaly >= 0 ? 'temp-warm' : 'temp-cold'}`;
            } else {
                tempEl.textContent = '--';
                tempEl.className = 'stat-metric-value stat-neutral';
            }
        }

        // Get historical average for a specific date (MM-DD format)
        function getHistoricalAverage(country, dateMMDD) {
            if (!historicalData || !historicalData[country]) return null;
            const entry = historicalData[country].find(e => e.date === dateMMDD);
            return entry ? entry.value : null;
        }

        // Update all national stat cards
        function updateNationalStatCards() {
            if (!snowData) return;

            // Get current date in MM-DD format for looking up historical averages
            const now = new Date();
            const dateMMDD = `${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

            // USA
            const usaCover = snowData.usa?.cover ?? null;
            const usaHistorical = getHistoricalAverage('usa', dateMMDD);
            const usaSnowDiff = (usaCover != null && usaHistorical != null) ? (usaCover - usaHistorical) : null;
            const usaTempAnomaly = snowData.usa?.temperature?.avg_anomaly_f ?? null;
            updateStatCard('usa', usaCover, usaSnowDiff, usaTempAnomaly);

            // Canada
            const canadaCover = snowData.canada?.cover ?? null;
            const canadaHistorical = getHistoricalAverage('canada', dateMMDD);
            const canadaSnowDiff = (canadaCover != null && canadaHistorical != null) ? (canadaCover - canadaHistorical) : null;
            const canadaTempAnomaly = snowData.canada?.temperature?.avg_anomaly_f ?? null;
            updateStatCard('canada', canadaCover, canadaSnowDiff, canadaTempAnomaly);

            // Combined (North America) - use real historical data if available
            const combinedCover = snowData.combined?.cover ?? null;
            const combinedHistorical = getHistoricalAverage('combined', dateMMDD);
            const combinedSnowDiff = (combinedCover != null && combinedHistorical != null)
                ? (combinedCover - combinedHistorical) : null;
            const combinedTempAnomaly = snowData.combined?.temperature?.avg_anomaly_f ?? null;
            updateStatCard('combined', combinedCover, combinedSnowDiff, combinedTempAnomaly);
        }

        // Units toggle event handlers
        function initUnitsToggle() {
            const englishBtn = document.getElementById('units-english');
            const metricBtn = document.getElementById('units-metric');

            if (englishBtn && metricBtn) {
                englishBtn.addEventListener('click', () => {
                    currentUnits = 'english';
                    englishBtn.classList.add('active');
                    metricBtn.classList.remove('active');
                    updateNationalStatCards();
                });

                metricBtn.addEventListener('click', () => {
                    currentUnits = 'metric';
                    metricBtn.classList.add('active');
                    englishBtn.classList.remove('active');
                    updateNationalStatCards();
                });
            }
        }

        function drawNationalChart() {
            console.log('drawNationalChart called, historicalData?.usa:', historicalData?.usa?.length, 'entries');
            if (!historicalData?.usa) {
                console.warn('drawNationalChart: No historical data for USA, returning early');
                return;
            }

            const ctx = document.getElementById('national-chart').getContext('2d');
            console.log('drawNationalChart: Got canvas context, creating chart...');

            if (nationalChart) {
                nationalChart.destroy();
            }

            // Build full season date range (Oct 1 2025 - Apr 30 2026)
            const seasonDates = [];
            const seasonLabels = [];
            let d = new Date(2025, 9, 1); // Oct 1, 2025
            const endDate = new Date(2026, 3, 30); // Apr 30, 2026

            while (d <= endDate) {
                seasonDates.push({
                    date: new Date(d),
                    mmdd: `${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`,
                    fullDate: `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`
                });
                d.setDate(d.getDate() + 1);
            }

            // Create lookup for 5-year averages by MM-DD
            const usaAvgLookup = {};
            const canadaAvgLookup = {};
            (historicalData.usa || []).forEach(item => { usaAvgLookup[item.date] = item.value; });
            (historicalData.canada || []).forEach(item => { canadaAvgLookup[item.date] = item.value; });

            // Create lookup for current season data by YYYY-MM-DD
            const usaCurrentLookup = {};
            const canadaCurrentLookup = {};
            (snowData?.usa?.history || []).forEach(item => {
                usaCurrentLookup[item.date] = item.value;
            });
            (snowData?.canada?.history || []).forEach(item => {
                canadaCurrentLookup[item.date] = item.value;
            });

            // Build data arrays
            const labels = [];
            const usaAvgData = [];
            const canadaAvgData = [];
            const usaCurrentData = [];
            const canadaCurrentData = [];

            const today = new Date();
            today.setHours(23, 59, 59, 999);

            seasonDates.forEach(item => {
                // Create label showing month name on 1st of each month
                if (item.date.getDate() === 1) {
                    labels.push(item.date.toLocaleDateString('en-US', { month: 'short' }));
                } else {
                    labels.push('');
                }

                // 5-year averages (full season) - lookup by MM-DD
                usaAvgData.push(usaAvgLookup[item.mmdd] ?? null);
                canadaAvgData.push(canadaAvgLookup[item.mmdd] ?? null);

                // Current season data (only up to today) - lookup by YYYY-MM-DD
                if (item.date <= today) {
                    usaCurrentData.push(usaCurrentLookup[item.fullDate] ?? null);
                    canadaCurrentData.push(canadaCurrentLookup[item.fullDate] ?? null);
                } else {
                    usaCurrentData.push(null);
                    canadaCurrentData.push(null);
                }
            });

            // Holiday annotation boxes - use array indices
            const holidayAnnotations = {};
            WINTER_HOLIDAYS.forEach((holiday, idx) => {
                const hStart = new Date(holiday.start + 'T00:00:00');
                const hEnd = new Date(holiday.end + 'T00:00:00');

                // Find indices in our data
                const startIdx = seasonDates.findIndex(item =>
                    item.date.getFullYear() === hStart.getFullYear() &&
                    item.date.getMonth() === hStart.getMonth() &&
                    item.date.getDate() === hStart.getDate()
                );
                const endIdx = seasonDates.findIndex(item =>
                    item.date.getFullYear() === hEnd.getFullYear() &&
                    item.date.getMonth() === hEnd.getMonth() &&
                    item.date.getDate() === hEnd.getDate()
                );

                if (startIdx >= 0 && endIdx >= 0) {
                    holidayAnnotations[`holiday${idx}`] = {
                        type: 'box',
                        xMin: startIdx - 0.5,
                        xMax: endIdx + 0.5,
                        backgroundColor: 'rgba(128, 128, 128, 0.12)',
                        borderWidth: 0,
                        label: {
                            display: true,
                            content: holiday.name,
                            position: 'start',
                            font: {
                                size: 9,
                                weight: 'normal'
                            },
                            color: 'rgba(100, 100, 100, 0.8)',
                            rotation: -90,
                            yAdjust: 50
                        }
                    };
                }
            });

            nationalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'USA 2025-26',
                            data: usaCurrentData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.3,
                            borderWidth: 2,
                            pointRadius: 0,
                            spanGaps: false
                        },
                        {
                            label: 'Canada 2025-26',
                            data: canadaCurrentData,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true,
                            tension: 0.3,
                            borderWidth: 2,
                            pointRadius: 0,
                            spanGaps: false
                        },
                        {
                            label: 'USA 5-Year Avg',
                            data: usaAvgData,
                            borderColor: 'rgba(59, 130, 246, 0.4)',
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.3,
                            borderWidth: 1.5,
                            pointRadius: 0
                        },
                        {
                            label: 'Canada 5-Year Avg',
                            data: canadaAvgData,
                            borderColor: 'rgba(239, 68, 68, 0.4)',
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.3,
                            borderWidth: 1.5,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#8892a2',
                                usePointStyle: false,
                                boxWidth: 30,
                                boxHeight: 2,
                                padding: 15,
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(17, 24, 32, 0.95)',
                            titleColor: '#e8ecf2',
                            bodyColor: '#8892a2',
                            borderColor: '#2a3444',
                            borderWidth: 1,
                            callbacks: {
                                title: function(context) {
                                    if (!context || !context[0]) return '';
                                    const idx = context[0].dataIndex;
                                    const dateInfo = seasonDates[idx];
                                    if (dateInfo) {
                                        return dateInfo.date.toLocaleDateString('en-US', {
                                            month: 'short',
                                            day: 'numeric',
                                            year: 'numeric'
                                        });
                                    }
                                    return '';
                                },
                                label: function(context) {
                                    if (context.parsed.y === null) return null;
                                    return `${context.dataset.label}: ${context.parsed.y}%`;
                                }
                            },
                            filter: function(tooltipItem) {
                                return tooltipItem.parsed.y !== null;
                            }
                        },
                        annotation: {
                            annotations: holidayAnnotations
                        },
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'x',
                                modifierKey: 'shift',
                                onPanComplete: function({chart}) {
                                    if (window.chartSyncInProgress) return;
                                    window.chartSyncInProgress = true;
                                    try {
                                        // Sync temperature chart to same zoom range
                                        if (temperatureChart) {
                                            const xScale = chart.scales.x;
                                            temperatureChart.zoomScale('x', {min: xScale.min, max: xScale.max}, 'none');
                                        }
                                    } finally {
                                        window.chartSyncInProgress = false;
                                    }
                                }
                            },
                            zoom: {
                                drag: {
                                    enabled: true,
                                    backgroundColor: 'rgba(59, 130, 246, 0.2)',
                                    borderColor: 'rgba(59, 130, 246, 0.8)',
                                    borderWidth: 1
                                },
                                mode: 'x',
                                onZoomComplete: function({chart}) {
                                    // Show reset buttons when zoomed
                                    const resetBtn = document.getElementById('reset-zoom-btn');
                                    const resetTempBtn = document.getElementById('reset-temp-zoom-btn');
                                    if (resetBtn) resetBtn.style.display = 'block';
                                    if (resetTempBtn) resetTempBtn.style.display = 'block';

                                    // Sync temperature chart to same zoom range
                                    if (window.chartSyncInProgress) return;
                                    window.chartSyncInProgress = true;
                                    try {
                                        if (temperatureChart) {
                                            const xScale = chart.scales.x;
                                            temperatureChart.zoomScale('x', {min: xScale.min, max: xScale.max}, 'none');
                                        }
                                    } finally {
                                        window.chartSyncInProgress = false;
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'category',
                            title: {
                                display: true,
                                text: 'Winter 2025/26',
                                color: '#8892a2',
                                font: { size: 11, weight: 500 }
                            },
                            grid: { color: 'rgba(42, 52, 68, 0.5)' },
                            ticks: {
                                color: '#5c6678',
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 12,
                                callback: function(value, index) {
                                    // Show label only on 1st of month with year
                                    const dateInfo = seasonDates[index];
                                    if (dateInfo && dateInfo.date.getDate() === 1) {
                                        const month = dateInfo.date.toLocaleDateString('en-US', { month: 'short' });
                                        const year = String(dateInfo.date.getFullYear()).slice(-2);
                                        return `${month} ${year}`;
                                    }
                                    return '';
                                }
                            }
                        },
                        y: {
                            min: 0,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Percent of Landmass Covered in Snow',
                                color: '#8892a2',
                                font: { size: 11, weight: 500 }
                            },
                            grid: { color: 'rgba(42, 52, 68, 0.5)' },
                            ticks: {
                                color: '#5c6678',
                                callback: value => value + '%'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });

            // Set up reset zoom button - resets both charts
            const resetBtn = document.getElementById('reset-zoom-btn');
            if (resetBtn) {
                resetBtn.addEventListener('click', function() {
                    resetBothCharts();
                });
            }

            // Double-click to reset zoom - resets both charts
            ctx.canvas.addEventListener('dblclick', function() {
                resetBothCharts();
            });
        }

        // Reset both charts to full view
        function resetBothCharts() {
            const resetBtn = document.getElementById('reset-zoom-btn');
            const resetTempBtn = document.getElementById('reset-temp-zoom-btn');
            if (nationalChart) nationalChart.resetZoom();
            if (temperatureChart) temperatureChart.resetZoom();
            if (resetBtn) resetBtn.style.display = 'none';
            if (resetTempBtn) resetTempBtn.style.display = 'none';
        }

        // Draw Temperature Anomaly Chart
        function drawTemperatureChart() {
            console.log('drawTemperatureChart called');
            const ctx = document.getElementById('temperature-chart');
            if (!ctx) {
                console.warn('drawTemperatureChart: No canvas element found');
                return;
            }

            if (temperatureChart) {
                temperatureChart.destroy();
            }
            console.log('drawTemperatureChart: temperatureHistoryData available:', !!temperatureHistoryData);

            // Build full season date range (Oct 1 2025 - Apr 30 2026)
            const seasonDates = [];
            let d = new Date(2025, 9, 1); // Oct 1, 2025
            const endDate = new Date(2026, 3, 30); // Apr 30, 2026

            while (d <= endDate) {
                seasonDates.push({
                    date: new Date(d),
                    mmdd: `${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`,
                    fullDate: `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`
                });
                d.setDate(d.getDate() + 1);
            }

            // Build temperature anomaly data from REAL temperature-history.json
            // This contains per-metro historical data from Open-Meteo
            // Fallback: if temperature history not available, use current snowData temps

            // Build indexed lookup of anomalies by date
            const usaAnomalyByDate = {};
            const canadaAnomalyByDate = {};

            // Process temperature history - average anomalies across metros for each date
            if (temperatureHistoryData?.metros) {
                // Collect all anomalies by date
                const usaDateAnomalies = {};
                const canadaDateAnomalies = {};

                Object.entries(temperatureHistoryData.metros).forEach(([metroName, metroData]) => {
                    const isCanada = metroData.country === 'canada';
                    const targetMap = isCanada ? canadaDateAnomalies : usaDateAnomalies;

                    (metroData.history || []).forEach(entry => {
                        // Only include current season (2025-10-01 onwards)
                        if (entry.date >= '2025-10-01' && entry.anomaly_c !== null && entry.anomaly_c !== undefined) {
                            if (!targetMap[entry.date]) {
                                targetMap[entry.date] = [];
                            }
                            // Convert C to F for display
                            targetMap[entry.date].push(entry.anomaly_c * 9/5);
                        }
                    });
                });

                // Calculate average anomaly for each date
                Object.entries(usaDateAnomalies).forEach(([date, anomalies]) => {
                    if (anomalies.length > 0) {
                        usaAnomalyByDate[date] = anomalies.reduce((a, b) => a + b, 0) / anomalies.length;
                    }
                });

                Object.entries(canadaDateAnomalies).forEach(([date, anomalies]) => {
                    if (anomalies.length > 0) {
                        canadaAnomalyByDate[date] = anomalies.reduce((a, b) => a + b, 0) / anomalies.length;
                    }
                });
            }

            // Fallback: Get current day anomaly from snowData if temperature history not available
            let fallbackUsaAnomaly = null;
            let fallbackCanadaAnomaly = null;
            if (!temperatureHistoryData && snowData) {
                const usaTemp = snowData.usa?.temperature;
                const canadaTemp = snowData.canada?.temperature;
                fallbackUsaAnomaly = usaTemp?.avg_anomaly_f ?? null;
                fallbackCanadaAnomaly = canadaTemp?.avg_anomaly_f ?? null;
            }

            // Build data arrays using REAL historical data
            const labels = [];
            const usaData = [];
            const canadaData = [];
            const zeroLine = [];

            const today = new Date();
            today.setHours(23, 59, 59, 999);
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

            seasonDates.forEach((item, idx) => {
                // Create label showing month name on 1st of each month
                if (item.date.getDate() === 1) {
                    labels.push(item.date.toLocaleDateString('en-US', { month: 'short' }));
                } else {
                    labels.push('');
                }

                zeroLine.push(0); // Baseline (normal)

                // Use REAL historical data from temperature-history.json
                if (item.date <= today) {
                    const dateKey = item.fullDate;

                    // Try temperature history first, fallback to current day snowData
                    let usaVal = usaAnomalyByDate[dateKey];
                    let canadaVal = canadaAnomalyByDate[dateKey];

                    // For today, use fallback if no history data
                    if (usaVal === undefined && dateKey === todayStr) {
                        usaVal = fallbackUsaAnomaly;
                    }
                    if (canadaVal === undefined && dateKey === todayStr) {
                        canadaVal = fallbackCanadaAnomaly;
                    }

                    usaData.push(usaVal !== undefined && usaVal !== null ? Math.round(usaVal * 10) / 10 : null);
                    canadaData.push(canadaVal !== undefined && canadaVal !== null ? Math.round(canadaVal * 10) / 10 : null);
                } else {
                    usaData.push(null);
                    canadaData.push(null);
                }
            });

            // Holiday annotations - same as snow chart
            const holidayAnnotations = {};
            WINTER_HOLIDAYS.forEach((holiday, idx) => {
                const hStart = new Date(holiday.start + 'T00:00:00');
                const hEnd = new Date(holiday.end + 'T00:00:00');

                const startIdx = seasonDates.findIndex(item =>
                    item.date.getFullYear() === hStart.getFullYear() &&
                    item.date.getMonth() === hStart.getMonth() &&
                    item.date.getDate() === hStart.getDate()
                );
                const endIdx = seasonDates.findIndex(item =>
                    item.date.getFullYear() === hEnd.getFullYear() &&
                    item.date.getMonth() === hEnd.getMonth() &&
                    item.date.getDate() === hEnd.getDate()
                );

                if (startIdx >= 0 && endIdx >= 0) {
                    holidayAnnotations[`holiday${idx}`] = {
                        type: 'box',
                        xMin: startIdx - 0.5,
                        xMax: endIdx + 0.5,
                        backgroundColor: 'rgba(128, 128, 128, 0.12)',
                        borderWidth: 0
                    };
                }
            });

            temperatureChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'USA Temperature Anomaly',
                            data: usaData,
                            borderColor: '#3b82f6',
                            backgroundColor: function(context) {
                                const value = context.parsed?.y;
                                if (value === null || value === undefined) return 'transparent';
                                return value > 0 ? 'rgba(239, 68, 68, 0.3)' : 'rgba(59, 130, 246, 0.3)';
                            },
                            fill: 'origin',
                            tension: 0.3,
                            borderWidth: 2,
                            pointRadius: 3,
                            pointBackgroundColor: function(context) {
                                const value = context.parsed?.y;
                                if (value === null || value === undefined) return '#3b82f6';
                                return value > 0 ? '#ef4444' : '#3b82f6';
                            },
                            spanGaps: false
                        },
                        {
                            label: 'Canada Temperature Anomaly',
                            data: canadaData,
                            borderColor: '#ef4444',
                            backgroundColor: function(context) {
                                const value = context.parsed?.y;
                                if (value === null || value === undefined) return 'transparent';
                                return value > 0 ? 'rgba(239, 68, 68, 0.2)' : 'rgba(59, 130, 246, 0.2)';
                            },
                            fill: 'origin',
                            tension: 0.3,
                            borderWidth: 2,
                            pointRadius: 3,
                            pointBackgroundColor: function(context) {
                                const value = context.parsed?.y;
                                if (value === null || value === undefined) return '#ef4444';
                                return value > 0 ? '#ef4444' : '#3b82f6';
                            },
                            spanGaps: false
                        },
                        {
                            label: 'Normal (0F)',
                            data: zeroLine,
                            borderColor: 'rgba(100, 100, 100, 0.5)',
                            borderDash: [3, 3],
                            fill: false,
                            borderWidth: 1,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#8892a2',
                                usePointStyle: false,
                                boxWidth: 30,
                                boxHeight: 2,
                                padding: 15,
                                font: { size: 11 },
                                filter: function(item) {
                                    return item.text !== 'Normal (0F)';
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(17, 24, 32, 0.95)',
                            titleColor: '#e8ecf2',
                            bodyColor: '#8892a2',
                            borderColor: '#2a3444',
                            borderWidth: 1,
                            callbacks: {
                                title: function(context) {
                                    if (!context || !context[0]) return '';
                                    const idx = context[0].dataIndex;
                                    const dateInfo = seasonDates[idx];
                                    if (dateInfo) {
                                        return dateInfo.date.toLocaleDateString('en-US', {
                                            month: 'short',
                                            day: 'numeric',
                                            year: 'numeric'
                                        });
                                    }
                                    return '';
                                },
                                label: function(context) {
                                    if (context.parsed.y === null) return null;
                                    if (context.dataset.label === 'Normal (0F)') return null;
                                    const sign = context.parsed.y > 0 ? '+' : '';
                                    const status = context.parsed.y > 0 ? 'warmer' : 'colder';
                                    return `${context.dataset.label.replace(' Temperature Anomaly', '')}: ${sign}${context.parsed.y.toFixed(1)}F (${status} than normal)`;
                                }
                            },
                            filter: function(tooltipItem) {
                                return tooltipItem.parsed.y !== null && tooltipItem.dataset.label !== 'Normal (0F)';
                            }
                        },
                        annotation: {
                            annotations: holidayAnnotations
                        },
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'x',
                                modifierKey: 'shift',
                                onPanComplete: function({chart}) {
                                    if (window.chartSyncInProgress) return;
                                    window.chartSyncInProgress = true;
                                    try {
                                        // Sync snow cover chart to same zoom range
                                        if (nationalChart) {
                                            const xScale = chart.scales.x;
                                            nationalChart.zoomScale('x', {min: xScale.min, max: xScale.max}, 'none');
                                        }
                                    } finally {
                                        window.chartSyncInProgress = false;
                                    }
                                }
                            },
                            zoom: {
                                drag: {
                                    enabled: true,
                                    backgroundColor: 'rgba(59, 130, 246, 0.2)',
                                    borderColor: 'rgba(59, 130, 246, 0.8)',
                                    borderWidth: 1
                                },
                                mode: 'x',
                                onZoomComplete: function({chart}) {
                                    // Show reset buttons when zoomed
                                    const resetBtn = document.getElementById('reset-zoom-btn');
                                    const resetTempBtn = document.getElementById('reset-temp-zoom-btn');
                                    if (resetBtn) resetBtn.style.display = 'block';
                                    if (resetTempBtn) resetTempBtn.style.display = 'block';

                                    // Sync snow cover chart to same zoom range
                                    if (window.chartSyncInProgress) return;
                                    window.chartSyncInProgress = true;
                                    try {
                                        if (nationalChart) {
                                            const xScale = chart.scales.x;
                                            nationalChart.zoomScale('x', {min: xScale.min, max: xScale.max}, 'none');
                                        }
                                    } finally {
                                        window.chartSyncInProgress = false;
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'category',
                            title: {
                                display: true,
                                text: 'Winter 2025/26',
                                color: '#8892a2',
                                font: { size: 11, weight: 500 }
                            },
                            grid: { color: 'rgba(42, 52, 68, 0.5)' },
                            ticks: {
                                color: '#5c6678',
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 12,
                                callback: function(value, index) {
                                    const dateInfo = seasonDates[index];
                                    if (dateInfo && dateInfo.date.getDate() === 1) {
                                        const month = dateInfo.date.toLocaleDateString('en-US', { month: 'short' });
                                        const year = String(dateInfo.date.getFullYear()).slice(-2);
                                        return `${month} ${year}`;
                                    }
                                    return '';
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Temperature Anomaly (F vs Normal)',
                                color: '#8892a2',
                                font: { size: 11, weight: 500 }
                            },
                            grid: { color: 'rgba(42, 52, 68, 0.5)' },
                            ticks: {
                                color: '#5c6678',
                                callback: function(value) {
                                    const sign = value > 0 ? '+' : '';
                                    return `${sign}${value}F`;
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });

            // Set up reset zoom button for temperature chart - resets both charts
            const resetTempBtn = document.getElementById('reset-temp-zoom-btn');
            if (resetTempBtn) {
                resetTempBtn.addEventListener('click', function() {
                    resetBothCharts();
                });
            }

            // Double-click to reset zoom - resets both charts
            ctx.addEventListener('dblclick', function() {
                resetBothCharts();
            });
        }

        // ============================================
        // Tooltip
        // ============================================
        const tooltip = d3.select("#tooltip");

        function showTooltip(event, d) {
            const tempClass = d.tempAnomaly > 8 ? 'temp-warm' : d.tempAnomaly < 3 ? 'temp-cool' : 'temp-normal';
            const tempDisplay = d.temp !== null ? `${Math.round(d.temp)}F` : 'N/A';
            const anomalyDisplay = d.tempAnomaly !== null ? `${d.tempAnomaly > 0 ? '+' : ''}${d.tempAnomaly}F` : 'N/A';

            tooltip
                .classed("visible", true)
                .style("left", (event.clientX + 12) + "px")
                .style("top", (event.clientY - 10) + "px")
                .html(`
                    <div class="tooltip-title">${d.name}, ${d.state}</div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">Snow Cover</span>
                        <span class="tooltip-value">${d.snowCover}%</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">Snow Depth</span>
                        <span class="tooltip-value">${d.snowDepth}"</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">Temperature</span>
                        <span class="tooltip-value">${tempDisplay}</span>
                    </div>
                    <div class="tooltip-row">
                        <span class="tooltip-label">vs Normal</span>
                        <span class="tooltip-value ${tempClass}">${anomalyDisplay}</span>
                    </div>
                `);
        }

        function hideTooltip() {
            tooltip.classed("visible", false);
        }

        // ============================================
        // Map Drawing
        // ============================================
        function drawMap() {
            if (!usGeoData || !canadaGeoData || currentMarkets.length === 0) return;

            const container = document.getElementById("feeder-map");
            const width = container.clientWidth;
            const height = container.clientHeight;
            const config = getRegionConfig();

            const svg = d3.select("#feeder-map")
                .attr("width", width)
                .attr("height", height);

            svg.selectAll("*").remove();

            // Projection - use Albers USA-like for North America view
            let projection;

            if (currentRegion === 'north-america') {
                // Lambert conformal conic for full North America
                projection = d3.geoConicConformal()
                    .parallels([33, 55])
                    .rotate([98, 0])
                    .center([0, 48])
                    .scale(config.scale)
                    .translate([width / 2, height / 2]);
            } else if (currentRegion.startsWith('canada-')) {
                projection = d3.geoConicConformal()
                    .parallels([49, 77])
                    .rotate([config.center[0] * -1, 0])
                    .center([0, config.center[1]])
                    .scale(config.scale)
                    .translate([width / 2, height / 2]);
            } else {
                projection = d3.geoConicEqualArea()
                    .parallels([29.5, 45.5])
                    .rotate([config.center[0] * -1, 0])
                    .center([0, config.center[1]])
                    .scale(config.scale)
                    .translate([width / 2, height / 2]);
            }

            const path = d3.geoPath().projection(projection);

            // Helper function to get region for a US state
            function getUSRegionForState(stateId) {
                for (const [regionKey, region] of Object.entries(NSAA_REGIONS)) {
                    if (region.stateIds.includes(+stateId)) {
                        return { key: regionKey, ...region };
                    }
                }
                return null;
            }

            // Helper function to get region for a Canadian province
            function getCARegionForProvince(provinceName) {
                for (const [regionKey, region] of Object.entries(CSC_REGIONS)) {
                    if (region.provinces.some(p => provinceName.includes(p) || p.includes(provinceName))) {
                        return { key: regionKey, ...region };
                    }
                }
                return null;
            }

            // Draw US states with region coloring
            if (usGeoData) {
                svg.append("g")
                    .selectAll("path.us-state")
                    .data(usGeoData.features)
                    .enter()
                    .append("path")
                    .attr("class", "state-path")
                    .attr("d", path)
                    .attr("fill", d => {
                        if (currentRegion === 'north-america') {
                            const region = getUSRegionForState(d.id);
                            return region ? region.color : 'var(--geo-fill)';
                        }
                        return 'var(--geo-fill)';
                    })
                    .style("cursor", currentRegion === 'north-america' ? 'pointer' : 'default')
                    .on("click", function(event, d) {
                        if (currentRegion === 'north-america') {
                            const region = getUSRegionForState(d.id);
                            if (region) {
                                selectRegion(region.key);
                            }
                        }
                    })
                    .on("mouseover", function(event, d) {
                        if (currentRegion === 'north-america') {
                            const region = getUSRegionForState(d.id);
                            if (region) {
                                d3.select(this).attr("fill", region.color.replace('0.15', '0.35'));
                            }
                        }
                    })
                    .on("mouseout", function(event, d) {
                        if (currentRegion === 'north-america') {
                            const region = getUSRegionForState(d.id);
                            d3.select(this).attr("fill", region ? region.color : 'var(--geo-fill)');
                        }
                    });
            }

            // Draw Canada provinces with region coloring
            if (canadaGeoData) {
                svg.append("g")
                    .selectAll("path.ca-province")
                    .data(canadaGeoData.features)
                    .enter()
                    .append("path")
                    .attr("class", "state-path")
                    .attr("d", path)
                    .attr("fill", d => {
                        if (currentRegion === 'north-america') {
                            const region = getCARegionForProvince(d.properties.name);
                            return region ? region.color : 'var(--geo-fill)';
                        }
                        return 'var(--geo-fill)';
                    })
                    .style("cursor", currentRegion === 'north-america' ? 'pointer' : 'default')
                    .on("click", function(event, d) {
                        if (currentRegion === 'north-america') {
                            const region = getCARegionForProvince(d.properties.name);
                            if (region) {
                                selectRegion(region.key);
                            }
                        }
                    })
                    .on("mouseover", function(event, d) {
                        if (currentRegion === 'north-america') {
                            const region = getCARegionForProvince(d.properties.name);
                            if (region) {
                                d3.select(this).attr("fill", region.color.replace('0.15', '0.35'));
                            }
                        }
                    })
                    .on("mouseout", function(event, d) {
                        if (currentRegion === 'north-america') {
                            const region = getCARegionForProvince(d.properties.name);
                            d3.select(this).attr("fill", region ? region.color : 'var(--geo-fill)');
                        }
                    });
            }

            // Draw region borders (thicker outlines around NSAA/CSC regions)
            if (currentRegion === 'north-america') {
                // US NSAA region borders
                const usRegionBordersGroup = svg.append("g").attr("class", "region-borders");

                for (const [regionKey, region] of Object.entries(NSAA_REGIONS)) {
                    // Filter states in this region
                    const regionStates = usGeoData.features.filter(d => region.stateIds.includes(+d.id));

                    if (regionStates.length > 0) {
                        // Draw each state's border with region color
                        usRegionBordersGroup.selectAll(`.region-border-${regionKey}`)
                            .data(regionStates)
                            .enter()
                            .append("path")
                            .attr("class", `region-border region-border-${regionKey}`)
                            .attr("d", path)
                            .attr("fill", "none")
                            .attr("stroke", region.color.replace('0.15', '0.6'))
                            .attr("stroke-width", 2)
                            .style("pointer-events", "none");
                    }
                }

                // Canadian CSC region borders
                const caRegionBordersGroup = svg.append("g").attr("class", "ca-region-borders");

                for (const [regionKey, region] of Object.entries(CSC_REGIONS)) {
                    // Filter provinces in this region
                    const regionProvinces = canadaGeoData.features.filter(d =>
                        region.provinces.some(p => d.properties.name && (d.properties.name.includes(p) || p.includes(d.properties.name)))
                    );

                    if (regionProvinces.length > 0) {
                        caRegionBordersGroup.selectAll(`.region-border-${regionKey}`)
                            .data(regionProvinces)
                            .enter()
                            .append("path")
                            .attr("class", `region-border region-border-${regionKey}`)
                            .attr("d", path)
                            .attr("fill", "none")
                            .attr("stroke", region.color.replace('0.15', '0.6'))
                            .attr("stroke-width", 2)
                            .style("pointer-events", "none");
                    }
                }

                // Add region labels
                const labelsGroup = svg.append("g").attr("class", "region-labels");

                // NSAA region label positions (approximate centroids)
                const nsaaLabelPositions = {
                    'rocky-mountain': { lng: -108, lat: 40.5 },
                    'pacific-northwest': { lng: -121, lat: 46 },
                    'pacific-southwest': { lng: -119, lat: 37 },
                    'midwest': { lng: -92, lat: 43 },
                    'northeast': { lng: -74, lat: 43 },
                    'southeast': { lng: -80, lat: 37 }
                };

                // CSC region label positions
                const cscLabelPositions = {
                    'canada-bc': { lng: -125, lat: 54 },
                    'canada-alberta': { lng: -115, lat: 54 },
                    'canada-prairies': { lng: -102, lat: 52 },
                    'canada-ontario': { lng: -85, lat: 50 },
                    'canada-quebec': { lng: -72, lat: 52 },
                    'canada-atlantic': { lng: -63, lat: 47 }
                };

                // Draw NSAA labels
                for (const [regionKey, region] of Object.entries(NSAA_REGIONS)) {
                    const pos = nsaaLabelPositions[regionKey];
                    if (pos) {
                        const coords = projection([pos.lng, pos.lat]);
                        if (coords) {
                            labelsGroup.append("text")
                                .attr("class", "region-label")
                                .attr("x", coords[0])
                                .attr("y", coords[1])
                                .attr("text-anchor", "middle")
                                .attr("fill", region.color.replace('0.15', '0.9'))
                                .attr("font-size", "10px")
                                .attr("font-weight", "600")
                                .style("pointer-events", "none")
                                .style("text-shadow", "0 0 3px rgba(0,0,0,0.8), 0 0 6px rgba(0,0,0,0.5)")
                                .text(region.name);
                        }
                    }
                }

                // Draw CSC labels
                for (const [regionKey, region] of Object.entries(CSC_REGIONS)) {
                    const pos = cscLabelPositions[regionKey];
                    if (pos) {
                        const coords = projection([pos.lng, pos.lat]);
                        if (coords) {
                            labelsGroup.append("text")
                                .attr("class", "region-label")
                                .attr("x", coords[0])
                                .attr("y", coords[1])
                                .attr("text-anchor", "middle")
                                .attr("fill", region.color.replace('0.15', '0.9'))
                                .attr("font-size", "10px")
                                .attr("font-weight", "600")
                                .style("pointer-events", "none")
                                .style("text-shadow", "0 0 3px rgba(0,0,0,0.8), 0 0 6px rgba(0,0,0,0.5)")
                                .text(region.name);
                        }
                    }
                }
            }

            // Color scale for snow depth
            const colorScale = d3.scaleLinear()
                .domain([0, 2, 4, 6])
                .range(["#475569", "#1e40af", "#60a5fa", "#dbeafe"])
                .clamp(true);

            // Size scale for importance - smaller bubbles for North America view
            const maxPop = d3.max(currentMarkets, d => d.importance);
            const minRadius = currentRegion === 'north-america' ? 3 : 5;
            const maxRadius = currentRegion === 'north-america' ? 18 : 32;
            const sizeScale = d3.scaleSqrt()
                .domain([0, maxPop])
                .range([minRadius, maxRadius]);

            // Draw market bubbles
            svg.selectAll(".metro-bubble")
                .data(currentMarkets)
                .enter()
                .append("circle")
                .attr("class", "metro-bubble")
                .attr("cx", d => {
                    const coords = projection([d.lng, d.lat]);
                    return coords ? coords[0] : 0;
                })
                .attr("cy", d => {
                    const coords = projection([d.lng, d.lat]);
                    return coords ? coords[1] : 0;
                })
                .attr("r", d => sizeScale(d.importance))
                .attr("fill", d => colorScale(d.snowDepth))
                .attr("opacity", 0.85)
                .on("mouseover", showTooltip)
                .on("mouseout", hideTooltip);

            // Labels for large markets (skip for North America to reduce clutter)
            if (currentRegion !== 'north-america') {
                svg.selectAll(".metro-label")
                    .data(currentMarkets.filter(d => d.importance >= 1000))
                    .enter()
                    .append("text")
                    .attr("class", "metro-label")
                    .attr("x", d => {
                        const coords = projection([d.lng, d.lat]);
                        return coords ? coords[0] : 0;
                    })
                    .attr("y", d => {
                        const coords = projection([d.lng, d.lat]);
                        return coords ? coords[1] + sizeScale(d.importance) + 10 : 0;
                    })
                    .attr("text-anchor", "middle")
                    .text(d => d.name);
            }
        }

        // ============================================
        // Market Table
        // ============================================
        function renderMarketTable() {
            const tbody = document.getElementById("market-table-body");
            const sorted = [...currentMarkets].sort((a, b) => b.importance - a.importance);

            const colorScale = d3.scaleLinear()
                .domain([0, 2, 4, 6])
                .range(["#475569", "#1e40af", "#60a5fa", "#dbeafe"])
                .clamp(true);

            tbody.innerHTML = sorted.map(d => {
                const tempClass = d.tempAnomaly > 8 ? 'temp-warm' : d.tempAnomaly < 3 ? 'temp-cool' : 'temp-normal';
                const awarenessClass = `awareness-${d.awareness}`;
                const tempDisplay = d.temp !== null ? `${Math.round(d.temp)}` : '--';
                const anomalyDisplay = d.tempAnomaly !== null ? `${d.tempAnomaly > 0 ? '+' : ''}${d.tempAnomaly}` : '--';

                return `
                    <tr>
                        <td>
                            <div class="market-name-cell">
                                <div class="snow-dot" style="background: ${colorScale(d.snowDepth)}"></div>
                                <span class="market-name">${d.name}</span>
                                <span class="market-state">${d.state}</span>
                            </div>
                        </td>
                        <td>${d.snowCover}%</td>
                        <td>${d.snowDepth}"</td>
                        <td>${tempDisplay}</td>
                        <td class="${tempClass}">${anomalyDisplay}</td>
                        <td><span class="awareness-badge ${awarenessClass}">${d.awareness}</span></td>
                    </tr>
                `;
            }).join('');
        }

        // ============================================
        // Summary Stats
        // ============================================
        function renderSummaryStats() {
            const container = document.getElementById("summary-stats");

            if (currentMarkets.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted); text-align: center;">No data available</div>';
                return;
            }

            // Use national combined snow cover instead of market average
            const avgSnowCover = snowData?.combined?.cover ?? '--';

            // Use national combined temperature anomaly
            const avgTempAnomaly = snowData?.combined?.temperature?.avg_anomaly_f ?? '--';

            const marketsWithSnow = currentMarkets.filter(m => m.snowCover > 0).length;
            const lowAwarenessCount = currentMarkets.filter(m => m.awareness === 'low').length;

            container.innerHTML = `
                <div class="summary-stat">
                    <div class="summary-label">Avg Snow Cover</div>
                    <div class="summary-value" style="color: ${avgSnowCover !== '--' && avgSnowCover < 30 ? 'var(--accent-warm)' : 'var(--text-primary)'}">${avgSnowCover !== '--' ? Math.round(avgSnowCover) + '%' : '--'}</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-label">Temp Anomaly</div>
                    <div class="summary-value" style="color: ${avgTempAnomaly !== '--' && avgTempAnomaly > 5 ? 'var(--accent-warm-bright)' : 'var(--text-primary)'}">${avgTempAnomaly !== '--' ? (avgTempAnomaly > 0 ? '+' : '') + avgTempAnomaly.toFixed(1) + '' : '--'}</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-label">w/ Snow</div>
                    <div class="summary-value">${marketsWithSnow}/${currentMarkets.length}</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-label">Low Aware</div>
                    <div class="summary-value" style="color: ${lowAwarenessCount > 3 ? 'var(--danger)' : 'var(--text-primary)'}">${lowAwarenessCount}</div>
                </div>
            `;
        }

        // ============================================
        // Market Insight
        // ============================================
        function renderInsight() {
            const container = document.getElementById("insight-box");
            const lowAwareness = currentMarkets.filter(m => m.awareness === 'low');
            const highAwareness = currentMarkets.filter(m => m.awareness === 'high');
            const config = getRegionConfig();

            let insightText;
            if (currentMarkets.length === 0) {
                insightText = 'No market data available for this region.';
            } else if (lowAwareness.length >= 4) {
                const names = lowAwareness.slice(0, 3).map(m => m.name).join(', ');
                insightText = `${lowAwareness.length} markets (${names}, etc.) have no snow cover and above-normal temperatures. Skiing is unlikely to be top-of-mind for consumers in these areas.`;
            } else if (lowAwareness.length > 0) {
                const names = lowAwareness.map(m => m.name).join(', ');
                insightText = `${names} ${lowAwareness.length === 1 ? 'has' : 'have'} no visible snow cover and warm conditions. Winter awareness is likely low in ${lowAwareness.length === 1 ? 'this market' : 'these markets'}.`;
            } else if (highAwareness.length === currentMarkets.length) {
                insightText = `All ski markets are experiencing winter conditions with snow on the ground. Organic awareness of ski season is likely high.`;
            } else {
                insightText = `Most ski markets are seeing some winter conditions. ${highAwareness.length} of ${currentMarkets.length} markets have significant snow cover.`;
            }

            container.innerHTML = `
                <div class="insight-header">
                    <svg class="insight-icon" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 1.5a.5.5 0 0 1 .5.5v5a.5.5 0 0 1-1 0V2a.5.5 0 0 1 .5-.5zm0 9a.75.75 0 1 1 0 1.5.75.75 0 0 1 0-1.5z"/>
                        <path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zM1 8a7 7 0 1 1 14 0A7 7 0 0 1 1 8z"/>
                    </svg>
                    <span class="insight-title">Market Insight</span>
                </div>
                <div class="insight-text">${insightText}</div>
            `;
        }

        // ============================================
        // Headline Insight
        // ============================================
        function updateHeadlineInsight() {
            const titleEl = document.getElementById("headline-title");
            const subtitleEl = document.getElementById("headline-subtitle");
            const config = getRegionConfig();

            // Skip if elements don't exist
            if (!titleEl || !subtitleEl) return;

            if (currentMarkets.length === 0) {
                titleEl.textContent = 'Select a region to view conditions';
                subtitleEl.textContent = 'Choose a ski market region above to see snow cover insights.';
                return;
            }

            // Calculate key metrics
            const avgSnow = currentMarkets.reduce((sum, m) => sum + (m.cover || 0), 0) / currentMarkets.length;
            const marketsWithSnow = currentMarkets.filter(m => m.cover > 0).length;
            const lowAwareness = currentMarkets.filter(m => m.awareness === 'low').length;
            const highAwareness = currentMarkets.filter(m => m.awareness === 'high').length;

            // Calculate avg temp anomaly
            const tempAnomalies = currentMarkets.filter(m => m.tempAnomaly !== undefined).map(m => m.tempAnomaly);
            const avgTempAnomaly = tempAnomalies.length > 0
                ? tempAnomalies.reduce((a, b) => a + b, 0) / tempAnomalies.length
                : 0;

            // Generate headline based on conditions
            let title, subtitle, badgeClass, badgeText;

            if (highAwareness === currentMarkets.length) {
                title = `${config.name}: Snow in all ski markets`;
                subtitle = `All ${currentMarkets.length} markets have snow on the ground with seasonable temperatures.`;
                badgeClass = 'positive';
                badgeText = 'High Awareness';
            } else if (lowAwareness >= Math.ceil(currentMarkets.length * 0.6)) {
                title = `${config.name}: Limited snow visibility`;
                subtitle = `${lowAwareness} of ${currentMarkets.length} markets have no snow cover and above-normal temperatures.`;
                badgeClass = 'negative';
                badgeText = 'Low Awareness';
            } else if (marketsWithSnow === 0) {
                title = `${config.name}: No snow cover in ski markets`;
                subtitle = `None of the ${currentMarkets.length} tracked markets currently have visible snow cover.`;
                badgeClass = 'negative';
                badgeText = 'No Snow Cover';
            } else if (avgTempAnomaly > 5) {
                title = `${config.name}: Above-normal temperatures`;
                subtitle = `Temps ${Math.round(avgTempAnomaly)} above normal. ${marketsWithSnow} of ${currentMarkets.length} markets have snow.`;
                badgeClass = 'neutral';
                badgeText = 'Warm Spell';
            } else {
                title = `${config.name}: Mixed conditions`;
                subtitle = `${marketsWithSnow} of ${currentMarkets.length} markets have snow. ${highAwareness} with high winter awareness.`;
                badgeClass = marketsWithSnow > currentMarkets.length / 2 ? 'positive' : 'neutral';
                badgeText = `${marketsWithSnow}/${currentMarkets.length} Snow`;
            }

            titleEl.innerHTML = title + ` <span class="headline-badge ${badgeClass}">${badgeText}</span>`;
            subtitleEl.textContent = subtitle;
        }

        // ============================================
        // Dashboard Update
        // ============================================
        function updateDashboard() {
            const config = getRegionConfig();
            currentMarkets = getRegionMarkets();

            document.getElementById("region-display").textContent = config.name;

            // Update chart titles based on current region
            const snowChartTitle = document.getElementById('snow-chart-title');
            if (snowChartTitle) {
                snowChartTitle.textContent = currentRegion === 'north-america'
                    ? 'National Snow Cover'
                    : `${config.name} Snow Cover`;
            }
            const tempChartTitle = document.getElementById('temp-chart-title');
            if (tempChartTitle) {
                tempChartTitle.textContent = currentRegion === 'north-america'
                    ? 'Temperature Anomaly'
                    : `${config.name} Temperature Anomaly`;
            }

            updateHeadlineInsight();
            drawMap();
            renderMarketTable();
            renderSummaryStats();
            renderInsight();

            // Analytics
            gtag('event', 'region_view', {
                region: currentRegion,
                region_name: config.name
            });
        }

        // ============================================
        // Region Selection
        // ============================================
        function selectRegion(regionKey) {
            currentRegion = regionKey;

            // Update the hidden dropdown
            const select = document.getElementById("region-select");
            if (select) {
                select.value = regionKey;
            }

            // Show/hide the reset button
            const resetMapBtn = document.getElementById('reset-map-btn');
            if (resetMapBtn) {
                resetMapBtn.style.display = regionKey === 'north-america' ? 'none' : 'block';
            }

            // Update dashboard
            updateDashboard();

            // Analytics
            gtag('event', 'region_select', {
                region: regionKey,
                method: 'map_click'
            });
        }

        function resetToNorthAmerica() {
            selectRegion('north-america');
        }

        // ============================================
        // Event Listeners
        // ============================================
        document.getElementById("region-select").addEventListener("change", function() {
            currentRegion = this.value;
            if (currentRegion === 'custom' && customSelectedMarkets.size === 0) {
                // Open sidebar to let user select markets
                openSidebar();
            } else {
                // Update reset button visibility
                const resetMapBtn = document.getElementById('reset-map-btn');
                if (resetMapBtn) {
                    resetMapBtn.style.display = currentRegion === 'north-america' ? 'none' : 'block';
                }
                updateDashboard();
            }
        });

        // Reset to North America button
        const resetMapBtn = document.getElementById('reset-map-btn');
        if (resetMapBtn) {
            resetMapBtn.addEventListener('click', resetToNorthAmerica);
        }

        window.addEventListener("resize", () => {
            drawMap();
        });

        // ============================================
        // Custom Market Selector Sidebar
        // ============================================

        function openSidebar() {
            document.getElementById('market-sidebar').classList.add('open');
            document.getElementById('sidebar-overlay').classList.add('visible');
            populateMarketList();
        }

        function closeSidebar() {
            document.getElementById('market-sidebar').classList.remove('open');
            document.getElementById('sidebar-overlay').classList.remove('visible');
        }

        function populateMarketList() {
            const container = document.getElementById('market-list');
            if (!snowData?.feederRegions) {
                container.innerHTML = '<p style="color: var(--text-muted); padding: 1rem;">No market data available</p>';
                return;
            }

            // Define region groupings - NSAA regions first, then Canada
            const regionOrder = [
                { id: 'rocky-mountain', group: 'NSAA Regions' },
                { id: 'pacific-northwest', group: 'NSAA Regions' },
                { id: 'pacific-southwest', group: 'NSAA Regions' },
                { id: 'midwest', group: 'NSAA Regions' },
                { id: 'northeast', group: 'NSAA Regions' },
                { id: 'southeast', group: 'NSAA Regions' },
                { id: 'canada-bc', group: 'Canada Ski Council' },
                { id: 'canada-alberta', group: 'Canada Ski Council' },
                { id: 'canada-prairies', group: 'Canada Ski Council' },
                { id: 'canada-ontario', group: 'Canada Ski Council' },
                { id: 'canada-quebec', group: 'Canada Ski Council' },
                { id: 'canada-atlantic', group: 'Canada Ski Council' }
            ];

            // Collect all unique markets with their regions
            const allMarkets = new Map(); // market name -> Set of region ids
            regionOrder.forEach(r => {
                const regionConfig = snowData.feederRegions[r.id];
                if (regionConfig?.markets) {
                    regionConfig.markets.forEach(market => {
                        if (!allMarkets.has(market)) {
                            allMarkets.set(market, new Set());
                        }
                        allMarkets.get(market).add(r.id);
                    });
                }
            });

            let html = '';
            let currentGroup = '';

            regionOrder.forEach(r => {
                const regionConfig = snowData.feederRegions[r.id];
                if (!regionConfig?.markets) return;

                // Add group header if this is a new group
                if (r.group !== currentGroup) {
                    currentGroup = r.group;
                    html += `<div class="market-group-header">${currentGroup}</div>`;
                }

                // Add region header
                html += `<div class="market-region">
                    <div class="market-region-header">
                        <span class="region-name">${regionConfig.name}</span>
                        <button class="region-select-all" data-region="${r.id}">Select All</button>
                    </div>
                    <div class="market-checkboxes">`;

                // Add markets for this region
                regionConfig.markets.forEach(market => {
                    const isChecked = customSelectedMarkets.has(market);
                    const metro = snowData.metros?.find(m => m.city === market);
                    const snowIcon = metro?.cover > 0 ? ' ' : '';
                    html += `
                        <label class="market-checkbox-label">
                            <input type="checkbox" class="market-checkbox" value="${market}" ${isChecked ? 'checked' : ''}>
                            <span class="market-name">${snowIcon}${market}</span>
                        </label>`;
                });

                html += `</div></div>`;
            });

            container.innerHTML = html;

            // Add event listeners to checkboxes
            container.querySelectorAll('.market-checkbox').forEach(cb => {
                cb.addEventListener('change', handleMarketToggle);
            });

            // Add event listeners to region "Select All" buttons
            container.querySelectorAll('.region-select-all').forEach(btn => {
                btn.addEventListener('click', handleRegionSelectAll);
            });

            updateSelectedCount();
        }

        function handleMarketToggle(e) {
            const market = e.target.value;
            if (e.target.checked) {
                customSelectedMarkets.add(market);
            } else {
                customSelectedMarkets.delete(market);
            }
            updateSelectedCount();
        }

        function handleRegionSelectAll(e) {
            const regionId = e.target.dataset.region;
            const regionConfig = snowData?.feederRegions?.[regionId];
            if (!regionConfig?.markets) return;

            // Select all markets in this region
            regionConfig.markets.forEach(market => {
                customSelectedMarkets.add(market);
            });

            // Update checkboxes in the sidebar
            document.querySelectorAll('.market-checkbox').forEach(cb => {
                if (customSelectedMarkets.has(cb.value)) {
                    cb.checked = true;
                }
            });

            updateSelectedCount();
        }

        function updateSelectedCount() {
            document.getElementById('selected-count').textContent = customSelectedMarkets.size;
        }

        function selectAllMarkets() {
            document.querySelectorAll('.market-checkbox').forEach(cb => {
                cb.checked = true;
                customSelectedMarkets.add(cb.value);
            });
            updateSelectedCount();
        }

        function clearAllMarkets() {
            document.querySelectorAll('.market-checkbox').forEach(cb => {
                cb.checked = false;
            });
            customSelectedMarkets.clear();
            updateSelectedCount();
        }

        function applyCustomSelection() {
            if (customSelectedMarkets.size === 0) {
                alert('Please select at least one market');
                return;
            }
            closeSidebar();
            currentRegion = 'custom';
            document.getElementById('region-select').value = 'custom';
            updateDashboard();
        }

        // Sidebar event listeners (only if elements exist)
        document.getElementById('customize-btn')?.addEventListener('click', openSidebar);
        document.getElementById('sidebar-close')?.addEventListener('click', closeSidebar);
        document.getElementById('sidebar-overlay')?.addEventListener('click', closeSidebar);
        document.getElementById('select-all-btn')?.addEventListener('click', selectAllMarkets);
        document.getElementById('clear-all-btn')?.addEventListener('click', clearAllMarkets);
        document.getElementById('apply-selection-btn')?.addEventListener('click', applyCustomSelection);

        // ============================================
        // Initialize
        // ============================================
        async function init() {
            console.log('init() called - DOMContentLoaded fired');
            try {
                await loadSnowData();
                console.log('loadSnowData complete, snowData:', !!snowData, 'historicalData:', !!historicalData);
            } catch (e) {
                console.error('init: loadSnowData failed:', e);
            }
            try {
                await loadGeoData();
                console.log('loadGeoData complete');
            } catch (e) {
                console.error('init: loadGeoData failed:', e);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOMContentLoaded event fired');
            initUnitsToggle();
            init();
        });

        // Refresh data every 5 minutes
        setInterval(loadSnowData, 300000);
    </script>
</body>
</html>
