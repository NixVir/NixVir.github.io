<!DOCTYPE html>
<html>
<head>
    <title>Economic Dashboard</title>
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-E2QD5PNRWE"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-E2QD5PNRWE');
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
            margin: 0;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 20px;
        }
        .section-title {
            font-size: 1.4em;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin: 30px 0 20px 0;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .metric-card {
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .metric-card h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1.1em;
        }
        .metric-card h4 a {
            color: #333;
            text-decoration: none;
        }
        .metric-card h4 a:hover {
            color: #3498db;
            text-decoration: underline;
        }
        .value {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
        }
        .period {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-top: 5px;
        }
        .chart-container {
            height: 150px;
            margin-top: 15px;
            position: relative;
        }
        canvas {
            width: 100% !important;
            height: 100% !important;
        }
        .positive { color: #27ae60; }
        .negative { color: #e74c3c; }
        .neutral { color: #3498db; }
        .change-indicator { font-size: 0.85em; margin-top: 4px; }
        .change-indicator .arrow { font-weight: bold; margin-right: 3px; }
        .change-indicator .yoy { margin-right: 8px; }
        .change-indicator .momentum { font-size: 0.9em; color: #7f8c8d; }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .metric-card {
                padding: 15px;
            }
            .value {
                font-size: 1.6em;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
</head>
<body>
    <h1>Economic & Market Dashboard</h1>
    <p class="subtitle">Last updated: <span id="last-update">Loading...</span></p>

    <!-- Economic Indicators Section -->
    <h2 class="section-title">Economic Indicators</h2>
    <div class="dashboard-grid">
        <div class="metric-card">
            <h4><a href="https://fred.stlouisfed.org/series/GDP" target="_blank" rel="noopener" title="Gross Domestic Product">GDP (Quarterly)</a></h4>
            <div id="gdp">Loading...</div>
            <div class="chart-container">
                <canvas id="chart-gdp"></canvas>
            </div>
        </div>
        <div class="metric-card">
            <h4><a href="https://fred.stlouisfed.org/series/UMCSENT" target="_blank" rel="noopener" title="University of Michigan Consumer Sentiment">Consumer Confidence</a></h4>
            <div id="consumer-confidence">Loading...</div>
            <div class="chart-container">
                <canvas id="chart-cc"></canvas>
            </div>
        </div>
        <div class="metric-card">
            <h4><a href="https://fred.stlouisfed.org/series/CPIAUCSL" target="_blank" rel="noopener" title="Consumer Price Index for All Urban Consumers">CPI (Consumer Price Index)</a></h4>
            <div id="cpi">Loading...</div>
            <div class="chart-container">
                <canvas id="chart-cpi"></canvas>
            </div>
        </div>
        <div class="metric-card">
            <h4><a href="https://fred.stlouisfed.org/series/UNRATE" target="_blank" rel="noopener" title="Unemployment Rate">Unemployment Rate</a></h4>
            <div id="unemployment">Loading...</div>
            <div class="chart-container">
                <canvas id="chart-unemp"></canvas>
            </div>
        </div>
        <div class="metric-card">
            <h4><a href="https://fred.stlouisfed.org/series/PAYEMS" target="_blank" rel="noopener" title="Total Nonfarm Payroll Employment">Employment (Thousands)</a></h4>
            <div id="employment">Loading...</div>
            <div class="chart-container">
                <canvas id="chart-emp"></canvas>
            </div>
        </div>
        <div class="metric-card">
            <h4><a href="https://fred.stlouisfed.org/series/CES0500000003" target="_blank" rel="noopener" title="Average Hourly Earnings">Average Hourly Wages</a></h4>
            <div id="wages">Loading...</div>
            <div class="chart-container">
                <canvas id="chart-wages"></canvas>
            </div>
        </div>
        <div class="metric-card">
            <h4><a href="https://fred.stlouisfed.org/series/HOUST" target="_blank" rel="noopener" title="Housing Starts: Total">Housing Starts (Thousands)</a></h4>
            <div id="housing">Loading...</div>
            <div class="chart-container">
                <canvas id="chart-housing"></canvas>
            </div>
        </div>
        <div class="metric-card">
            <h4><a href="https://www.frbsf.org/research-and-insights/data-and-indicators/daily-news-sentiment-index/" target="_blank" rel="noopener" title="SF Fed Daily News Sentiment Index">News Sentiment Index</a></h4>
            <div id="news-sentiment">Loading...</div>
            <div class="chart-container">
                <canvas id="chart-sentiment"></canvas>
            </div>
        </div>
    </div>

    <!-- Markets & Rates Section -->
    <h2 class="section-title">Markets & Interest Rates</h2>
    <div class="dashboard-grid">
        <div class="metric-card">
            <h4><a href="https://fred.stlouisfed.org/series/SP500" target="_blank" rel="noopener" title="S&P 500">S&P 500 Index</a></h4>
            <div id="sp500">Loading...</div>
            <div class="chart-container">
                <canvas id="chart-spy"></canvas>
            </div>
        </div>
        <div class="metric-card">
            <h4><a href="https://fred.stlouisfed.org/series/DFF" target="_blank" rel="noopener" title="Federal Funds Effective Rate">Fed Funds Rate</a></h4>
            <div id="fed-rate">Loading...</div>
            <div class="chart-container">
                <canvas id="chart-fed"></canvas>
            </div>
        </div>
        <div class="metric-card">
            <h4><a href="https://fred.stlouisfed.org/series/DGS10" target="_blank" rel="noopener" title="10-Year Treasury Constant Maturity Rate">10-Year Treasury Yield</a></h4>
            <div id="treasury">Loading...</div>
            <div class="chart-container">
                <canvas id="chart-treasury"></canvas>
            </div>
        </div>
        <div class="metric-card">
            <h4><a href="https://www.investopedia.com/terms/v/vix.asp" target="_blank" rel="noopener" title="CBOE Volatility Index - Market Fear Gauge">VIX Volatility Index</a></h4>
            <div id="vix">Loading...</div>
            <div class="chart-container">
                <canvas id="chart-vix"></canvas>
            </div>
        </div>
    </div>

    <!-- Currency Exchange Rates Section -->
    <h2 class="section-title">Currency Exchange Rates (Up = Stronger USD)</h2>
    <div class="dashboard-grid">
        <div class="metric-card">
            <h4><a href="https://fred.stlouisfed.org/series/DEXCAUS" target="_blank" rel="noopener" title="Canada / U.S. Foreign Exchange Rate">USD / Canadian Dollar</a></h4>
            <div id="usd-cad">Loading...</div>
            <div class="chart-container">
                <canvas id="chart-cad"></canvas>
            </div>
        </div>
        <div class="metric-card">
            <h4><a href="https://fred.stlouisfed.org/series/DEXUSEU" target="_blank" rel="noopener" title="U.S. / Euro Foreign Exchange Rate">USD / Euro</a></h4>
            <div id="usd-eur">Loading...</div>
            <div class="chart-container">
                <canvas id="chart-eur"></canvas>
            </div>
        </div>
        <div class="metric-card">
            <h4><a href="https://fred.stlouisfed.org/series/DEXUSUK" target="_blank" rel="noopener" title="U.S. / British Pound Foreign Exchange Rate">USD / British Pound</a></h4>
            <div id="usd-gbp">Loading...</div>
            <div class="chart-container">
                <canvas id="chart-gbp"></canvas>
            </div>
        </div>
        <div class="metric-card">
            <h4><a href="https://fred.stlouisfed.org/series/DEXJPUS" target="_blank" rel="noopener" title="Japan / U.S. Foreign Exchange Rate">USD / Japanese Yen</a></h4>
            <div id="usd-jpy">Loading...</div>
            <div class="chart-container">
                <canvas id="chart-jpy"></canvas>
            </div>
        </div>
        <div class="metric-card">
            <h4><a href="https://fred.stlouisfed.org/series/DEXCHUS" target="_blank" rel="noopener" title="China / U.S. Foreign Exchange Rate">USD / Chinese Yuan</a></h4>
            <div id="usd-cny">Loading...</div>
            <div class="chart-container">
                <canvas id="chart-cny"></canvas>
            </div>
        </div>
        <div class="metric-card">
            <h4><a href="https://fred.stlouisfed.org/series/DEXINUS" target="_blank" rel="noopener" title="India / U.S. Foreign Exchange Rate">USD / Indian Rupee</a></h4>
            <div id="usd-inr">Loading...</div>
            <div class="chart-container">
                <canvas id="chart-inr"></canvas>
            </div>
        </div>
        <div class="metric-card">
            <h4><a href="https://fred.stlouisfed.org/series/DEXUSAL" target="_blank" rel="noopener" title="Australia / U.S. Foreign Exchange Rate">USD / Australian Dollar</a></h4>
            <div id="usd-aud">Loading...</div>
            <div class="chart-container">
                <canvas id="chart-aud"></canvas>
            </div>
        </div>
        <div class="metric-card">
            <h4><a href="https://fred.stlouisfed.org/series/DEXMXUS" target="_blank" rel="noopener" title="Mexico / U.S. Foreign Exchange Rate">USD / Mexican Peso</a></h4>
            <div id="usd-mxn">Loading...</div>
            <div class="chart-container">
                <canvas id="chart-mxn"></canvas>
            </div>
        </div>
    </div>

    <!-- Commodities Section -->
    <h2 class="section-title">Commodities</h2>
    <div class="dashboard-grid">
        <div class="metric-card">
            <h4><a href="https://www.lbma.org.uk/prices-and-data/precious-metal-prices" target="_blank" rel="noopener" title="Gold Price (LBMA-style USD per troy ounce)">Gold (USD/oz)</a></h4>
            <div id="gold">Loading...</div>
            <div class="chart-container">
                <canvas id="chart-gold"></canvas>
            </div>
        </div>
        <div class="metric-card">
            <h4><a href="https://fred.stlouisfed.org/series/DCOILWTICO" target="_blank" rel="noopener" title="Crude Oil Prices: West Texas Intermediate">Crude Oil WTI (USD/bbl)</a></h4>
            <div id="crude-oil">Loading...</div>
            <div class="chart-container">
                <canvas id="chart-oil"></canvas>
            </div>
        </div>
        <div class="metric-card">
            <h4><a href="https://fred.stlouisfed.org/series/DHHNGSP" target="_blank" rel="noopener" title="Henry Hub Natural Gas Spot Price">Natural Gas (USD/MMBtu)</a></h4>
            <div id="natural-gas">Loading...</div>
            <div class="chart-container">
                <canvas id="chart-natgas"></canvas>
            </div>
        </div>
        <div class="metric-card">
            <h4><a href="https://fred.stlouisfed.org/series/PCOPPUSDM" target="_blank" rel="noopener" title="Global Price of Copper">Copper (USD/lb)</a></h4>
            <div id="copper">Loading...</div>
            <div class="chart-container">
                <canvas id="chart-copper"></canvas>
            </div>
        </div>
    </div>

    <script>
    // Store chart instances for cleanup
    const charts = {};

    // NBER Recession dates (recent recessions within data range)
    // Format: [start_date, end_date] - we only need recessions that might appear in ~1 year of data
    const NBER_RECESSIONS = [
        // COVID-19 recession
        ['2020-02-01', '2020-04-30'],
        // Great Recession
        ['2007-12-01', '2009-06-30'],
        // 2001 Recession
        ['2001-03-01', '2001-11-30'],
        // 1990-1991 Recession
        ['1990-07-01', '1991-03-31'],
        // 1981-1982 Recession
        ['1981-07-01', '1982-11-30'],
        // 1980 Recession
        ['1980-01-01', '1980-07-31']
    ];

    // Helper function to get recession annotations for a date range
    function getRecessionAnnotations(labels) {
        if (!labels || labels.length === 0) return {};

        // Parse the first and last label dates
        // Labels can be in formats like "Jan '24" or "Jan 5"
        const parseDate = (label) => {
            // Try to parse various date formats
            const fullDate = new Date(label);
            if (!isNaN(fullDate.getTime())) return fullDate;

            // Handle "Mon 'YY" format
            const match = label.match(/([A-Za-z]+)\s+'?(\d{2})/);
            if (match) {
                const months = ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'];
                const monthIdx = months.indexOf(match[1].toLowerCase());
                if (monthIdx !== -1) {
                    const year = 2000 + parseInt(match[2]);
                    return new Date(year, monthIdx, 15);
                }
            }
            return null;
        };

        const firstDate = parseDate(labels[0]);
        const lastDate = parseDate(labels[labels.length - 1]);

        if (!firstDate || !lastDate) return {};

        const annotations = {};

        NBER_RECESSIONS.forEach((recession, idx) => {
            const recStart = new Date(recession[0]);
            const recEnd = new Date(recession[1]);

            // Check if recession overlaps with our data range
            if (recEnd >= firstDate && recStart <= lastDate) {
                // Find the label indices that correspond to the recession period
                let startIdx = 0;
                let endIdx = labels.length - 1;

                labels.forEach((label, i) => {
                    const labelDate = parseDate(label);
                    if (labelDate) {
                        if (labelDate >= recStart && startIdx === 0) {
                            startIdx = Math.max(0, i - 1);
                        }
                        if (labelDate <= recEnd) {
                            endIdx = i;
                        }
                    }
                });

                // Only add if there's meaningful overlap
                if (endIdx > startIdx) {
                    annotations[`recession${idx}`] = {
                        type: 'box',
                        xMin: labels[startIdx],
                        xMax: labels[Math.min(endIdx + 1, labels.length - 1)],
                        backgroundColor: 'rgba(200, 200, 200, 0.3)',
                        borderWidth: 0
                    };
                }
            }
        });

        return annotations;
    }

    // Helper function to format date for display
    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
    }

    // Helper function to format short date for x-axis
    function formatShortDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    // Calculate year-over-year or period change
    function calcChange(data, isPercent = false) {
        if (!data || data.length < 2) return null;
        const latest = data[data.length - 1].value;
        const oldest = data[0].value;
        if (oldest === 0) return null;

        if (isPercent) {
            const change = latest - oldest;
            return { change: change, pctChange: null, isPointChange: true };
        } else {
            const pctChange = ((latest - oldest) / oldest) * 100;
            return { change: latest - oldest, pctChange: pctChange, isPointChange: false };
        }
    }

    // Calculate 30-day momentum for daily data
    function calc30DayMomentum(data, isPercent = false) {
        if (!data || data.length < 30) return null;
        const latest = data[data.length - 1].value;
        const thirtyDaysAgo = data[data.length - 30].value;
        if (thirtyDaysAgo === 0) return null;

        if (isPercent) {
            return { change: latest - thirtyDaysAgo, isPointChange: true };
        } else {
            const pctChange = ((latest - thirtyDaysAgo) / thirtyDaysAgo) * 100;
            return { pctChange: pctChange, isPointChange: false };
        }
    }

    // Get trend arrow based on change
    function getTrendArrow(change) {
        if (change > 0.5) return { arrow: '\u2191', class: 'positive' };
        if (change < -0.5) return { arrow: '\u2193', class: 'negative' };
        return { arrow: '\u2192', class: 'neutral' };
    }

    // Format change indicator HTML
    function formatChangeIndicator(changeData, momentumData = null, invertColors = false) {
        if (!changeData) return '';

        const change = changeData.pctChange !== null ? changeData.pctChange : changeData.change;
        const trend = getTrendArrow(change);

        let colorClass = trend.class;
        if (invertColors) {
            if (colorClass === 'positive') colorClass = 'negative';
            else if (colorClass === 'negative') colorClass = 'positive';
        }

        let changeText;
        if (changeData.isPointChange) {
            const sign = changeData.change >= 0 ? '+' : '';
            changeText = `${sign}${changeData.change.toFixed(2)} pts YoY`;
        } else {
            const sign = changeData.pctChange >= 0 ? '+' : '';
            changeText = `${sign}${changeData.pctChange.toFixed(1)}% YoY`;
        }

        let html = `<div class="change-indicator">`;
        html += `<span class="arrow ${colorClass}">${trend.arrow}</span>`;
        html += `<span class="yoy ${colorClass}">${changeText}</span>`;

        if (momentumData) {
            const momChange = momentumData.pctChange !== null ? momentumData.pctChange : momentumData.change;
            const momTrend = getTrendArrow(momChange);
            let momColorClass = momTrend.class;
            if (invertColors) {
                if (momColorClass === 'positive') momColorClass = 'negative';
                else if (momColorClass === 'negative') momColorClass = 'positive';
            }

            let momText;
            if (momentumData.isPointChange) {
                const sign = momentumData.change >= 0 ? '+' : '';
                momText = `(${sign}${momentumData.change.toFixed(2)} pts 30d)`;
            } else {
                const sign = momentumData.pctChange >= 0 ? '+' : '';
                momText = `(${sign}${momentumData.pctChange.toFixed(1)}% 30d)`;
            }
            html += `<span class="momentum ${momColorClass}">${momText}</span>`;
        }

        html += `</div>`;
        return html;
    }

    // Helper function to create charts with visible x-axis and optional recession shading
    function createChart(canvasId, labels, values, color = '#3498db', options = {}) {
        const ctx = document.getElementById(canvasId);
        if (!ctx) return;

        // Destroy existing chart if it exists
        if (charts[canvasId]) {
            charts[canvasId].destroy();
        }

        // Get recession annotations if this is an economic indicator chart
        const recessionAnnotations = options.showRecessions !== false ? getRecessionAnnotations(labels) : {};

        const defaultOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    displayColors: false,
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        },
                        label: function(context) {
                            const prefix = options.prefix || '';
                            const suffix = options.suffix || '';
                            return prefix + context.parsed.y.toLocaleString(undefined, {
                                minimumFractionDigits: options.decimals || 2,
                                maximumFractionDigits: options.decimals || 2
                            }) + suffix;
                        }
                    }
                },
                annotation: {
                    annotations: recessionAnnotations
                }
            },
            scales: {
                x: {
                    display: true,
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45,
                        font: { size: 10 },
                        color: '#7f8c8d',
                        maxTicksLimit: 6
                    },
                    grid: {
                        display: false
                    }
                },
                y: {
                    display: true,
                    ticks: {
                        font: { size: 10 },
                        color: '#7f8c8d',
                        callback: function(value) {
                            const prefix = options.prefix || '';
                            const suffix = options.suffix || '';
                            if (value >= 1000) {
                                return prefix + (value / 1000).toFixed(1) + 'K' + suffix;
                            }
                            return prefix + value.toLocaleString() + suffix;
                        }
                    },
                    grid: {
                        color: '#ecf0f1'
                    }
                }
            },
            interaction: {
                mode: 'index',
                intersect: false
            }
        };

        charts[canvasId] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    borderColor: color,
                    backgroundColor: color + '20',
                    borderWidth: 2,
                    fill: true,
                    pointRadius: 2,
                    pointHoverRadius: 5,
                    tension: 0.3
                }]
            },
            options: defaultOptions
        });
    }

    // Special chart for News Sentiment with fixed y-axis and colored bands
    function createSentimentChart(canvasId, labels, values) {
        const ctx = document.getElementById(canvasId);
        if (!ctx) return;

        // Destroy existing chart if it exists
        if (charts[canvasId]) {
            charts[canvasId].destroy();
        }

        // Get recession annotations
        const recessionAnnotations = getRecessionAnnotations(labels);

        // Add sentiment zone annotations (horizontal bands)
        const sentimentAnnotations = {
            ...recessionAnnotations,
            optimisticZone: {
                type: 'box',
                yMin: 0.05,
                yMax: 0.4,
                backgroundColor: 'rgba(39, 174, 96, 0.15)',
                borderWidth: 0
            },
            optimisticLabel: {
                type: 'label',
                xValue: labels[Math.floor(labels.length * 0.02)],
                yValue: 0.12,
                content: 'Optimistic',
                color: 'rgba(39, 174, 96, 0.7)',
                font: { size: 11, weight: 'bold' },
                position: 'start'
            },
            neutralZone: {
                type: 'box',
                yMin: -0.05,
                yMax: 0.05,
                backgroundColor: 'rgba(200, 200, 200, 0.2)',
                borderWidth: 0
            },
            neutralLabel: {
                type: 'label',
                xValue: labels[Math.floor(labels.length * 0.02)],
                yValue: 0,
                content: 'Neutral',
                color: 'rgba(120, 120, 120, 0.7)',
                font: { size: 11, weight: 'bold' },
                position: 'start'
            },
            pessimisticZone: {
                type: 'box',
                yMin: -0.4,
                yMax: -0.05,
                backgroundColor: 'rgba(231, 76, 60, 0.15)',
                borderWidth: 0
            },
            pessimisticLabel: {
                type: 'label',
                xValue: labels[Math.floor(labels.length * 0.02)],
                yValue: -0.12,
                content: 'Pessimistic',
                color: 'rgba(231, 76, 60, 0.7)',
                font: { size: 11, weight: 'bold' },
                position: 'start'
            },
            zeroLine: {
                type: 'line',
                yMin: 0,
                yMax: 0,
                borderColor: 'rgba(0, 0, 0, 0.3)',
                borderWidth: 1,
                borderDash: [5, 5]
            }
        };

        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    displayColors: false,
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        },
                        label: function(context) {
                            const val = context.parsed.y;
                            const sign = val >= 0 ? '+' : '';
                            let sentiment = 'Neutral';
                            if (val > 0.05) sentiment = 'Optimistic';
                            else if (val < -0.05) sentiment = 'Pessimistic';
                            return `${sign}${val.toFixed(3)} (${sentiment})`;
                        }
                    }
                },
                annotation: {
                    annotations: sentimentAnnotations
                }
            },
            scales: {
                x: {
                    display: true,
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45,
                        font: { size: 10 },
                        color: '#7f8c8d',
                        maxTicksLimit: 6
                    },
                    grid: {
                        display: false
                    }
                },
                y: {
                    display: true,
                    min: -0.25,
                    max: 0.15,
                    ticks: {
                        font: { size: 10 },
                        color: '#7f8c8d',
                        callback: function(value) {
                            const sign = value >= 0 ? '+' : '';
                            return sign + value.toFixed(2);
                        }
                    },
                    grid: {
                        color: '#ecf0f1'
                    }
                }
            },
            interaction: {
                mode: 'index',
                intersect: false
            }
        };

        charts[canvasId] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    borderColor: '#9b59b6',
                    backgroundColor: 'rgba(155, 89, 182, 0.2)',
                    borderWidth: 2,
                    fill: true,
                    pointRadius: 1,
                    pointHoverRadius: 5,
                    tension: 0.3
                }]
            },
            options: chartOptions
        });
    }

    // Calculate week-over-week change for sentiment
    function calcWeeklyChange(data) {
        if (!data || data.length < 8) return null;
        const latest = data[data.length - 1].value;
        const weekAgo = data[data.length - 8].value; // ~7 days ago
        return {
            current: latest,
            previous: weekAgo,
            change: latest - weekAgo
        };
    }

    // Format sentiment change text with colors
    function formatSentimentChange(weeklyData) {
        if (!weeklyData) return '';

        const change = weeklyData.change;
        const current = weeklyData.current;
        const sign = change >= 0 ? '+' : '';

        // Determine color based on direction of change
        let colorClass = '';
        let trendText = '';

        if (change > 0.005) {
            colorClass = 'positive';
            trendText = 'more optimistic';
        } else if (change < -0.005) {
            colorClass = 'negative';
            trendText = 'more pessimistic';
        } else {
            colorClass = '';
            trendText = 'stable';
        }

        // Determine current zone
        let zoneText = 'neutral';
        if (current > 0.05) zoneText = 'optimistic';
        else if (current < -0.05) zoneText = 'pessimistic';

        return `<div class="change-indicator">
            <span class="${colorClass}">${sign}${change.toFixed(3)} vs last week</span>
            <span class="momentum ${colorClass}">(${trendText}, currently ${zoneText})</span>
        </div>`;
    }

    async function loadDashboard() {
        try {
            const response = await fetch("/data/dashboard.json");
            const data = await response.json();

            document.getElementById("last-update").textContent =
                new Date(data.updated).toLocaleString();

            // GDP
            if(data.gdp && Array.isArray(data.gdp) && data.gdp.length > 0) {
                const latest = data.gdp[data.gdp.length - 1];
                const gdpChange = calcChange(data.gdp);
                document.getElementById("gdp").innerHTML =
                    `<div class="value">$${Number(latest.value).toLocaleString()}B</div>
                     <div class="period">${formatDate(latest.date)}</div>${formatChangeIndicator(gdpChange)}`;
                createChart('chart-gdp',
                    data.gdp.map(d => formatDate(d.date)),
                    data.gdp.map(d => d.value),
                    '#2ecc71',
                    { prefix: '$', suffix: 'B', decimals: 0 }
                );
            }

            // Consumer Confidence
            if(data.consumer_confidence && data.consumer_confidence.length > 0) {
                const cc = data.consumer_confidence[data.consumer_confidence.length - 1];
                const ccChange = calcChange(data.consumer_confidence);
                document.getElementById("consumer-confidence").innerHTML =
                    `<div class="value">${Number(cc.value).toFixed(1)}</div>
                     <div class="period">${formatDate(cc.date)}</div>${formatChangeIndicator(ccChange)}`;
                createChart('chart-cc',
                    data.consumer_confidence.map(d => formatDate(d.date)),
                    data.consumer_confidence.map(d => d.value),
                    '#3498db',
                    { decimals: 1 }
                );
            }

            // S&P 500
            if(data.markets) {
                const sp = data.markets.find(m => m.symbol === "SPY");
                if (sp) {
                    const currentClose = sp.current_close || sp.close;
                    const currentDate = sp.current_date || sp.date;
                    const spData = sp.history ? sp.history.map(h => ({value: h.close, date: h.date})) : [];
                    const spChange = calcChange(spData);
                    document.getElementById("sp500").innerHTML =
                        `<div class="value positive">${Number(currentClose).toLocaleString(undefined, {minimumFractionDigits: 2})}</div>
                         <div class="period">${formatDate(currentDate)}</div>${formatChangeIndicator(spChange)}`;
                    if (sp.history && sp.history.length > 0) {
                        createChart('chart-spy',
                            sp.history.map(d => formatShortDate(d.date)),
                            sp.history.map(d => d.close),
                            '#27ae60',
                            { decimals: 2 }
                        );
                    }
                }
            }

            // CPI
            if(data.cpi && Array.isArray(data.cpi) && data.cpi.length > 0) {
                const latestCpi = data.cpi[data.cpi.length - 1];
                const cpiChange = calcChange(data.cpi);
                document.getElementById("cpi").innerHTML =
                    `<div class="value">${Number(latestCpi.value).toFixed(1)}</div>
                     <div class="period">${formatDate(latestCpi.date)}</div>${formatChangeIndicator(cpiChange)}`;
                createChart('chart-cpi',
                    data.cpi.map(d => formatDate(d.date)),
                    data.cpi.map(d => d.value),
                    '#9b59b6',
                    { decimals: 1 }
                );
            }

            // Fed Rate (daily - show YoY + 30-day momentum)
            if(data.fed_funds_rate && Array.isArray(data.fed_funds_rate) && data.fed_funds_rate.length > 0) {
                const latestFed = data.fed_funds_rate[data.fed_funds_rate.length - 1];
                const fedChange = calcChange(data.fed_funds_rate, true);
                const fedMomentum = calc30DayMomentum(data.fed_funds_rate, true);
                document.getElementById("fed-rate").innerHTML =
                    `<div class="value neutral">${Number(latestFed.value).toFixed(2)}%</div>
                     <div class="period">${formatShortDate(latestFed.date)}</div>${formatChangeIndicator(fedChange, fedMomentum)}`;
                createChart('chart-fed',
                    data.fed_funds_rate.map(d => formatShortDate(d.date)),
                    data.fed_funds_rate.map(d => d.value),
                    '#e74c3c',
                    { suffix: '%', decimals: 2 }
                );
            }

            // Unemployment (invert colors - up is bad)
            if(data.unemployment && Array.isArray(data.unemployment) && data.unemployment.length > 0) {
                const latestUnemp = data.unemployment[data.unemployment.length - 1];
                const unempChange = calcChange(data.unemployment, true);
                document.getElementById("unemployment").innerHTML =
                    `<div class="value">${Number(latestUnemp.value).toFixed(1)}%</div>
                     <div class="period">${formatDate(latestUnemp.date)}</div>${formatChangeIndicator(unempChange, null, true)}`;
                createChart('chart-unemp',
                    data.unemployment.map(d => formatDate(d.date)),
                    data.unemployment.map(d => d.value),
                    '#f39c12',
                    { suffix: '%', decimals: 1 }
                );
            }

            // Employment
            if(data.employment && Array.isArray(data.employment) && data.employment.length > 0) {
                const latestEmp = data.employment[data.employment.length - 1];
                const empChange = calcChange(data.employment);
                document.getElementById("employment").innerHTML =
                    `<div class="value">${Number(latestEmp.value).toLocaleString()}</div>
                     <div class="period">${formatDate(latestEmp.date)}</div>${formatChangeIndicator(empChange)}`;
                createChart('chart-emp',
                    data.employment.map(d => formatDate(d.date)),
                    data.employment.map(d => d.value),
                    '#1abc9c',
                    { suffix: 'K', decimals: 0 }
                );
            }

            // Wages
            if(data.wages && Array.isArray(data.wages) && data.wages.length > 0) {
                const latestWages = data.wages[data.wages.length - 1];
                const wagesChange = calcChange(data.wages);
                document.getElementById("wages").innerHTML =
                    `<div class="value">$${Number(latestWages.value).toFixed(2)}</div>
                     <div class="period">${formatDate(latestWages.date)}</div>${formatChangeIndicator(wagesChange)}`;
                createChart('chart-wages',
                    data.wages.map(d => formatDate(d.date)),
                    data.wages.map(d => d.value),
                    '#16a085',
                    { prefix: '$', decimals: 2 }
                );
            }

            // Housing Starts
            if(data.housing_starts && Array.isArray(data.housing_starts) && data.housing_starts.length > 0) {
                const latestHousing = data.housing_starts[data.housing_starts.length - 1];
                const housingChange = calcChange(data.housing_starts);
                document.getElementById("housing").innerHTML =
                    `<div class="value">${Number(latestHousing.value).toLocaleString()}</div>
                     <div class="period">${formatDate(latestHousing.date)}</div>${formatChangeIndicator(housingChange)}`;
                createChart('chart-housing',
                    data.housing_starts.map(d => formatDate(d.date)),
                    data.housing_starts.map(d => d.value),
                    '#8e44ad',
                    { suffix: 'K', decimals: 0 }
                );
            }

            // News Sentiment Index (from SF Fed - daily updates)
            if(data.news_sentiment && Array.isArray(data.news_sentiment) && data.news_sentiment.length > 0) {
                const latestSentiment = data.news_sentiment[data.news_sentiment.length - 1];
                const sentimentValue = Number(latestSentiment.value);
                const weeklyChange = calcWeeklyChange(data.news_sentiment);

                // Color based on current zone
                let sentimentColor = 'neutral';
                if (sentimentValue > 0.05) sentimentColor = 'positive';
                else if (sentimentValue < -0.05) sentimentColor = 'negative';

                const sentimentSign = sentimentValue >= 0 ? '+' : '';
                document.getElementById("news-sentiment").innerHTML =
                    `<div class="value ${sentimentColor}">${sentimentSign}${sentimentValue.toFixed(3)}</div>
                     <div class="period">${formatShortDate(latestSentiment.date)} (SF Fed Daily News Sentiment)</div>
                     ${formatSentimentChange(weeklyChange)}`;

                // Use the special sentiment chart with colored bands
                createSentimentChart('chart-sentiment',
                    data.news_sentiment.map(d => formatShortDate(d.date)),
                    data.news_sentiment.map(d => d.value)
                );
            }

            // 10-Year Treasury Yield (daily - show YoY + 30-day momentum)
            if(data.treasury_10y && Array.isArray(data.treasury_10y) && data.treasury_10y.length > 0) {
                const latestTreasury = data.treasury_10y[data.treasury_10y.length - 1];
                const treasuryChange = calcChange(data.treasury_10y, true);
                const treasuryMomentum = calc30DayMomentum(data.treasury_10y, true);
                document.getElementById("treasury").innerHTML =
                    `<div class="value neutral">${Number(latestTreasury.value).toFixed(2)}%</div>
                     <div class="period">${formatShortDate(latestTreasury.date)}</div>${formatChangeIndicator(treasuryChange, treasuryMomentum)}`;
                createChart('chart-treasury',
                    data.treasury_10y.map(d => formatShortDate(d.date)),
                    data.treasury_10y.map(d => d.value),
                    '#c0392b',
                    { suffix: '%', decimals: 2 }
                );
            }

            // VIX Volatility Index (daily - show YoY + 30-day momentum)
            if(data.vix && Array.isArray(data.vix) && data.vix.length > 0) {
                const latestVix = data.vix[data.vix.length - 1];
                const vixChange = calcChange(data.vix, true);
                const vixMomentum = calc30DayMomentum(data.vix, true);
                // VIX color: green when low (calm), red when high (fear)
                const vixValue = Number(latestVix.value);
                const vixColor = vixValue < 20 ? 'positive' : vixValue < 30 ? 'neutral' : 'negative';
                document.getElementById("vix").innerHTML =
                    `<div class="value ${vixColor}">${vixValue.toFixed(2)}</div>
                     <div class="period">${formatShortDate(latestVix.date)} (CBOE Fear Gauge)</div>${formatChangeIndicator(vixChange, vixMomentum, true)}`;
                createChart('chart-vix',
                    data.vix.map(d => formatShortDate(d.date)),
                    data.vix.map(d => d.value),
                    '#9b59b6',
                    { decimals: 2 }
                );
            }

            // USD/CAD (daily - show YoY + 30-day momentum)
            if(data.usd_cad && Array.isArray(data.usd_cad) && data.usd_cad.length > 0) {
                const latest = data.usd_cad[data.usd_cad.length - 1];
                const cadChange = calcChange(data.usd_cad);
                const cadMomentum = calc30DayMomentum(data.usd_cad);
                document.getElementById("usd-cad").innerHTML =
                    `<div class="value">${Number(latest.value).toFixed(4)}</div>
                     <div class="period">${formatShortDate(latest.date)} (CAD per USD)</div>${formatChangeIndicator(cadChange, cadMomentum)}`;
                createChart('chart-cad',
                    data.usd_cad.map(d => formatShortDate(d.date)),
                    data.usd_cad.map(d => d.value),
                    '#e74c3c',
                    { decimals: 4 }
                );
            }

            // USD/EUR (daily - show YoY + 30-day momentum) - inverted so up = stronger USD
            if(data.usd_eur && Array.isArray(data.usd_eur) && data.usd_eur.length > 0) {
                const latest = data.usd_eur[data.usd_eur.length - 1];
                const eurChange = calcChange(data.usd_eur);
                const eurMomentum = calc30DayMomentum(data.usd_eur);
                document.getElementById("usd-eur").innerHTML =
                    `<div class="value">${Number(latest.value).toFixed(4)}</div>
                     <div class="period">${formatShortDate(latest.date)} (EUR per USD)</div>${formatChangeIndicator(eurChange, eurMomentum)}`;
                createChart('chart-eur',
                    data.usd_eur.map(d => formatShortDate(d.date)),
                    data.usd_eur.map(d => d.value),
                    '#3498db',
                    { decimals: 4 }
                );
            }

            // USD/GBP (daily - inverted so up = stronger USD)
            if(data.usd_gbp && Array.isArray(data.usd_gbp) && data.usd_gbp.length > 0) {
                const latest = data.usd_gbp[data.usd_gbp.length - 1];
                const gbpChange = calcChange(data.usd_gbp);
                const gbpMomentum = calc30DayMomentum(data.usd_gbp);
                document.getElementById("usd-gbp").innerHTML =
                    `<div class="value">${Number(latest.value).toFixed(4)}</div>
                     <div class="period">${formatShortDate(latest.date)} (GBP per USD)</div>${formatChangeIndicator(gbpChange, gbpMomentum)}`;
                createChart('chart-gbp',
                    data.usd_gbp.map(d => formatShortDate(d.date)),
                    data.usd_gbp.map(d => d.value),
                    '#2980b9',
                    { decimals: 4 }
                );
            }

            // USD/JPY (daily - show YoY + 30-day momentum)
            if(data.usd_jpy && Array.isArray(data.usd_jpy) && data.usd_jpy.length > 0) {
                const latest = data.usd_jpy[data.usd_jpy.length - 1];
                const jpyChange = calcChange(data.usd_jpy);
                const jpyMomentum = calc30DayMomentum(data.usd_jpy);
                document.getElementById("usd-jpy").innerHTML =
                    `<div class="value">${Number(latest.value).toFixed(2)}</div>
                     <div class="period">${formatShortDate(latest.date)} (JPY per USD)</div>${formatChangeIndicator(jpyChange, jpyMomentum)}`;
                createChart('chart-jpy',
                    data.usd_jpy.map(d => formatShortDate(d.date)),
                    data.usd_jpy.map(d => d.value),
                    '#9b59b6',
                    { decimals: 2 }
                );
            }

            // USD/MXN (daily - show YoY + 30-day momentum)
            if(data.usd_mxn && Array.isArray(data.usd_mxn) && data.usd_mxn.length > 0) {
                const latest = data.usd_mxn[data.usd_mxn.length - 1];
                const mxnChange = calcChange(data.usd_mxn);
                const mxnMomentum = calc30DayMomentum(data.usd_mxn);
                document.getElementById("usd-mxn").innerHTML =
                    `<div class="value">${Number(latest.value).toFixed(2)}</div>
                     <div class="period">${formatShortDate(latest.date)} (MXN per USD)</div>${formatChangeIndicator(mxnChange, mxnMomentum)}`;
                createChart('chart-mxn',
                    data.usd_mxn.map(d => formatShortDate(d.date)),
                    data.usd_mxn.map(d => d.value),
                    '#27ae60',
                    { decimals: 2 }
                );
            }

            // USD/CNY (daily - Chinese Yuan per USD)
            if(data.usd_cny && Array.isArray(data.usd_cny) && data.usd_cny.length > 0) {
                const latest = data.usd_cny[data.usd_cny.length - 1];
                const cnyChange = calcChange(data.usd_cny);
                const cnyMomentum = calc30DayMomentum(data.usd_cny);
                document.getElementById("usd-cny").innerHTML =
                    `<div class="value">${Number(latest.value).toFixed(4)}</div>
                     <div class="period">${formatShortDate(latest.date)} (CNY per USD)</div>${formatChangeIndicator(cnyChange, cnyMomentum)}`;
                createChart('chart-cny',
                    data.usd_cny.map(d => formatShortDate(d.date)),
                    data.usd_cny.map(d => d.value),
                    '#c0392b',
                    { decimals: 4 }
                );
            }

            // USD/INR (daily - Indian Rupees per USD)
            if(data.usd_inr && Array.isArray(data.usd_inr) && data.usd_inr.length > 0) {
                const latest = data.usd_inr[data.usd_inr.length - 1];
                const inrChange = calcChange(data.usd_inr);
                const inrMomentum = calc30DayMomentum(data.usd_inr);
                document.getElementById("usd-inr").innerHTML =
                    `<div class="value">${Number(latest.value).toFixed(2)}</div>
                     <div class="period">${formatShortDate(latest.date)} (INR per USD)</div>${formatChangeIndicator(inrChange, inrMomentum)}`;
                createChart('chart-inr',
                    data.usd_inr.map(d => formatShortDate(d.date)),
                    data.usd_inr.map(d => d.value),
                    '#d35400',
                    { decimals: 2 }
                );
            }

            // USD/AUD (daily - inverted so up = stronger USD)
            if(data.usd_aud && Array.isArray(data.usd_aud) && data.usd_aud.length > 0) {
                const latest = data.usd_aud[data.usd_aud.length - 1];
                const audChange = calcChange(data.usd_aud);
                const audMomentum = calc30DayMomentum(data.usd_aud);
                document.getElementById("usd-aud").innerHTML =
                    `<div class="value">${Number(latest.value).toFixed(4)}</div>
                     <div class="period">${formatShortDate(latest.date)} (AUD per USD)</div>${formatChangeIndicator(audChange, audMomentum)}`;
                createChart('chart-aud',
                    data.usd_aud.map(d => formatShortDate(d.date)),
                    data.usd_aud.map(d => d.value),
                    '#16a085',
                    { decimals: 4 }
                );
            }

            // COMMODITIES

            // Gold (USD per troy ounce)
            if(data.gold && Array.isArray(data.gold) && data.gold.length > 0) {
                const latest = data.gold[data.gold.length - 1];
                const goldChange = calcChange(data.gold);
                const goldMomentum = calc30DayMomentum(data.gold);
                document.getElementById("gold").innerHTML =
                    `<div class="value">$${Number(latest.value).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                     <div class="period">${formatShortDate(latest.date)}</div>${formatChangeIndicator(goldChange, goldMomentum)}`;
                createChart('chart-gold',
                    data.gold.map(d => formatShortDate(d.date)),
                    data.gold.map(d => d.value),
                    '#f1c40f',
                    { prefix: '$', decimals: 2 }
                );
            }

            // Crude Oil WTI (USD per barrel)
            if(data.crude_oil && Array.isArray(data.crude_oil) && data.crude_oil.length > 0) {
                const latest = data.crude_oil[data.crude_oil.length - 1];
                const oilChange = calcChange(data.crude_oil);
                const oilMomentum = calc30DayMomentum(data.crude_oil);
                document.getElementById("crude-oil").innerHTML =
                    `<div class="value">$${Number(latest.value).toFixed(2)}</div>
                     <div class="period">${formatShortDate(latest.date)}</div>${formatChangeIndicator(oilChange, oilMomentum)}`;
                createChart('chart-oil',
                    data.crude_oil.map(d => formatShortDate(d.date)),
                    data.crude_oil.map(d => d.value),
                    '#2c3e50',
                    { prefix: '$', decimals: 2 }
                );
            }

            // Natural Gas (USD per MMBtu)
            if(data.natural_gas && Array.isArray(data.natural_gas) && data.natural_gas.length > 0) {
                const latest = data.natural_gas[data.natural_gas.length - 1];
                const natgasChange = calcChange(data.natural_gas);
                const natgasMomentum = calc30DayMomentum(data.natural_gas);
                document.getElementById("natural-gas").innerHTML =
                    `<div class="value">$${Number(latest.value).toFixed(2)}</div>
                     <div class="period">${formatShortDate(latest.date)}</div>${formatChangeIndicator(natgasChange, natgasMomentum)}`;
                createChart('chart-natgas',
                    data.natural_gas.map(d => formatShortDate(d.date)),
                    data.natural_gas.map(d => d.value),
                    '#3498db',
                    { prefix: '$', decimals: 2 }
                );
            }

            // Copper (USD per pound - monthly)
            if(data.copper && Array.isArray(data.copper) && data.copper.length > 0) {
                const latest = data.copper[data.copper.length - 1];
                const copperChange = calcChange(data.copper);
                document.getElementById("copper").innerHTML =
                    `<div class="value">$${Number(latest.value).toFixed(2)}</div>
                     <div class="period">${formatDate(latest.date)} (monthly)</div>${formatChangeIndicator(copperChange)}`;
                createChart('chart-copper',
                    data.copper.map(d => formatDate(d.date)),
                    data.copper.map(d => d.value),
                    '#e67e22',
                    { prefix: '$', decimals: 2 }
                );
            }

        } catch (error) {
            console.error("Failed to load dashboard:", error);
            document.getElementById("last-update").textContent = "Error loading data";
        }
    }

    loadDashboard();
    setInterval(loadDashboard, 300000); // Refresh every 5 minutes

    // GA4 Event Tracking for metric link clicks
    document.querySelectorAll('.metric-card h4 a').forEach(link => {
        link.addEventListener('click', function() {
            const metricName = this.textContent.trim();
            gtag('event', 'dashboard_metric_click', {
                'metric_name': metricName,
                'destination_url': this.href
            });
        });
    });
    </script>
</body>
</html>
